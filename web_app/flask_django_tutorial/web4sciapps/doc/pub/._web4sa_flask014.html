<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generator" content="Doconce: http://code.google.com/p/doconce/"/>

    <link rel="stylesheet"
          href="https://raw.githubusercontent.com/hplgit/doconce/master/bundled/html_styles/style_vagrant/css/twitter_bootstrap.css">
    <link rel="stylesheet"
          href="https://raw.githubusercontent.com/hplgit/doconce/master/bundled/html_styles/style_vagrant/css/vagrant.css">
    <!-- Define color of headings here (last definition counts) -->
    <style type="text/css">
h1, h2, h3, h4, h5, h6 {
  color: #000;     /* black */
  color: #999;     /* gray */
  color: #005580;  /* dark blue */
  color: #08c;     /* characteristic blue */

    </style>
</head>
<body>

<title>Using Flask for Scientific Web Applications</title>

<div class="container">
    <div class="row Header with-border">
        <div class="span3 Module logo">
            <h1><a href="/">Flask<span class="subtitle">4scientists</span></a></h1>
        </div>
        <div class="span9">
            <div class="Module navigation">
                <ul>
                    <li><a href="http://flask.pocoo.org/">Flask</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="span3 Module sidebar">
        <div class="well" style="padding: 8px 0px;">
            <ul class="nav nav-list">
                <!-- navigation toc: -->
                <li><a href="._web4sa_flask000.html#___sec0" style="font-size: 80%;">Web frameworks</a></li>
                <!-- navigation toc: -->
                <li><a href="._web4sa_flask004.html#___sec5" style="font-size: 80%;">Making a Flask application</a></li>
                <!-- navigation toc: -->
                <li><a href="._web4sa_flask006.html#wf:vib:flask" style="font-size: 80%;">Handling multiple input
                    variables in Flask</a></li>
                <!-- navigation toc: -->
                <li><a href="._web4sa_flask017.html#___sec56" style="font-size: 80%;">Exercises</a></li>
                <!-- navigation toc: -->
                <li><a href="._web4sa_flask017.html#___sec66" style="font-size: 80%;">Flask resources</a></li>

            </ul>
        </div>
    </div>

    <div class="span9">


        <!-- tocinfo
        {'highest level': 1,
         'sections': [('Web frameworks', 1, None, '___sec0'),
                      ('Other frameworks', 3, None, '___sec1'),
                      ('The MVC pattern', 2, None, '___sec2'),
                      ('A very simple application', 2, None, '___sec3'),
                      ('Application of the MVC pattern', 2, 'wf:hw:mvc', 'wf:hw:mvc'),
                      ('Making a Flask application', 1, None, '___sec5'),
                      ('Programming the Flask application', 2, None, '___sec6'),
                      ('The user interaction', 3, None, '___sec7'),
                      ('The Python code', 3, None, '___sec8'),
                      ('Dissection', 3, None, '___sec9'),
                      ('The template files', 3, None, '___sec10'),
                      ('Testing the application', 3, None, '___sec11'),
                      ('Equipping the input page with output results',
                       2,
                       None,
                       '___sec12'),
                      ('Splitting the app into model, view, and controller files',
                       2,
                       'wf:hw3:flask',
                       'wf:hw3:flask'),
                      ('Troubleshooting', 2, None, '___sec14'),
                      ('Address already in use', 3, None, '___sec15'),
                      ('Handling multiple input variables in Flask',
                       1,
                       'wf:vib:flask',
                       'wf:vib:flask'),
                      ('Programming the Flask application',
                       2,
                       'wf:vib1:flask:app',
                       'wf:vib1:flask:app'),
                      ('The compute part', 3, None, '___sec18'),
                      ('The model', 3, None, '___sec19'),
                      ('The view', 3, None, '___sec20'),
                      ('The HTML template', 3, None, '___sec21'),
                      ('Implementing error checking in the template',
                       2,
                       None,
                       '___sec22'),
                      ('Using style sheets', 2, None, '___sec23'),
                      ('Using LaTeX mathematics', 2, None, '___sec24'),
                      ('Rearranging the elements in the HTML template',
                       2,
                       None,
                       '___sec25'),
                      ('Bootstrap HTML style', 2, None, '___sec26'),
                      ('Custom validation',
                       2,
                       'wf:vib1:flask:validation',
                       'wf:vib1:flask:validation'),
                      ('Using Flask validators', 3, None, '___sec28'),
                      ('Tailored validation', 3, None, '___sec29'),
                      ('Tailored validation of intervals', 3, None, '___sec30'),
                      ('Demo', 3, None, '___sec31'),
                      ('Avoiding plot files',
                       2,
                       'wf:vib2:flask:nofiles',
                       'wf:vib2:flask:nofiles'),
                      ('PNG plots', 3, None, '___sec33'),
                      ('SVG plots', 3, None, '___sec34'),
                      ('Using mpld3', 3, None, '___sec35'),
                      ('Plotting with the Bokeh library',
                       2,
                       'wf:bokeh:flask',
                       'wf:bokeh:flask'),
                      ('Pandas highcharts plotting library', 3, None, '___sec37'),
                      ('Autogenerating the code',
                       2,
                       'wf:autogen:flask',
                       'wf:autogen:flask'),
                      ('Inspecting function signatures', 3, None, '___sec39'),
                      ('Generating the model', 3, None, '___sec40'),
                      ('Generating the view', 3, None, '___sec41'),
                      ('Generating the template', 3, None, '___sec42'),
                      ('Application', 3, None, '___sec43'),
                      ('User login and storage of computed results',
                       2,
                       'wf:flask:login',
                       'wf:flask:login'),
                      ('Required additional software', 3, None, '___sec45'),
                      ('The compute part', 3, None, '___sec46'),
                      ('The interfaces of the app', 3, None, '___sec47'),
                      ('The source code', 3, None, '___sec48'),
                      ('Resources', 3, None, '___sec49'),
                      ('Uploading of files', 2, 'wf:flask:upload', 'wf:flask:upload'),
                      ('Overview of the application', 3, None, '___sec51'),
                      ('The model class', 3, None, '___sec52'),
                      ('The controller file', 3, None, '___sec53'),
                      ('The compute function', 3, None, '___sec54'),
                      ('The HTML template', 3, None, '___sec55'),
                      ('Exercises', 1, None, '___sec56'),
                      ('Exercise 1: Add two numbers',
                       2,
                       'wf:exer:add2',
                       'wf:exer:add2'),
                      ('Exercise 2: Upload data file and visualize curves',
                       2,
                       'wf:exer:upload',
                       'wf:exer:upload'),
                      ('Exercise 3: Plot a user-specified formula',
                       2,
                       'wf:exer:formula',
                       'wf:exer:formula'),
                      ('Exercise 4: Visualize Taylor polynomial approximations',
                       2,
                       'wf:exer:Taylor',
                       'wf:exer:Taylor'),
                      ('Exercise 5: Extend the `gen` app',
                       2,
                       'wf:exer:gen:demo',
                       'wf:exer:gen:demo'),
                      ('Exercise 6: Make a web app with multiple apps',
                       2,
                       'wf:exer:addmul',
                       'wf:exer:addmul'),
                      ('Exercise 7: Equip the `gen` app with more data types',
                       2,
                       'wf:exer:gen:lists',
                       'wf:exer:gen:lists'),
                      ('Exercise 8: Auto-generate code from function signature',
                       2,
                       None,
                       '___sec64'),
                      ('Project 9: Interactive function exploration',
                       2,
                       'wf:exer:bokeh_UI',
                       'wf:exer:bokeh_UI'),
                      ('Flask resources', 1, None, '___sec66')]}
        end of tocinfo -->


        <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});

        </script>
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>


        <a name="part0014"></a>
        <!-- !split -->

        <h2 id="wf:autogen:flask">Autogenerating the code</h2>

        <p>
            We shall now present generic <code>model.py</code> and <code>controller.py</code>
            files that work with <em>any</em> <code>compute</code> function (!). This example will
            demonstrate some advanced, powerful features of Python. The source code
            is found in the <a
                href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen"
                target="_self"><tt>gen</tt></a>
            directory.

        <h3 id="___sec39">Inspecting function signatures </h3>

        <p>
            The basic idea is that the Python module <code>inspect</code> can be used to
            retrieve the names of the arguments and the default values of
            keyword arguments of <em>any</em> given <code>compute</code> function. Say we have some

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">def</span> <span
                style="color: #0000FF">mycompute</span>(A, m<span style="color: #666666">=0</span>, s<span
                style="color: #666666">=1</span>, w<span style="color: #666666">=1</span>, x_range<span
                style="color: #666666">=</span>[<span style="color: #666666">-3</span>,<span
                style="color: #666666">3</span>]):
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">return</span> result
</pre>
        </div>
        <p>
            Running

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
                    style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
                    style="color: #666666">.</span>defaults
</pre>
        </div>
        <p>
            leads to

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
                style="color: #666666">=</span> [<span style="color: #BA2121">&#39;A&#39;</span>, <span
                style="color: #BA2121">&#39;m&#39;</span>, <span style="color: #BA2121">&#39;s&#39;</span>, <span
                style="color: #BA2121">&#39;w&#39;</span>, <span style="color: #BA2121">&#39;x_range&#39;</span>]
defaults <span style="color: #666666">=</span> (<span style="color: #666666">0</span>, <span
                    style="color: #666666">1</span>, <span style="color: #666666">1</span>, [<span
                    style="color: #666666">-3</span>, <span style="color: #666666">3</span>])
</pre>
        </div>
        <p>
            We have all the argument names in <code>arg_names</code> and
            <code>defaults[i]</code> is the default value of keyword argument
            <code>arg_names[j]</code>, where <code>j = len(arg_names) - len(defaults) + i</code>.

        <h3 id="___sec40">Generating the model </h3>

        <p>
            Knowing the name <code>name</code> of some argument in the <code>compute</code>
            function, we can make the corresponding class attribute
            in the <code>InputForm</code> class by

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
        </div>
        <p>
            For name equal to <code>'A'</code> this is the same as hardcoding

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">InputForm</span>:
    A <span style="color: #666666">=</span> FloatForm()
</pre>
        </div>
        <p>
            Assuming that all arguments in <code>compute</code> are floats, we could
            do

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">InputForm</span>:
    <span style="color: #008000; font-weight: bold">pass</span>  <span style="color: #408080; font-style: italic"># Empty class</span>

arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
                    style="color: #666666">.</span>args
<span style="color: #008000; font-weight: bold">for</span> name <span
                    style="color: #AA22FF; font-weight: bold">in</span> arg_names:
    <span style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
        </div>
        <p>
            However, we can do better than this: for
            keyword arguments the type of the default value can be used to
            select the appropriate form class. The complete <code>model.py</code> file
            then goes as follows:

        <p>

            <!-- code=python (!bc pypro) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">Example on generic model.py file which inspects the arguments</span>
<span style="color: #BA2121; font-style: italic">of the compute function and automatically generates a relevant</span>
<span style="color: #BA2121; font-style: italic">InputForm class.</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>

<span style="color: #008000; font-weight: bold">import</span> <span
                    style="color: #0000FF; font-weight: bold">wtforms</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
                    style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">from</span> <span
                    style="color: #0000FF; font-weight: bold">compute</span> <span
                    style="color: #008000; font-weight: bold">import</span> compute_gamma <span
                    style="color: #008000; font-weight: bold">as</span> compute
<span style="color: #008000; font-weight: bold">import</span> <span
                    style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
                    style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
                    style="color: #666666">.</span>defaults

<span style="color: #008000; font-weight: bold">class</span> <span
                    style="color: #0000FF; font-weight: bold">InputForm</span>(wtforms<span
                    style="color: #666666">.</span>Form):
    <span style="color: #008000; font-weight: bold">pass</span>

<span style="color: #408080; font-style: italic"># Augment defaults with None elements for the positional</span>
<span style="color: #408080; font-style: italic"># arguments</span>
defaults <span style="color: #666666">=</span> [<span style="color: #008000">None</span>]<span
                    style="color: #666666">*</span>(<span style="color: #008000">len</span>(arg_names)<span
                    style="color: #666666">-</span><span style="color: #008000">len</span>(defaults)) <span
                    style="color: #666666">+</span> <span style="color: #008000">list</span>(defaults)
<span style="color: #408080; font-style: italic"># Map type of default to right form field</span>
type2form <span style="color: #666666">=</span> {<span style="color: #008000">type</span>(<span style="color: #666666">1.0</span>): wtforms<span
                    style="color: #666666">.</span>FloatField,
             <span style="color: #008000">type</span>(<span style="color: #666666">1</span>):   wtforms<span
                    style="color: #666666">.</span>IntegerField,
             <span style="color: #008000">type</span>(<span style="color: #BA2121">&#39;&#39;</span>):  wtforms<span
                    style="color: #666666">.</span>TextField,
             }

<span style="color: #008000; font-weight: bold">for</span> name, value <span style="color: #AA22FF; font-weight: bold">in</span> <span
                    style="color: #008000">zip</span>(arg_names, defaults):
    <span style="color: #008000; font-weight: bold">if</span> value <span
                    style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
        <span style="color: #008000">setattr</span>(InputForm, name, wtforms<span style="color: #666666">.</span>FloatField(
            validators<span style="color: #666666">=</span>[wtforms<span style="color: #666666">.</span>validators<span
                    style="color: #666666">.</span>InputRequired()]))
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">type</span>(value) <span
                    style="color: #AA22FF; font-weight: bold">in</span> type2form:
            <span style="color: #008000">setattr</span>(InputForm, name, type2form[<span
                    style="color: #008000">type</span>(value)](
                default<span style="color: #666666">=</span>value,
                validators<span style="color: #666666">=</span>[wtforms<span
                    style="color: #666666">.</span>validators<span style="color: #666666">.</span>InputRequired()]))
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span
                    style="color: #D2413A; font-weight: bold">TypeError</span>(<span style="color: #BA2121">&#39;argument </span><span
                    style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> </span><span
                    style="color: #BB6688; font-weight: bold">%s</span><span
                    style="color: #BA2121"> not supported&#39;</span> <span style="color: #666666">%</span>
                            name, <span style="color: #008000">type</span>(value))

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
                    style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">for</span> item <span
                    style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">dir</span>(InputForm):
        <span style="color: #008000; font-weight: bold">if</span> item <span style="color: #AA22FF; font-weight: bold">in</span> arg_names:
            <span style="color: #008000; font-weight: bold">print</span> item, <span
                    style="color: #008000">getattr</span>(InputForm, item)
</pre>
        </div>
        <p>
            (The <code>compute_gamma</code> function imported from <code>compute</code> is the
            only application-specific statement in this code and will be explained later.)

        <h3 id="___sec41">Generating the view </h3>

        <p>
            The call to <code>compute</code> in the <code>controller.py</code> file must also be expressed
            in a general way such that the call handles any type and number of
            parameters. This can be done in two ways, using either positional
            or keyword arguments.

        <p>
            The technique with positional arguments
            is explained first. It consists of collecting all parameters in
            a list or tuple, called <code>args</code>, and then calling <code>compute(*args)</code>
            (which is equivalent to <code>compute(args[0], args[1], ..., args[n])</code>
            if <code>n</code> is <code>len(args)-1</code>). The elements of <code>args</code> are the values of the
            form variables. We know the name of a form variable as a string
            <code>name</code> (from <code>arg_names</code>), and if <code>form</code> is the form object,
            the construction <code>getattr(form, name).data</code> extracts the value
            that the user provided (<code>getattr(obj, attr)</code> gets the attribute, with name
            available as a string in <code>attr</code>, in the object <code>obj</code>).
            For exampe, if <code>name</code> is <code>'A'</code>, <code>getattr(form, name).data</code> is the same as
            <code>form.A.data</code>.
            Collecting all form variables, placing them in a list,
            and calling <code>compute</code> are done with

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
                style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
                style="color: #666666">.</span>args
args <span style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
                    style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
                    style="color: #AA22FF; font-weight: bold">in</span> arg_names]
result <span style="color: #666666">=</span> compute(<span style="color: #666666">*</span>args)
</pre>
        </div>
        <p>
            Our <code>InputForm</code> class guarantees that all arguments in <code>compute</code>
            are present in the form, but to be absolutely safe we can
            test if <code>name</code> is present in the <code>form</code> object:

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">args <span
                style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
                style="color: #666666">.</span>data <span
                style="color: #008000; font-weight: bold">for</span> name <span
                style="color: #AA22FF; font-weight: bold">in</span> arg_names
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)]
</pre>
        </div>
        <p>
            A potential problem with the <code>args</code> list is that the values might
            be in wrong order. It appears, fortunately, that the order we
            assign attributes to the form class is preserved when iterating over
            the form. Nevertheless, using keyword arguments instead of positional
            arguments provides a completely safe solution to calling <code>compute</code>
            with the correct arguments. Keyword arguments are placed in a
            dictionary <code>kwargs</code> and <code>compute</code> is called as <code>compute(**kwargs)</code>.
            The generic solution is

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">kwargs <span
                style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
                style="color: #666666">.</span>data <span
                style="color: #008000; font-weight: bold">for</span> name <span
                style="color: #AA22FF; font-weight: bold">in</span> arg_names
          <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
</pre>
        </div>
        <p>
            The <code>compute(**kwargs)</code> call is equivalent to <code>compute(A=1, b=3, w=0.5)</code>
            in case <code>kwargs = {'w'=0.5, 'A':1, 'b':3}</code> (recall that the order of
            the keys in a Python dictionary is undetermined).

        <h3 id="___sec42">Generating the template </h3>

        <p>
            It remains to generate the right HTML template. The HTML code depends
            on what the returned <code>result</code> object from <code>compute</code> contains. Only a
            human who has read the <code>compute</code> code knows the details of the returned
            result. Therefore, we leave it to a human to provide the part
            of the HTML template that renders the result. The file <code>templates/view_results.html</code> contains
            this human-provided code, while <code>templates/view.html</code>
            is a completely generic template for the forms:

        <p>

            <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">&lt;form</span> <span
                style="color: #7D9029">method=</span><span style="color: #BA2121">post</span> <span
                style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
                style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span
                    style="color: #008000; font-weight: bold">&lt;/td&gt;</span> <span
                    style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field }}<span
                    style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{% if field.errors %}
      <span style="color: #008000; font-weight: bold">&lt;ul</span> <span style="color: #7D9029">class=</span><span
                    style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
      {% for error in field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
                    style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
      {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
    {% endif %}<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
                    style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span
                    style="color: #BA2121">Compute</span><span style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>

{% if result != None %}
{{ result|safe }}
{% endif %}
</pre>
        </div>
        <p>
            At the end of this code, an HTML text <code>result</code> (string) is to be
            inserted. This text is typically generated by calling Flask's
            <code>render_template</code> function, which uses <code>templates/view_results.html</code>
            to turn the return object <code>result</code> from the compute function into the
            desired HTML code:

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">if</span> result:
        result <span style="color: #666666">=</span> render_template(<span style="color: #BA2121">&#39;view_results.html&#39;</span>, result<span
                    style="color: #666666">=</span>result)
        <span style="color: #408080; font-style: italic"># result is now rendered HTML text</span>
    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&#39;view.html&#39;</span>, form<span
                    style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)
</pre>
        </div>
        <p>
        <div class="alert alert-block alert-success alert-text-normal"><b>Notice.</b>
            A perhaps simpler alternative would be to have a generic
            <code>view_forms.html</code> file and a user-specific
            <code>view_results.html</code> and explicitly combining them into a new
            file. This requires file writing by the app, which one normally
            wants to avoid. Especially if the web app gets multiple users,
            the file writing may lead to corrupt files.
        </div>


        <p>
            The complete, generic form of the <code>index</code> function becomes

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
                    style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
                    style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        arg_names <span style="color: #666666">=</span> inspect<span
                    style="color: #666666">.</span>getargspec(compute)<span style="color: #666666">.</span>args
        kwargs <span style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
                    style="color: #666666">.</span>data
                  <span style="color: #008000; font-weight: bold">for</span> name <span
                    style="color: #AA22FF; font-weight: bold">in</span> arg_names <span
                    style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
        result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
    <span style="color: #008000; font-weight: bold">if</span> result:
        <span style="color: #408080; font-style: italic"># result must be transformed to HTML and inserted as a</span>
        <span style="color: #408080; font-style: italic"># string in the generic view.html file</span>
        result <span style="color: #666666">=</span> render_template(<span style="color: #BA2121">&#39;view_results.html&#39;</span>, result<span
                    style="color: #666666">=</span>result)
    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&#39;view.html&#39;</span>, form<span
                    style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
                    style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
        </div>

        <h3 id="___sec43">Application </h3>

        <p>
            Let us apply the files above to plot the gamma probability density function

            $$ g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
            e^{-\left(\frac{x}{A}\right)^h},
            $$

            and its cumulative density

            $$ G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,$$

            computed by numerically the Trapezoidal rule, for instance.
            We also want to compute and display
            the mean value \( A\Gamma(a + 1/h)/\Gamma(a) \) and
            standard deviation

            $$ \sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - \Gamma(a+1/h)^2}.$$

            Here, \( \Gamma(a) \) is the gamma function, which can be computed
            by <code>math.gamma(a)</code> in Python.
            Below is a <code>compute.py</code> file with the
            relevant implementations of \( g(x;a,h,A) \) (<code>gamma_density</code>),
            \( G(x; a, h, A) \) (<code>gamma_cumulative</code>), and a function <code>compute_gamma</code> for
            making a plot of \( g \) og \( G \) for \( x\in [0,7\sigma] \).

        <p>

            <!-- code=python (!bc pycod) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_density</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    xA <span style="color: #666666">=</span> x<span style="color: #666666">/</span><span
                    style="color: #008000">float</span>(A)
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">abs</span>(h)<span
                    style="color: #666666">/</span>(math<span style="color: #666666">.</span>gamma(a)<span
                    style="color: #666666">*</span>A)<span style="color: #666666">*</span>(xA)<span
                    style="color: #666666">**</span>(a<span style="color: #666666">*</span>h<span
                    style="color: #666666">-1</span>)<span style="color: #666666">*</span>exp(<span
                    style="color: #666666">-</span>xA<span style="color: #666666">**</span>h)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_cumulative</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span style="color: #408080; font-style: italic"># Assume x is array.</span>
    g <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    r <span style="color: #666666">=</span> zeros_like(x)
    <span style="color: #008000; font-weight: bold">for</span> i <span
                    style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span
                    style="color: #008000">len</span>(r)<span style="color: #666666">-1</span>):
        r[i<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> r[i] <span
                    style="color: #666666">+</span> <span style="color: #666666">0.5*</span>(g[i] <span
                    style="color: #666666">+</span> g[i<span style="color: #666666">+1</span>])<span
                    style="color: #666666">*</span>(x[i<span style="color: #666666">+1</span>] <span
                    style="color: #666666">-</span> x[i])
    <span style="color: #008000; font-weight: bold">return</span> r

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute_gamma</span>(a<span
                    style="color: #666666">=0.5</span>, h<span style="color: #666666">=2.0</span>, A<span
                    style="color: #666666">=</span>math<span style="color: #666666">.</span>sqrt(<span
                    style="color: #666666">2</span>), resolution<span style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    gah <span style="color: #666666">=</span> math<span style="color: #666666">.</span>gamma(a <span
                    style="color: #666666">+</span> <span style="color: #666666">1./</span>h)
    mean <span style="color: #666666">=</span> A<span style="color: #666666">*</span>gah<span
                    style="color: #666666">/</span>math<span style="color: #666666">.</span>gamma(a)
    stdev <span style="color: #666666">=</span> A<span style="color: #666666">/</span>math<span
                    style="color: #666666">.</span>gamma(a)<span style="color: #666666">*</span>math<span
                    style="color: #666666">.</span>sqrt(
        math<span style="color: #666666">.</span>gamma(a <span style="color: #666666">+</span> <span
                    style="color: #666666">2./</span>h)<span style="color: #666666">*</span>math<span
                    style="color: #666666">.</span>gamma(a) <span style="color: #666666">-</span> gah<span
                    style="color: #666666">**2</span>)
    x <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span
                    style="color: #666666">7*</span>stdev, resolution<span style="color: #666666">+1</span>)
    y <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()  <span style="color: #408080; font-style: italic"># needed to avoid adding curves in plot</span>
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;a=</span><span
                    style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, h=</span><span
                    style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, A=</span><span
                    style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
                    style="color: #666666">%</span> (a, h, A))
    <span style="color: #408080; font-style: italic"># Make Matplotlib write to BytesIO file object and grab</span>
    <span style="color: #408080; font-style: italic"># return the object&#39;s string</span>
    <span style="color: #008000; font-weight: bold">from</span> <span
                    style="color: #0000FF; font-weight: bold">io</span> <span style="color: #008000; font-weight: bold">import</span> BytesIO
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
                    style="color: #BA2121">&#39;png&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)  <span
                    style="color: #408080; font-style: italic"># rewind to beginning of file</span>
    <span style="color: #008000; font-weight: bold">import</span> <span
                    style="color: #0000FF; font-weight: bold">base64</span>
    figdata_density_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figfile<span
                    style="color: #666666">.</span>getvalue())
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
                    style="color: #BA2121">&#39;svg&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_density_svg <span style="color: #666666">=</span> <span
                    style="color: #BA2121">&#39;&lt;svg&#39;</span> <span style="color: #666666">+</span> figfile<span
                    style="color: #666666">.</span>getvalue()<span style="color: #666666">.</span>split(<span
                    style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span style="color: #666666">1</span>]
    figdata_density_svg <span style="color: #666666">=</span> <span style="color: #008000">unicode</span>(figdata_density_svg,<span
                    style="color: #BA2121">&#39;utf-8&#39;</span>)

    y <span style="color: #666666">=</span> gamma_cumulative(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>grid(<span style="color: #008000">True</span>)
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
                    style="color: #BA2121">&#39;png&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_cumulative_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figfile<span
                    style="color: #666666">.</span>getvalue())
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
                    style="color: #BA2121">&#39;svg&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_cumulative_svg <span style="color: #666666">=</span> <span
                    style="color: #BA2121">&#39;&lt;svg&#39;</span> <span style="color: #666666">+</span> figfile<span
                    style="color: #666666">.</span>getvalue()<span style="color: #666666">.</span>split(<span
                    style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span style="color: #666666">1</span>]
    figdata_cumulative_svg <span style="color: #666666">=</span> <span style="color: #008000">unicode</span>(figdata_cumulative_svg,<span
                    style="color: #BA2121">&#39;utf-8&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> figdata_density_png, figdata_cumulative_png, \ 
           figdata_density_svg, figdata_cumulative_svg, \ 
           <span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span
                    style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> mean, <span
                    style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span
                    style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> stdev
</pre>
        </div>
        <p>
            The <code>compute_gamma</code> function returns a tuple of six values.
            We want output as displayed in Figure <a href="#wf:gen:flask:fig:gamma">10</a>.

        <p>
            <center> <!-- figure -->
                <hr class="figure">
                <center>
        <p class="caption">Figure 10: Design of a web page illustrating the gamma probability functions.
        <div id="wf:gen:flask:fig:gamma"></div>
        </p></center>
        <p><img src="fig-web4sa/gen_flask_gamma.png" align="bottom" width=700></p>
        </center>

        <p>
            The design is realized in the file <code>view_results.html</code> shown below.

        <p>

            <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
        <div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
                style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
                    style="color: #BA2121">&quot;data:image/png;base64,{{ result[0] }}&quot;</span> <span
                    style="color: #7D9029">width=</span><span style="color: #BA2121">&quot;400&quot;</span><span
                    style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
                    style="color: #BA2121">&quot;data:image/png;base64,{{ result[1] }}&quot;</span> <span
                    style="color: #7D9029">width=</span><span style="color: #BA2121">&quot;400&quot;</span><span
                    style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ result[2]|safe }}<span
                    style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ result[3]|safe }}<span
                    style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>
Mean value: {{ result[4] }} <span style="color: #008000; font-weight: bold">&lt;br&gt;</span>
Standard deviation value: {{ result[5] }}
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
</pre>
        </div>
        <p>
            To create the web application, we just perform the following steps:

        <ol>
            <li> copy the generic <code>controller.py</code> and <code>model.py</code> files to a new directory</li>
            <li> write the compute function in a file <code>compute.py</code></li>
            <li> edit <code>controller.py</code> and <code>model.py</code> to use the right name of the
                compute function (<code>from compute import name as compute</code>)
            </li>
            <li> add an appropriate <code>templates/view_forms.html</code> file that visualizes
                the returned value <code>results</code> from the compute function
            </li>
        </ol>

        <p>
            <!-- navigation buttons at the bottom of the page -->
        <ul class="pager">
            <li class="previous">
                <a href="._web4sa_flask013.html">&larr; Prev</a>
            </li>
            <li class="next">
                <a href="._web4sa_flask015.html">Next &rarr;</a>
            </li>
        </ul>
        <!-- ------------------- end of main content --------------- -->


    </div>

    <div class="row Footer">
        <div class="span12">
            &copy 2013; Hans Petter Langtangen and Anders E. Johansen.
            Last update: Oct 11, 2015.
        </div>
    </div>
</div>
</body>
</html>

