<!DOCTYPE html>
<!--
Automatically generated HTML file from Doconce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generator" content="Doconce: https://github.com/hplgit/doconce/"/>
    <meta name="description" content="Using Web Frameworks for Scientific Web Applications">
    <meta name="keywords"
          content="web frameworks,MVC pattern,Flask installation,Flask input forms,Flask HTML templates,Flask MVC pattern,Flask troubleshooting,Django installation,Django making a project,Django making an application,Django input forms,Django HTML templates,Flask input forms,Flask error checking,Flask CSS style sheets,Flask LaTeX mathematics,Flask input validation,inline PNG image in HTML,base64 encoding of PNG images,inline SVG figure in HTML,Django input forms,Django input validation">


    <style type="text/css">
    /* bloodish style */

    body {
      font-family: Helvetica, Verdana, Arial, Sans-serif;
      color: #404040;
      background: #ffffff;
    }
    h1 { font-size: 1.8em;  color: #8A0808; }
    h2 { font-size: 1.6em;  color: #8A0808; }
    h3 { font-size: 1.4em;  color: #8A0808; }
    h4 { color: #8A0808; }
    a { color: #8A0808; text-decoration:none; }
    tt { font-family: "Courier New", Courier; }
    
    p { text-indent: 0px; }
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    p.caption { width: 80%; font-style: normal; text-align: left; }
    hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}


    </style>

</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' Web frameworks ', 1, None, '___sec0'),
              (' The MVC pattern ', 2, None, '___sec1'),
              (' A very simple application ', 2, None, '___sec2'),
              (' Application of the MVC pattern ',
               2,
               'wf:hw:mvc',
               'wf:hw:mvc'),
              (' Making a Flask application ', 1, None, '___sec4'),
              (' Programming the Flask application ', 2, None, '___sec5'),
              (' Equipping the input page with output results ',
               2,
               None,
               '___sec6'),
              (' Splitting the app into model, view, and controller files ',
               2,
               'wf:hw3:flask',
               'wf:hw3:flask'),
              (' Troubleshooting ', 2, None, '___sec8'),
              (' Making a Django application ', 1, None, '___sec9'),
              (' Setting up a Django project ', 2, None, '___sec10'),
              (' Setting up a Django application ', 2, None, '___sec11'),
              (' Programming the Django application ', 2, None, '___sec12'),
              (' Equipping the input page with output results ',
               2,
               None,
               '___sec13'),
              (' Handling multiple input variables in Flask ',
               1,
               'wf:vib:flask',
               'wf:vib:flask'),
              (' Programming the Flask application ',
               2,
               'wf:vib1:flask:app',
               'wf:vib1:flask:app'),
              (' Implementing error checking in the template ',
               2,
               None,
               '___sec16'),
              (' Using style sheets ', 2, None, '___sec17'),
              (' Using LaTeX mathematics ', 2, None, '___sec18'),
              (' Rearringing the elements in the HTML template ',
               2,
               None,
               '___sec19'),
              (' User-provided validation ',
               2,
               'wf:vib1:flask:validation',
               'wf:vib1:flask:validation'),
              (' Autogenerating the code ',
               2,
               'wf:vib3:flask:autogen',
               'wf:vib3:flask:autogen'),
              (' Avoiding plot files ',
               2,
               'wf:vib3:flask:nofiles',
               'wf:vib3:flask:nofiles'),
              (' PNG plots ', 3, None, '___sec23'),
              (' SVG plots ', 3, None, '___sec24'),
              (' Further work ', 1, None, '___sec25'),
              (' Handling multiple input variables in Django ',
               1,
               'wf:vib:django',
               'wf:vib:django'),
              (' Programming the Django application ', 2, None, '___sec27'),
              (' User-provided validation ', 2, None, '___sec28'),
              (' Customizing widgets ', 2, None, '___sec29'),
              (' Exercises ', 1, None, '___sec30'),
              (' Exercise 1: Add two numbers ',
               2,
               'wf:exer:add2',
               'wf:exer:add2'),
              (' Exercise 2: Extend the `vib3_flask` app ',
               2,
               'wf:exer:vib3:demo',
               'wf:exer:vib3:demo'),
              (' Exercise 3: Equip the `vib3_flask` app with more data types ',
               2,
               'wf:exer:vib3:lists',
               'wf:exer:vib3:lists'),
              (' Exercise 4: Auto-generate code from function signature ',
               2,
               None,
               '___sec34'),
              (' Resources ', 1, None, '___sec35'),
              (' Flask resources ', 2, None, '___sec36'),
              (' Django resources ', 2, None, '___sec37'),
              (' Remaining ', 1, None, '___sec38')]}
end of tocinfo -->

<body>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
  }
});

</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- Fix slow MathJax rendering in IE8 -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">


<a name="part0012"></a>
<!-- begin top navigation -->
<a href="._part0011_web4sa_plain.html"><img src="http://hplgit.github.io/doconce/bundled/html_images/prev1.png" border=0
                                            alt="previous"></a>

<a href="._part0013_web4sa_plain.html"><img src="http://hplgit.github.io/doconce/bundled/html_images/next1.png" border=0
                                            alt="next"></a>
<!-- end top navigation -->

<p>
    <!-- !split -->

<h3>Autogenerating the code <a name="wf:vib3:flask:autogen"></a></h3>

<p>
    We shall now present generic <code>model.py</code> and <code>controller.py</code>
    files that work with <em>any</em> <code>compute</code> function (!). This example will
    demonstrate some advanced, powerful features of Python. The source code
    is found in the <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib3"
        target="_self"><tt>vib3</tt></a>
    directory.

<p>
    <b>Inspecting function signatures.</b>
    The basic idea is that the Python module <code>inspect</code> can be used to
    retrieve the names of the arguments and the default values of
    keyword arguments of <em>any</em> given <code>compute</code> function. Say we have some

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">mycompute</span>(A, m<span
        style="color: #666666">=0</span>, s<span style="color: #666666">=1</span>, w<span
        style="color: #666666">=1</span>, x_range<span style="color: #666666">=</span>[<span
        style="color: #666666">-3</span>,<span style="color: #666666">3</span>]):
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">return</span> result
</pre>
</div>
<p>
    Running

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>defaults
</pre>
</div>
<p>
    leads to

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
        style="color: #666666">=</span> [<span style="color: #BA2121">&#39;A&#39;</span>, <span style="color: #BA2121">&#39;m&#39;</span>, <span
        style="color: #BA2121">&#39;s&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>, <span
        style="color: #BA2121">&#39;x_range&#39;</span>]
defaults <span style="color: #666666">=</span> (<span style="color: #666666">0</span>, <span
            style="color: #666666">1</span>, <span style="color: #666666">1</span>, [<span
            style="color: #666666">-3</span>, <span style="color: #666666">3</span>])
</pre>
</div>
<p>
    We have all the argument names in <code>arg_names</code> and
    <code>defaults[i]</code> is the default value of keyword argument
    <code>arg_names[j]</code>, where <code>j = len(arg_names) - len(defaults) + i</code>.

<p>
    <b>Generating the model.</b>
    Knowing the name <code>name</code> of some argument in the <code>compute</code>
    function, we can make the corresponding class attribute
    in the <code>InputForm</code> class by

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
</div>
<p>
    For name equal to <code>'A'</code> this is the same as hardcoding

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>:
    A <span style="color: #666666">=</span> FloatForm()
</pre>
</div>
<p>
    Assuming that all arguments in <code>compute</code> are floats, we could
    do

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>:
    <span style="color: #008000; font-weight: bold">pass</span>  <span style="color: #408080; font-style: italic"># Empty class</span>

arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>args
<span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names:
    <span style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
</div>
<p>
    However, we can do better than this: for
    keyword arguments the type of the default value can be used to
    select the appropriate form class. The complete <code>model.py</code> file
    then goes as follows:

<p>

    <!-- code=python (from !bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">Example on generic model.py file which inspects the arguments</span>
<span style="color: #BA2121; font-style: italic">of the compute function and automatically generates a relevant</span>
<span style="color: #BA2121; font-style: italic">InputForm class.</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>

<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">wtforms</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
            style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute_gamma <span
            style="color: #008000; font-weight: bold">as</span> compute
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
            style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
            style="color: #666666">.</span>defaults

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(wtforms<span style="color: #666666">.</span>Form):
    <span style="color: #008000; font-weight: bold">pass</span>

<span style="color: #408080; font-style: italic"># Augment defaults with None elements for the positional</span>
<span style="color: #408080; font-style: italic"># arguments</span>
defaults <span style="color: #666666">=</span> [<span style="color: #008000">None</span>]<span
            style="color: #666666">*</span>(<span style="color: #008000">len</span>(arg_names)<span
            style="color: #666666">-</span><span style="color: #008000">len</span>(defaults)) <span
            style="color: #666666">+</span> <span style="color: #008000">list</span>(defaults)
<span style="color: #408080; font-style: italic"># Map type of default to right form field</span>
type2form <span style="color: #666666">=</span> {<span style="color: #008000">type</span>(<span style="color: #666666">1.0</span>): wtforms<span
            style="color: #666666">.</span>FloatField,
             <span style="color: #008000">type</span>(<span style="color: #666666">1</span>):   wtforms<span
            style="color: #666666">.</span>IntegerField,
             <span style="color: #008000">type</span>(<span style="color: #BA2121">&#39;&#39;</span>):  wtforms<span
            style="color: #666666">.</span>TextField,
             }

<span style="color: #008000; font-weight: bold">for</span> name, value <span style="color: #AA22FF; font-weight: bold">in</span> <span
            style="color: #008000">zip</span>(arg_names, defaults):
    <span style="color: #008000; font-weight: bold">if</span> value <span
            style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
        <span style="color: #008000">setattr</span>(InputForm, name, wtforms<span style="color: #666666">.</span>FloatField(
            validators<span style="color: #666666">=</span>[wtforms<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()]))
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">type</span>(value) <span
            style="color: #AA22FF; font-weight: bold">in</span> type2form:
            <span style="color: #008000">setattr</span>(InputForm, name, type2form[<span
            style="color: #008000">type</span>(value)](
                default<span style="color: #666666">=</span>value,
                validators<span style="color: #666666">=</span>[wtforms<span
            style="color: #666666">.</span>validators<span style="color: #666666">.</span>InputRequired()]))
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span
            style="color: #D2413A; font-weight: bold">TypeError</span>(<span
            style="color: #BA2121">&#39;argument </span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> not supported&#39;</span> <span style="color: #666666">%</span>
                            name, <span style="color: #008000">type</span>(value))

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">for</span> item <span
            style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">dir</span>(InputForm):
        <span style="color: #008000; font-weight: bold">if</span> item <span style="color: #AA22FF; font-weight: bold">in</span> arg_names:
            <span style="color: #008000; font-weight: bold">print</span> item, <span
            style="color: #008000">getattr</span>(InputForm, item)
</pre>
</div>
<p>
    (The <code>compute_gamma</code> function imported from <code>compute</code> is the
    only application-specific statement in this code and will be explained later.)

<p>
    <b>Generating the view.</b>
    The call to <code>compute</code> in the <code>controller.py</code> file must also be expressed
    in a general way such that the call handles any type and number of
    parameters. This can be done in two ways, using either positional
    or keyword arguments.

<p>
    The technique with positional arguments
    is explained first. It consists of collecting all parameters in
    a list or tuple, called <code>args</code>, and then calling <code>compute(*args)</code>
    (which is equivalent to <code>compute(args[0], args[1], ..., args[n])</code>
    if <code>n</code> is <code>len(args)-1</code>). The elements of <code>args</code> are the values of the
    form variables. We know the name of a form variable as a string
    <code>name</code> (from <code>arg_names</code>), and if <code>form</code> is the form object,
    the construction <code>getattr(form, name).data</code> extracts the value
    that the user provided (<code>getattr(obj, attr)</code> gets the attribute, with name
    available as a string in <code>attr</code>, in the object <code>obj</code>).
    For exampe, if <code>name</code> is <code>'A'</code>, <code>getattr(form, name).data</code> is the same as
    <code>form.A.data</code>.
    Collecting all form variables, placing them in a list,
    and calling <code>compute</code> are done with

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
        style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
        style="color: #666666">.</span>args
args <span style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
            style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names]
result <span style="color: #666666">=</span> compute(<span style="color: #666666">*</span>args)
</pre>
</div>
<p>
    Our <code>InputForm</code> class guarantees that all arguments in <code>compute</code>
    are present in the form, but to be absolutely safe we can
    test if <code>name</code> is present in the <code>form</code> object:

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">args <span
        style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
        style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
        style="color: #AA22FF; font-weight: bold">in</span> arg_names
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)]
</pre>
</div>
<p>
    A potential problem with the <code>args</code> list is that the values might
    be in wrong order. It appears, fortunately, that the order we
    assign attributes to the form class is preserved when iterating over
    the form. Nevertheless, using keyword arguments instead of positional
    arguments provides a completely safe solution to calling <code>compute</code>
    with the correct arguments. Keyword arguments are placed in a
    dictionary <code>kwargs</code> and <code>compute</code> is called as <code>compute(**kwargs)</code>.
    The generic solution is

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">kwargs <span
        style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
        style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
        style="color: #AA22FF; font-weight: bold">in</span> arg_names
          <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
</pre>
</div>
<p>
    The <code>compute(**kwargs)</code> call is equivalent to <code>compute(A=1, b=3, w=0.5)</code>
    in case <code>kwargs = {'w'=0.5, 'A':1, 'b':3}</code> (recall that the order of
    the keys in a Python dictionary is undetermined).

<p>
    <b>Generating the template.</b>
    It remains to generate the right HTML template. The HTML code depends
    on what the returned <code>result</code> object from <code>compute</code> contains. Only a
    human who has the read <code>compute</code> code knows the details of the returned
    result. Therefore, we leave it to a human to provide the part
    of the HTML template that renders the result. The file <code>templates/view_results.html</code> contains this
    human-provided code, while <code>templates/view_forms.html</code>
    is a completely generic template for the forms:

<p>

    <!-- code=html (from !bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span> <span
            style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{% if field.errors %}
      <span style="color: #008000; font-weight: bold">&lt;ul</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
      {% for error in field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
      {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
    {% endif %}<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Compute</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>
</pre>
</div>
<p>
    A somewhat generic solution for rendering the results can be
    provided by default. In the file <code>templates/view_results_default.html</code> we
    offer a code that checks if <code>results</code> is a string ending in <code>'.png'</code>
    or other typical file extensions for HTML images, and then writes out
    the code for an image, and otherwise a string version of the <code>results</code>
    object is dumped to the web page:

<p>

    <!-- code=python (from !bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #666666">&lt;</span>p<span style="color: #666666">&gt;</span>
{<span style="color: #666666">%</span> <span style="color: #008000; font-weight: bold">if</span> result <span
            style="color: #666666">!=</span> <span style="color: #008000">None</span> <span
            style="color: #666666">%</span>}
  {<span style="color: #666666">%</span> <span style="color: #008000; font-weight: bold">if</span> <span
            style="color: #008000">type</span>(result) <span style="color: #666666">==</span> <span
            style="color: #008000">type</span>(<span style="color: #BA2121">&quot;&quot;</span>) <span
            style="color: #AA22FF; font-weight: bold">and</span>
        result[:<span style="color: #666666">-4</span>] <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;.png&#39;</span> <span style="color: #AA22FF; font-weight: bold">or</span>  result[:<span
            style="color: #666666">-4</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;.gif&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">or</span>
        result[:<span style="color: #666666">-4</span>] <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;.jpg&#39;</span> <span style="color: #666666">%</span>}
<span style="color: #666666">&lt;</span>img src<span style="color: #666666">=</span><span style="color: #BA2121">&quot;{{ result }}&quot;</span><span
            style="color: #666666">&gt;</span>
  {<span style="color: #666666">%</span> <span style="color: #008000; font-weight: bold">else</span> <span
            style="color: #666666">%</span>}
{{ <span style="color: #008000">str</span>(result) }}
  {<span style="color: #666666">%</span> endif <span style="color: #666666">%</span>}
{<span style="color: #666666">%</span> endif <span style="color: #666666">%</span>}
<span style="color: #666666">&lt;/</span>p<span style="color: #666666">&gt;</span>
</pre>
</div>
<p>
    The <code>index</code> function must combine the two pieces of templates.
    The complete, generic form of this function is then

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        arg_names <span style="color: #666666">=</span> inspect<span
            style="color: #666666">.</span>getargspec(compute)<span style="color: #666666">.</span>args
        kwargs <span style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
            style="color: #666666">.</span>data
                  <span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names <span
            style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
        result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
    <span style="color: #408080; font-style: italic"># Concatenate view_forms.html and view_results.html</span>
    forms_html   <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;templates&#39;</span>, <span
            style="color: #BA2121">&#39;view_forms.html&#39;</span>)
    results_html <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;templates&#39;</span>, <span
            style="color: #BA2121">&#39;view_results.html&#39;</span>)
    view_html    <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;templates&#39;</span>, <span
            style="color: #BA2121">&#39;view.html&#39;</span>)
    f_forms <span style="color: #666666">=</span> <span style="color: #008000">open</span>(forms_html, <span
            style="color: #BA2121">&#39;r&#39;</span>)
    f_res   <span style="color: #666666">=</span> <span style="color: #008000">open</span>(results_html, <span
            style="color: #BA2121">&#39;r&#39;</span>)
    f_view  <span style="color: #666666">=</span> <span style="color: #008000">open</span>(view_html, <span
            style="color: #BA2121">&#39;w&#39;</span>)
    f_view<span style="color: #666666">.</span>write(f_forms<span style="color: #666666">.</span>read() <span
            style="color: #666666">+</span> f_res<span style="color: #666666">.</span>read())
    f_forms<span style="color: #666666">.</span>close();  f_res<span
            style="color: #666666">.</span>close();  f_view<span style="color: #666666">.</span>close()
    <span style="color: #008000; font-weight: bold">return</span> render_template(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>basename(view_html),
                           form<span style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>
<p>
    <b>Application.</b>
    Let us apply the files above to plot the gamma probability density function

<p>
    $$ g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
    e^{-\left(\frac{x}{A}\right)^h},
    $$

    and its cumulative density

<p>
    $$ G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,$$

    computed by numerically the Trapezoidal rule, for instance.
    We also want to compute and display
    the mean value \( A\Gamma(a + 1/h)/\Gamma(a) \) and
    standard deviation

<p>
    $$ \sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - \Gamma(a+1/h)^2}.$$

    Here, \( \Gamma(a) \) is the gamma function, which can be computed
    by <code>math.gamma(a)</code> in Python.
    Below is a <code>compute.py</code> file with the
    relevant implementations of \( g(x;a,h,A) \) (<code>gamma_density</code>),
    \( G(x; a, h, A) \) (<code>gamma_cumulative</code>), and a function <code>compute_gamma</code> for
    making a plot of \( g \) og \( G \) for \( x\in [0,7\sigma] \).

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_density</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    xA <span style="color: #666666">=</span> x<span style="color: #666666">/</span><span
            style="color: #008000">float</span>(A)
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">abs</span>(h)<span
            style="color: #666666">/</span>(math<span style="color: #666666">.</span>gamma(a)<span
            style="color: #666666">*</span>A)<span style="color: #666666">*</span>(xA)<span
            style="color: #666666">**</span>(a<span style="color: #666666">*</span>h<span
            style="color: #666666">-1</span>)<span style="color: #666666">*</span>exp(<span
            style="color: #666666">-</span>xA<span style="color: #666666">**</span>h)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_cumulative</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span style="color: #408080; font-style: italic"># Assume x is array.</span>
    g <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    r <span style="color: #666666">=</span> zeros_like(x)
    <span style="color: #008000; font-weight: bold">for</span> i <span
            style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span
            style="color: #008000">len</span>(r)<span style="color: #666666">-1</span>):
        r[i<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> r[i] <span
            style="color: #666666">+</span> <span style="color: #666666">0.5*</span>(g[i] <span
            style="color: #666666">+</span> g[i<span style="color: #666666">+1</span>])<span
            style="color: #666666">*</span>(x[i<span style="color: #666666">+1</span>] <span
            style="color: #666666">-</span> x[i])
    <span style="color: #008000; font-weight: bold">return</span> r

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute_gamma</span>(a<span
            style="color: #666666">=0.5</span>, h<span style="color: #666666">=2.0</span>, A<span
            style="color: #666666">=</span>math<span style="color: #666666">.</span>sqrt(<span
            style="color: #666666">2</span>), resolution<span style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    gah <span style="color: #666666">=</span> math<span style="color: #666666">.</span>gamma(a <span
            style="color: #666666">+</span> <span style="color: #666666">1./</span>h)
    mean <span style="color: #666666">=</span> A<span style="color: #666666">*</span>gah<span
            style="color: #666666">/</span>math<span style="color: #666666">.</span>gamma(a)
    stdev <span style="color: #666666">=</span> A<span style="color: #666666">/</span>math<span
            style="color: #666666">.</span>gamma(a)<span style="color: #666666">*</span>math<span
            style="color: #666666">.</span>sqrt(
        math<span style="color: #666666">.</span>gamma(a <span style="color: #666666">+</span> <span
            style="color: #666666">2./</span>h)<span style="color: #666666">*</span>math<span
            style="color: #666666">.</span>gamma(a) <span style="color: #666666">-</span> gah<span
            style="color: #666666">**2</span>)
    x <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span
            style="color: #666666">7*</span>stdev, resolution<span style="color: #666666">+1</span>)
    y <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()  <span style="color: #408080; font-style: italic"># needed to avoid adding curves in plot</span>
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;a=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, h=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, A=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (a, h, A))
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>isdir(<span style="color: #BA2121">&#39;static&#39;</span>):
        os<span style="color: #666666">.</span>mkdir(<span style="color: #BA2121">&#39;static&#39;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Remove old plot files</span>
        <span style="color: #008000; font-weight: bold">for</span> filename <span
            style="color: #AA22FF; font-weight: bold">in</span> glob<span style="color: #666666">.</span>glob(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #BA2121">&#39;*.png&#39;</span>)):
            os<span style="color: #666666">.</span>remove(filename)
    <span style="color: #408080; font-style: italic"># Use time since Jan 1, 1970 in filename in order make</span>
    <span style="color: #408080; font-style: italic"># a unique filename that the browser has not chached</span>
    t <span style="color: #666666">=</span> <span style="color: #008000">str</span>(time<span
            style="color: #666666">.</span>time())
    plotfile1 <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #BA2121">&#39;density_</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> t)
    plotfile2 <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #BA2121">&#39;cumulative_</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> t)
    plt<span style="color: #666666">.</span>savefig(plotfile1)
    y <span style="color: #666666">=</span> gamma_cumulative(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>grid(<span style="color: #008000">True</span>)
    plt<span style="color: #666666">.</span>savefig(plotfile2)
    <span style="color: #008000; font-weight: bold">return</span> plotfile1, plotfile2, mean, stdev
</pre>
</div>
<p>
    The <code>compute_gamma</code> function returns a tuple of four values.
    We want output as displayed in Figure <a href="#wf:vib3:flask:fig:gamma">13</a>.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 13: Design of a web page illustrating the gamma probability functions. <a
        name="wf:vib3:flask:fig:gamma"></a></p></center>
<p><img src="fig-web4sa/vib3_flask_gamma.png" align="bottom" width=700></p>
</center>

<p>
    The design is realized in the file <code>view_results.html</code> shown below.

<p>

    <!-- code=html (from !bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">{% if result != None %}
<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result[0] }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result[1] }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>
Mean value: {{ result[2] }} <span style="color: #008000; font-weight: bold">&lt;br&gt;</span>
Standard deviation value: {{ result[3] }}
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
{% endif %}
</pre>
</div>
<p>
    To create the web application, we just copy the generic <code>controller.py</code>,
    <code>model.py</code>,
    and <code>templates/view_forms.html</code> files, add the
    application-specific
    <code>compute.py</code> and <code>templates/view_results.html</code> files given above,
    and <em>write one line</em> in
    <code>model.py</code>:

<p>

    <!-- code=python (from !bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">compute</span> <span
        style="color: #008000; font-weight: bold">import</span> compute_gamma <span
        style="color: #008000; font-weight: bold">as</span> compute
</pre>
</div>
<p>
    That's it! Running <code>controller.py</code> file starts the app.

<p>
<p>
    <!-- begin bottom navigation -->
    <a href="._part0011_web4sa_plain.html"><img src="http://hplgit.github.io/doconce/bundled/html_images/prev1.png"
                                                border=0 alt="previous"></a>

    <a href="._part0013_web4sa_plain.html"><img src="http://hplgit.github.io/doconce/bundled/html_images/next1.png"
                                                border=0 alt="next"></a>
    <!-- end bottom navigation -->

    <!-- ------------------- end of main content --------------- -->


</body>
</html>
    

