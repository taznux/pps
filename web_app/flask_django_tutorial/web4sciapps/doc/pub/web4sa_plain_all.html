<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/"/>
    <meta name="description" content="Using Web Frameworks for Scientific Applications">
    <meta name="keywords"
          content="web frameworks,MVC pattern,Flask installation,Flask input forms,Flask HTML templates,Flask MVC pattern,Flask troubleshooting,Django installation,Django making a project,Django making an application,Django input forms,Django HTML templates,Flask input forms,Flask error checking,Flask CSS style sheets,Flask LaTeX mathematics,Flask input validation,inline PNG image in HTML,base64 encoding of PNG images,inline SVG figure in HTML,mpld3 plotting,Flask Bokeh plotting,Bokeh plotting,highcharts,Flask login,Flask database,Flask uploading of files,Flask file upload,Django input forms,Django input validation">

    <title>Using Web Frameworks for Scientific Applications</title>


    <style type="text/css">
/* bloodish style */

body {
  font-family: Helvetica, Verdana, Arial, Sans-serif;
  color: #404040;
  background: #ffffff;
}
h1 { font-size: 1.8em;  color: #8A0808; }
h2 { font-size: 1.6em;  color: #8A0808; }
h3 { font-size: 1.4em;  color: #8A0808; }
h4 { color: #8A0808; }
a { color: #8A0808; text-decoration:none; }
tt { font-family: "Courier New", Courier; }
/* pre style removed because it will interfer with pygments */
p { text-indent: 0px; }
hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
p.caption { width: 80%; font-style: normal; text-align: left; }
hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}
.alert-text-small   { font-size: 80%;  }
.alert-text-large   { font-size: 130%; }
.alert-text-normal  { font-size: 90%;  }
.alert {
  padding:8px 35px 8px 14px; margin-bottom:18px;
  text-shadow:0 1px 0 rgba(255,255,255,0.5);
  border:1px solid #bababa;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  color: #555;
  background-color: #f8f8f8;
  background-position: 10px 5px;
  background-repeat: no-repeat;
  background-size: 38px;
  padding-left: 55px;
  width: 75%;
 }
.alert-block {padding-top:14px; padding-bottom:14px}
.alert-block > p, .alert-block > ul {margin-bottom:1em}
.alert li {margin-top: 1em}
.alert-block p+p {margin-top:5px}
.alert-notice { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_notice.png); }
.alert-summary  { background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_summary.png); }
.alert-warning { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_warning.png); }
.alert-question {background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_question.png); }

div { text-align: justify; text-justify: inter-word; }

    </style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [('Web frameworks', 1, None, '___sec0'),
              ('Other frameworks', 3, None, '___sec1'),
              ('The MVC pattern', 2, None, '___sec2'),
              ('A very simple application', 2, None, '___sec3'),
              ('Application of the MVC pattern', 2, 'wf:hw:mvc', 'wf:hw:mvc'),
              ('Making a Flask application', 1, None, '___sec5'),
              ('Programming the Flask application', 2, None, '___sec6'),
              ('The user interaction', 3, None, '___sec7'),
              ('The Python code', 3, None, '___sec8'),
              ('Dissection', 3, None, '___sec9'),
              ('The template files', 3, None, '___sec10'),
              ('Testing the application', 3, None, '___sec11'),
              ('Equipping the input page with output results',
               2,
               None,
               '___sec12'),
              ('Splitting the app into model, view, and controller files',
               2,
               'wf:hw3:flask',
               'wf:hw3:flask'),
              ('Troubleshooting', 2, None, '___sec14'),
              ('Address already in use', 3, None, '___sec15'),
              ('Making a Django application', 1, None, '___sec16'),
              ('Setting up a Django project', 2, None, '___sec17'),
              ('Setting up a Django application', 2, None, '___sec18'),
              ('Programming the Django application', 2, None, '___sec19'),
              ('The user interaction', 3, None, '___sec20'),
              ('The model', 3, None, '___sec21'),
              ('The view', 3, None, '___sec22'),
              ('Making the input page', 3, None, '___sec23'),
              ('Making the results page', 3, None, '___sec24'),
              ('Equipping the input page with output results',
               2,
               None,
               '___sec25'),
              ('Handling multiple input variables in Flask',
               1,
               'wf:vib:flask',
               'wf:vib:flask'),
              ('Programming the Flask application',
               2,
               'wf:vib1:flask:app',
               'wf:vib1:flask:app'),
              ('The compute part', 3, None, '___sec28'),
              ('The model', 3, None, '___sec29'),
              ('The view', 3, None, '___sec30'),
              ('The HTML template', 3, None, '___sec31'),
              ('Implementing error checking in the template',
               2,
               None,
               '___sec32'),
              ('Using style sheets', 2, None, '___sec33'),
              ('Using LaTeX mathematics', 2, None, '___sec34'),
              ('Rearranging the elements in the HTML template',
               2,
               None,
               '___sec35'),
              ('Bootstrap HTML style', 2, None, '___sec36'),
              ('Custom validation',
               2,
               'wf:vib1:flask:validation',
               'wf:vib1:flask:validation'),
              ('Using Flask validators', 3, None, '___sec38'),
              ('Tailored validation', 3, None, '___sec39'),
              ('Tailored validation of intervals', 3, None, '___sec40'),
              ('Demo', 3, None, '___sec41'),
              ('Avoiding plot files',
               2,
               'wf:vib2:flask:nofiles',
               'wf:vib2:flask:nofiles'),
              ('PNG plots', 3, None, '___sec43'),
              ('SVG plots', 3, None, '___sec44'),
              ('Using mpld3', 3, None, '___sec45'),
              ('Plotting with the Bokeh library',
               2,
               'wf:bokeh:flask',
               'wf:bokeh:flask'),
              ('Pandas highcharts plotting library', 3, None, '___sec47'),
              ('Autogenerating the code',
               2,
               'wf:autogen:flask',
               'wf:autogen:flask'),
              ('Inspecting function signatures', 3, None, '___sec49'),
              ('Generating the model', 3, None, '___sec50'),
              ('Generating the view', 3, None, '___sec51'),
              ('Generating the template', 3, None, '___sec52'),
              ('Application', 3, None, '___sec53'),
              ('User login and storage of computed results',
               2,
               'wf:flask:login',
               'wf:flask:login'),
              ('Required additional software', 3, None, '___sec55'),
              ('The compute part', 3, None, '___sec56'),
              ('The interfaces of the app', 3, None, '___sec57'),
              ('The source code', 3, None, '___sec58'),
              ('Resources', 3, None, '___sec59'),
              ('Uploading of files', 2, 'wf:flask:upload', 'wf:flask:upload'),
              ('Overview of the application', 3, None, '___sec61'),
              ('The model class', 3, None, '___sec62'),
              ('The controller file', 3, None, '___sec63'),
              ('The compute function', 3, None, '___sec64'),
              ('The HTML template', 3, None, '___sec65'),
              ('Handling multiple input variables in Django',
               1,
               'wf:vib:django',
               'wf:vib:django'),
              ('Programming the Django application', 2, None, '___sec67'),
              ('Adding the app to a project', 3, None, '___sec68'),
              ('The compute part', 3, None, '___sec69'),
              ('The model', 3, None, '___sec70'),
              ('The view', 3, None, '___sec71'),
              ('Custom validation', 2, None, '___sec72'),
              ('Customizing widgets', 2, None, '___sec73'),
              ('Resources', 2, None, '___sec74'),
              ('Exercises', 1, None, '___sec75'),
              ('Exercise 1: Add two numbers',
               2,
               'wf:exer:add2',
               'wf:exer:add2'),
              ('Exercise 2: Upload data file and visualize curves',
               2,
               'wf:exer:upload',
               'wf:exer:upload'),
              ('Exercise 3: Plot a user-specified formula',
               2,
               'wf:exer:formula',
               'wf:exer:formula'),
              ('Exercise 4: Visualize Taylor polynomial approximations',
               2,
               'wf:exer:Taylor',
               'wf:exer:Taylor'),
              ('Exercise 5: Extend the `gen` app',
               2,
               'wf:exer:gen:demo',
               'wf:exer:gen:demo'),
              ('Exercise 6: Make a web app with multiple apps',
               2,
               'wf:exer:addmul',
               'wf:exer:addmul'),
              ('Exercise 7: Equip the `gen` app with more data types',
               2,
               'wf:exer:gen:lists',
               'wf:exer:gen:lists'),
              ('Exercise 8: Auto-generate code from function signature',
               2,
               None,
               '___sec83'),
              ('Project 9: Interactive function exploration',
               2,
               'wf:exer:bokeh_UI',
               'wf:exer:bokeh_UI'),
              ('Resources', 1, None, '___sec85'),
              ('Flask resources', 2, None, '___sec86'),
              ('Django resources', 2, None, '___sec87')]}
end of tocinfo -->

<body>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});

</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- ------------------- main content ---------------------- -->


<center><h1>Using Web Frameworks for Scientific Applications</h1></center>  <!-- document title -->

<p>
    <!-- author(s): Hans Petter Langtangen, and Anders E. Johansen -->

<center>
    <b>Hans Petter Langtangen</b> [1, 2]
</center>

<center>
    <b>Anders E. Johansen</b> [1]
</center>

<p>
    <!-- institution(s) -->

<center>[1] <b>Center for Biomedical Computing, Simula Research Laboratory</b></center>
<center>[2] <b>Department of Informatics, University of Oslo</b></center>
<br>
<p>
<center><h4>Oct 11, 2015</h4></center> <!-- date -->
<br>

<h2>Table of contents</h2>

<p>
    <a href="#___sec0"> Web frameworks </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec2"> The MVC pattern </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec3"> A very simple application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:hw:mvc"> Application of the MVC pattern </a><br>
    <a href="#___sec5"> Making a Flask application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec6"> Programming the Flask application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec12"> Equipping the input page with output results </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:hw3:flask"> Splitting the app into model, view, and controller files </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec14"> Troubleshooting </a><br>
    <a href="#___sec16"> Making a Django application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec17"> Setting up a Django project </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec18"> Setting up a Django application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec19"> Programming the Django application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec25"> Equipping the input page with output results </a><br>
    <a href="#wf:vib:flask"> Handling multiple input variables in Flask </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:vib1:flask:app"> Programming the Flask application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec32"> Implementing error checking in the template </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec33"> Using style sheets </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec34"> Using LaTeX mathematics </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec35"> Rearranging the elements in the HTML template </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec36"> Bootstrap HTML style </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:vib1:flask:validation"> Custom validation </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:vib2:flask:nofiles"> Avoiding plot files </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:bokeh:flask"> Plotting with the Bokeh library </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:autogen:flask"> Autogenerating the code </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:flask:login"> User login and storage of computed results </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:flask:upload"> Uploading of files </a><br>
    <a href="#wf:vib:django"> Handling multiple input variables in Django </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec67"> Programming the Django application </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec72"> Custom validation </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec73"> Customizing widgets </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec74"> Resources </a><br>
    <a href="#___sec75"> Exercises </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:add2"> Exercise 1: Add two numbers </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:upload"> Exercise 2: Upload data file and visualize curves </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:formula"> Exercise 3: Plot a user-specified formula </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:Taylor"> Exercise 4: Visualize Taylor polynomial approximations </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:gen:demo"> Exercise 5: Extend the <code>gen</code> app </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:addmul"> Exercise 6: Make a web app with multiple apps </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:gen:lists"> Exercise 7: Equip the <code>gen</code> app with more data types
</a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec83"> Exercise 8: Auto-generate code from function signature </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#wf:exer:bokeh_UI"> Project 9: Interactive function exploration </a><br>
    <a href="#___sec85"> Resources </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec86"> Flask resources </a><br>
    &nbsp; &nbsp; &nbsp; <a href="#___sec87"> Django resources </a><br>
</p>

<h1 id="___sec0">Web frameworks </h1>

<p>
    Computational scientists may want to offer their applications through
    a web interface, thereby making a <em>web application</em>.
    Basically, this means that users can set input data
    to the application on a web page, then click on some <em>Compute</em> button,
    and back comes a new web page with the results of the computations.
    The web interface can either be used as a GUI locally on the
    scientist's computer, or the interface can be depolyed to
    a server and made available to the whole world.

<p>
    Web applications of the mentioned type can be created from scratch
    using CGI scripts in (e.g.) Python, but the code quickly gets longer
    and more involved as the complexity of the web interface
    grows. Nowadays, most web applications are created with the aid of
    <em>web frameworks</em>, which are software packages that simplify the
    programming tasks of offering services through the Internet. The
    downside of web frameworks is that there is a significant amount of
    steps and details to learn before your first simple demo application
    works. The upside is that advanced applications are within reach,
    without an overwhelming amount of programming, as soon as you have
    understood the basic demos.

<p>
    We shall explore two web frameworks: the very popular <a href="https://www.djangoproject.com/" target="_self">Django
    framework</a> and the more high-level and easy-to-use framework
    <a href="http://flask.pocoo.org/" target="_self">Flask</a>.
    The primary advantage of Django
    over other web frameworks is the rich set of documentation and
    examples. Googling for "Django tutorials" gives lots of hits including
    a list of <a href="https://code.djangoproject.com/wiki/Tutorials" target="_self">web tutorials</a>
    and a list of <a href="http://www.youtube.com/playlist?list=PL385A53B00B8B158E" target="_self">YouTube videos</a>.
    There is also an electronic <a href="http://www.djangobook.com/en/2.0/" target="_self">Django book</a>. At the time
    of this writing, the Flask documentation is not comparable. The two most important resources are the
    <a href="http://flask.pocoo.org/" target="_self">official web site</a> and the <a
        href="http://wtforms.simplecodes.com/docs/0.6/index.html" target="_self">WTForms Documentation</a>. There is,
    unfortunately, hardly any examples on how Django or Flask can be used to enable typical scientific applications for
    the web, and that is why we have developed some targeted examples on this topic.

<p>
    A basic question is, of course, whether you should apply Flask or
    Django for your web project. Googling for <em>flask vs django</em> gives a
    lot of diverging opinions. The authors' viewpoint is that Flask is
    much easier to get started with than Django. You can grow your
    application to a really big one with both frameworks, but some
    advanced features is easier in one framework than in the other.

<p>
    The problem for a computational scientist who wants to enable
    mathematical calculations through the web is that most of
    the introductory examples on utilizing a particular
    web framework address web applications
    of very different nature, e.g., blogs and polls. Therefore, we have made an
    alternative introduction which explains, in the simplest possible way,
    how web frameworks can be used to

<ol>
    <li> generate a web page with input data to your application,</li>
    <li> run the application to perform mathematical computations, and</li>
    <li> generate a web page with the results of the computations.</li>
</ol>

To work with Django, you need to know about Python packages and modules
as well as Python classes. With Flask it is enough to be familiar with
functions and modules, though knowledge of classes and a bit of
decorators might be an advantage.

<p>
    All the files associated with this document are available in a
    <a href="https://github.com/hplgit/web4sciapps/" target="_self">GitHub repository</a>.
    The relevant files for the web applications are located
    in a subtree <a href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/"
                    target="_self"><tt>doc/src/web4sa/src-web4sa/apps</tt></a>
    of this repository.

<h3 id="___sec1">Other frameworks </h3>

<p>
    Our introductory examples were also implemented in the <a href="http://www.web2py.com/" target="_self">web2py</a>
    framework, but according to our experience,
    Flask and Django are easier to explain to scientists. A framework
    quite similar to Flask is <a href="http://bottlepy.org/docs/dev/index.html" target="_self">Bottle</a>. An even
    simpler framework
    is <a href="http://www.cherrypy.org/" target="_self">CherryPy</a>, which has an interesting
    extension <a href="https://github.com/adamhajari/spyre" target="_self">Spyre</a> for easy
    visualization of data. Once you know the basics of Flask, CherryPy is
    easy to pick up by reading its <a href="http://docs.cherrypy.org/en/latest/tutorials.html#tutorials" target="_self">tutorial</a>.
    (There
    are some comments on the Internet about increased stability of Flask
    apps if they are <a href="http://flask.pocoo.org/snippets/24/" target="_self">run on a CherryPy server</a>.)

<p>
    <!-- !split -->

<h2 id="___sec2">The MVC pattern </h2>

<p>
    The MVC pattern stands for Model-View-Controller and is a way of
    separating the user's interaction with an application from the inner
    workings of the application. In a scientific application this
    usually means separating mathematical computations from the
    user interface and visualization of results.
    The <a href="http://en.wikipedia.org/wiki/MVC_Pattern" target="_self">Wikipedia definition of the MVC pattern</a>
    gives a very high-level
    explanation of what the model, view, and controller do and mentions
    the fact that different web frameworks interpret the three components
    differently. Any web application works with a set of data and needs
    a user interface for the communication of data between the user and
    some data processing software. The classical
    MVC pattern introduces

<ul>
    <li> the model to hold the data</li>
    <li> the view to display the data</li>
    <li> the controller to move the data by gluing the model and the view.</li>
</ul>

For applications performing mathematical computations we find it
convenient to explicitly introduce a fourth component that we call
<em>compute</em> where the mathematical computations are encapsulated. With
the MVC pattern and the compute component we have a clear separation
between data (model), the way data is presented (view), the
computations (compute), and the way these components communicate
(controller). In a small program such a separation may look as
overkill, but it pays off in more complicated applications. More
importantly, the concepts of the MVC pattern are widely used in web
frameworks and their documentation so one should really adapt to the
MVC way of thinking.

<p>
    Web frameworks often have their own way of interpreting the
    model, view, and controller parts of the MVC pattern.
    In particular, most frameworks often divide the view into two parts:
    one software component and one HTML template. The latter takes care
    of the look and feel of the web page while the former often takes
    the role of being the controller too.
    For our scientific applications
    we shall employ an interpretation of the MVC pattern
    which is compatible with what we need later on:

<ul>
    <li> the model contains the data (often only the input data) of the application,</li>
    <li> the view controls the user interface that handles input and output data,
        and also calls to functionality that computes the output given the input.
    </li>
</ul>

The model will be a Python class with static attributes holding the data.
The view consists of Python code processing the model's data, calling the
compute component, and specifying HTML
templates for the design of the web pages.

<p>
    Flask does not force any MVC pattern on the programmer, but
    the code needed to build web applications can easily be split into
    model, view, controller, and compute components, as will be shown later.
    Django, on the other hand, automatically generates application files with names
    <code>views.py</code> and <code>models.py</code> so it is
    necessary to have some idea what Django means by these terms.
    The controller functionality in Django lies both in the <code>views.py</code> file and
    in the configuration
    files (<code>settings.py</code> and <code>urls.py</code>). The view component of the application
    consists both of the <code>views.py</code> file and template files used to create
    the HTML code in the web pages.

<p>
    Forthcoming examples will illustrate how a scientific application is
    split to meet the requirements of the MVC software design pattern.

<p>
    <!-- !split -->

<h2 id="___sec3">A very simple application </h2>

<p>
    We shall start with the simplest possible application,
    a &quot;scientific hello world program&quot;, where the
    task is to read a number and write out &quot;Hello, World!&quot; followed by
    the sine of the number. This application has one input variable and
    a line of text as output.

<p>
    Our first implementation reads the input from the command
    line and writes the results to the terminal window:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #408080; font-style: italic">#!/usr/bin/env python</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span><span
            style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">math</span>
r <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span
            style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
s <span style="color: #666666">=</span> math<span style="color: #666666">.</span>sin(r)
<span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;Hello, World! sin(</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">)=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (r, s)
</pre>
</div>
<p>
    In the terminal we can exemplify the program

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python hw.py 1.2
Hello, World! sin(1.2)=0.932039
</pre>
</div>
<p>
    The task of the web version of this program is to read the <code>r</code>
    variable from a web page, compute the sine,
    and write out a new web page with the resulting text.

<p>
    <!-- !split -->

<h2 id="wf:hw:mvc">Application of the MVC pattern</h2>

<p>
    Before thinking of a web application, we first <em>refactor</em> our program
    such that it fits with the classical MVC pattern and a compute component.
    The refactoring does not change the functionality of the code, it
    just distributes the original statements in functions and modules.
    Here we create four modules: <code>model</code>, <code>view</code>,
    <code>compute</code>, and <code>controller</code>.

<ul>
    <li> The <code>compute</code> module contains a function <code>compute(r)</code> that performs
        the mathematics and returns the value <code>s</code>, which equals <code>sin(r)</code>.
    </li>
    <li> The <code>model</code> module holds the input data, here <code>r</code>.</li>
    <li> The <code>view</code> module has two functions, one for reading input data,
        <code>get_input</code>,
        and one for presenting the output, <code>present_output</code>.
        The latter takes the input, calls <code>compute</code> functionalty, and
        generates the output.
    </li>
    <li> The <code>controller</code> module calls the view to initialize
        the model's data from the command line. Thereafter, the
        view is called to present the output.
    </li>
</ul>

The <code>model.py</code> file contains the <code>r</code> variable, which must
be declared with a default value in order to create the data object:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">r <span
        style="color: #666666">=</span> <span style="color: #666666">0.0</span>    <span
        style="color: #408080; font-style: italic"># input</span>
s <span style="color: #666666">=</span> <span style="color: #008000">None</span>   <span
            style="color: #408080; font-style: italic"># output</span>
</pre>
</div>
<p>
    The <code>view.py</code> file is restricted to the communication with the user and reads

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">sys</span>
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">compute</span>

<span style="color: #408080; font-style: italic"># Input: float r</span>
<span style="color: #408080; font-style: italic"># Output: &quot;Hello, World! sin(r)=...&quot;</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_input</span>():
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Get input data from the command line.&quot;&quot;&quot;</span>
    r <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span
            style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
    <span style="color: #008000; font-weight: bold">return</span> r

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">present_output</span>(r):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Write results to terminal window.&quot;&quot;&quot;</span>
    s <span style="color: #666666">=</span> compute<span style="color: #666666">.</span>compute(r)
    <span style="color: #008000; font-weight: bold">print</span> <span
            style="color: #BA2121">&#39;Hello, World! sin(</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">)=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (r, s)
</pre>
</div>
<p>
    The mathematics is encapsulated in <code>compute.py</code>:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">math</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute</span>(r):
    <span style="color: #008000; font-weight: bold">return</span> math<span style="color: #666666">.</span>sin(r)
</pre>
</div>
<p>
    Finally, <code>controller.py</code> glues the model and the view:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">model</span><span style="color: #666666">,</span> <span
        style="color: #0000FF; font-weight: bold">view</span>

model<span style="color: #666666">.</span>r <span style="color: #666666">=</span> view<span
            style="color: #666666">.</span>get_input()
view<span style="color: #666666">.</span>present_output(model<span style="color: #666666">.</span>r)
</pre>
</div>
<p>
    Let us try our refactored code:

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python controller.py 1.2
Hello, World! sin(1.2)=0.932039
</pre>
</div>
<p>
    The next step is to create a web interface to our scientific hello world
    program such that we can fill in the number <code>r</code> in a text field, click a
    <em>Compute</em> button and get back a new web page with the output text
    shown above: &quot;Hello, World! sin(r)=s&quot;.

<p>
    <!-- !split -->

<h1 id="___sec5">Making a Flask application </h1>

<p>
    Not much code or configuration is needed to make a Flask application.
    Actually one short file is enough. For this file to work you need to
    install Flask and some corresponding packages. This is easiest
    performed by

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; sudo pip install --upgrade Flask
Terminal&gt; sudo pip install --upgrade Flask-WTF
</pre>
</div>
<p>
    The <code>--upgrade</code> option ensures that you upgrade to the latest version in
    case you already have these packages.

<h2 id="___sec6">Programming the Flask application </h2>

<h3 id="___sec7">The user interaction </h3>

<p>
    We want our input page to feature a text field where the user can
    write the value of <code>r</code>, see Figure <a href="#wf:hw1:flask:fig:input">1</a>.
    By clicking on the <em>equals</em> button
    the corresponding <code>s</code> value is computed and written out the result page
    seen in Figure <a href="#wf:hw1:flask:fig:result">2</a>.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 1: The input page.
<div id="wf:hw1:flask:fig:input"></div>
</p></center>
<p><img src="fig-web4sa/hw1_flask_input.png" align="bottom" width=600></p>
</center>

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 2: The output page.
<div id="wf:hw1:flask:fig:result"></div>
</p></center>
<p><img src="fig-web4sa/hw1_flask_output.png" align="bottom" width=600></p>
</center>

<h3 id="___sec8">The Python code </h3>

<p>
    Flask does not require us to use the MVC pattern so there is actually
    no need to split the original program into model, view, controller,
    and compute files as already explained (but it will be
    done later). First we make a <code>controller.py</code> file where the view, the
    model, and the controller parts appear within the same file.
    The <code>compute</code> component is always in a separate file as
    we like to encapsulate the computations completely from user
    interfaces.

<p>
    The view that the user sees is determined by
    HTML templates in a subdirectory <code>templates</code>, and consequently
    we name the template files <code>view*.html</code>.
    The model and other parts of the view concept are just parts of
    the <code>controller.py</code> file. The complete file is short and explained
    in detail below.

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">flask</span> <span
        style="color: #008000; font-weight: bold">import</span> Flask, render_template, request
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">wtforms</span> <span style="color: #008000; font-weight: bold">import</span> Form, FloatField, validators
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute

app <span style="color: #666666">=</span> Flask(__name__)

<span style="color: #408080; font-style: italic"># Model</span>
<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(Form):
    r <span style="color: #666666">=</span> FloatField(validators<span style="color: #666666">=</span>[validators<span
            style="color: #666666">.</span>InputRequired()])

<span style="color: #408080; font-style: italic"># View</span>
<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/hw1&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        r <span style="color: #666666">=</span> form<span style="color: #666666">.</span>r<span
            style="color: #666666">.</span>data
        s <span style="color: #666666">=</span> compute(r)
        <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;view_output.html&quot;</span>, form<span
            style="color: #666666">=</span>form, s<span style="color: #666666">=</span>s)
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;view_input.html&quot;</span>, form<span
            style="color: #666666">=</span>form)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>

<h3 id="___sec9">Dissection </h3>

<p>
    The web application is the <code>app</code> object of class <code>Flask</code>, and
    initialized as shown. The model is a special Flask class derived from
    <code>Form</code> where the input variable in the app is listed as a static class
    attribute and initialized by a special form field object from the
    <code>wtforms</code> package. Such form field objects correspond to HTML forms
    in the input page. For the <code>r</code> variable we apply <code>FloatField</code> since
    it is a floating-point variable. A default validator, here checking
    that the user supplies a real number, is automatically included, but
    we add another validator, <code>InputRequired</code>, to force the user to
    provide input before clicking on the <em>equals</em> button.

<p>
    The view part of this Python code consists of a URL and a
    corresponding function to call when the URL is invoked. The function
    name is here chosen to be <code>index</code> (inspired by the standard
    <code>index.html</code> page that is the main page of a web app). The decorator
    <code>@app.route('/hw1', ...)</code> maps the URL <code>http://127.0.0.1:5000/hw1</code> to
    a call to <code>index</code>. The <code>methods</code> argument must be as shown to allow
    the user to communicate with the web page.

<p>
    The <code>index</code> function first makes a form object based on the data in
    the model, here class <code>InputForm</code>. Then there are two possibilities:
    either the user has provided data in the HTML form or the user is
    to be offered an input form. In the former case, <code>request.method</code>
    equals <code>'POST'</code> and we can extract the numerical value of <code>r</code>
    from the <code>form</code> object, using <code>form.r.data</code>, call up our mathematical
    computations, and make a web page with the result.
    In the latter case, we make an input page as displayed in
    Figure <a href="#wf:hw1:flask:fig:input">1</a>.

<h3 id="___sec10">The template files </h3>

<p>
    Making a web page with Flask is conveniently done by an HTML
    template. Since the output page is simplest we display the
    <code>view_output.html</code> template first:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Hello, World! sin({{ form.r.data }})={{s}}.
</pre>
</div>
<p>
    Keyword arguments sent to <code>render_template</code> are available in the
    HTML template. Here we have the keyword arguments <code>form</code> and <code>s</code>.
    With the <code>form</code> object we extract the value of
    <code>r</code> in the HTML code by <code>{{ form.r.data }}</code>. Similarly, the value of <code>s</code>
    is simply <code>{{ s }}</code>.

<p>
    The HTML template for the input page is slightly more complicated
    as we need to use an HTML form:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
  Hello, World! The sine of {{ form.r }}
  <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">equals</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
</pre>
</div>

<h3 id="___sec11">Testing the application </h3>

<p>
    We collect the files associated with a Flask application (often called
    just <em>app</em>) in a directory,
    here called <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/hw1"
        target="_self"><tt>hw1</tt></a>.
    All you have to do in order to run this web application is to find
    this directory and run

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python controller.py
 * Running on http://127.0.0.1:5000/
 * Restarting with reloader
</pre>
</div>
<p>
    Open a new window or tab in your browser and type in the URL
    <code>http://127.0.0.1:5000/hw1</code>.

<h2 id="___sec12">Equipping the input page with output results </h2>

<p>
    Our application made two distinct pages for grabbing input from the
    user and presenting the result. It is often more natural to add
    the result to the input page. This is particularly the case in the present
    web application, which is a kind of calculator. Figure <a href="#wf:hw2:flask:fig:result">3</a> shows what the user
    sees after clicking the <em>equals</em> button.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 3: The modified result page.
<div id="wf:hw2:flask:fig:result"></div>
</p></center>
<p><img src="fig-web4sa/hw2_flask_output.png" align="bottom" width=600></p>
</center>

<p>
    To let the user stay within the same page, we create a new directory
    <a href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/hw2"
       target="_self"><tt>hw2</tt></a>
    for this modified Flask app and copy the files from the previous
    <code>hw1</code> directory. The idea now is to make use of just one
    template, in <code>templates/view.html</code>:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
  Hello, World! The sine of
  {{( form.r )}}
  <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">equals</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
{% if s != None %}
{{s}}
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
</pre>
</div>
<p>
    The form is identical to what we used in <code>view_input.html</code> in
    the <code>hw1</code> directory, and the only
    new thing is the output of <code>s</code> below the form.

<p>
    The template language supports some programming with Python objects
    inside <code>{%</code> and <code>%}</code> tags.
    Specifically in this file, we can test on the value of <code>s</code>:
    if it is <code>None</code>, we know that the computations are not performed and
    <code>s</code> should not appear on the page, otherwise <code>s</code> holds the sine
    value and we can write it out. Note that, contrary to plain Python,
    the template language does not rely on indentation of blocks and
    therefore needs an explicit end statement <code>{% endif %}</code> to finish
    the if-test.
    The generated HTML code from this template file reads

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
  Hello, World! The sine of
  <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">id=</span><span
            style="color: #BA2121">&quot;r&quot;</span> <span style="color: #7D9029">name=</span><span
            style="color: #BA2121">&quot;r&quot;</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;1.2&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">equals</span><span
            style="color: #008000; font-weight: bold">&gt;</span>

0.932039085967

<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
</pre>
</div>
<p>
    The <code>index</code> function of our modified application
    needs adjustments since we use the same
    template for the input and the output page:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #408080; font-style: italic"># View</span>
<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/hw2&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        r <span style="color: #666666">=</span> form<span style="color: #666666">.</span>r<span
            style="color: #666666">.</span>data
        s <span style="color: #666666">=</span> compute(r)
    <span style="color: #008000; font-weight: bold">else</span>:
        s <span style="color: #666666">=</span> <span style="color: #008000">None</span>

    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;view.html&quot;</span>, form<span
            style="color: #666666">=</span>form, s<span style="color: #666666">=</span>s)
</pre>
</div>
<p>
    It is seen that if the user has given data, <code>s</code> is a <code>float</code>, otherwise
    <code>s</code> is <code>None</code>. You are encouraged to test the app by running

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python controller.py
</pre>
</div>
<p>
    and loading <code>http://127.0.0.1:5000/hw2</code> into your browser.
    A nice little exercise is to control the formatting of the result <code>s</code>.
    To this end, you can simply transform <code>s</code> to a string: <code>s = '%.5f' % s</code> before
    sending it to <code>render_template</code>.

<h2 id="wf:hw3:flask">Splitting the app into model, view, and controller files</h2>

<p>
    In our previous two Flask apps we have had the view displayed for the
    user in a separate template file, and the computations as always in
    <code>compute.py</code>, but everything else was placed in one file <code>controller.py</code>.
    For illustration of the MVC concept we
    may split the <code>controller.py</code> into two files: <code>model.py</code> and
    <code>controller.py</code>. The view is in <code>templates/view.html</code>.
    These new files are located in a
    directory
    <a href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/hw3"
       target="_self"><tt>hw3_flask</tt></a>
    The contents
    in the files reflect the splitting introduced in the original
    scientific hello world program in the section <a href="#wf:hw:mvc">Application of the MVC pattern</a>.
    The <code>model.py</code> file now consists of the input form class:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">wtforms</span> <span
        style="color: #008000; font-weight: bold">import</span> Form, FloatField, validators

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(Form):
    r <span style="color: #666666">=</span> FloatField(validators<span style="color: #666666">=</span>[validators<span
            style="color: #666666">.</span>InputRequired()])
</pre>
</div>
<p>
    The file <code>templates/view.html</code> is as before, while <code>controller.py</code> contains

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">flask</span> <span
        style="color: #008000; font-weight: bold">import</span> Flask, render_template, request
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">model</span> <span
            style="color: #008000; font-weight: bold">import</span> InputForm

app <span style="color: #666666">=</span> Flask(__name__)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/hw3&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        r <span style="color: #666666">=</span> form<span style="color: #666666">.</span>r<span
            style="color: #666666">.</span>data
        s <span style="color: #666666">=</span> compute(r)
    <span style="color: #008000; font-weight: bold">else</span>:
        s <span style="color: #666666">=</span> <span style="color: #008000">None</span>

    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;view.html&quot;</span>, form<span
            style="color: #666666">=</span>form, s<span style="color: #666666">=</span>s)


<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>
<p>
    The statements are indentical to those in the <code>hw2</code> app, only
    the organization of the statement in files differ.

<p>
    <!-- !split -->

<h2 id="___sec14">Troubleshooting </h2>

<h3 id="___sec15">Address already in use </h3>

<p>
    You can easily kill the Flask application and restart it, but sometimes
    you will get an error that the address is already in use.
    To recover from this problem, run the <code>lsof</code> program to see which program
    that applies the 5000 port (Flask runs its server on <code>http://127.0.0.1:5000</code>,
    which means that it uses the 5000 port). Find the PID of the program
    that occupies the port and force abortion of that program:

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; lsof -i :5000
COMMAND   PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
python  48824  hpl    3u  IPv4 1128848      0t0  TCP ...
Terminal&gt; kill -9 48824
</pre>
</div>
<p>
    You are now ready to restart a Flask application.

<p>
    <!-- !split -->

<h1 id="___sec16">Making a Django application </h1>

<p>
    We recommend to
    download and istall the latest official version of Django from
    <a href="http://www.djangoproject.com/download/" target="_self"><tt>http://www.djangoproject.com/download/</tt></a>.
    Pack out the tarfile, go
    to the directory, and run <code>setup.py</code>:

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; tar xvzf Django-1.5-tar.gz
Terminal&gt; cd Django-1.5
Terminal&gt; sudo python setup.py install
</pre>
</div>
<p>
    The version in this example, 1.5, may be different at the time you
    follow these instructions.

<h2 id="___sec17">Setting up a Django project </h2>

<p>
    Django applies two concepts: <em>project</em> and <em>application</em> (or <em>app</em>).
    The app is the program we want to run through a web interface. The
    project is a Python package containing common settings and
    configurations for a collection of apps. This means that before we can
    make a Django app, we must to establish a Django project.

<p>
    A Django project for managing a set of Django apps is
    created by the command

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; django-admin.py startproject django_project
</pre>
</div>
<p>
    The result in this example
    is a directory <code>django_project</code> whose content can be explored
    by some <code>ls</code> and <code>cd</code> commands:

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; ls django_project
manage.py django_project
Terminal&gt; cd django_project/django_project
Terminal&gt; ls
__init__.py settings.py urls.py wsgi.py
</pre>
</div>
<p>
    The meaning of the generated files is briefly listed below.

<ul>
    <li> The outer <code>django_project/</code> directory is just a container for your project. Its name does not matter
        to Django.
    </li>
    <li><code>manage.py</code> is a command-line utility that lets you interact with this Django project in various
        ways. You will typically run <code>manage.py</code> to launch a Django application.
    </li>
    <li> The inner <code>django_project/</code> directory is a Python package for the Django project. Its name is used
        in import statements in Python code (e.g., <code>import django_project.settings</code>).
    </li>
    <li><code>django_project/__init__.py</code> is an empty file that just tells Python that this directory should be
        considered a Python package.
    </li>
    <li><code>django_project/settings.py</code> contains the settings and configurations for this Django project.</li>
    <li><code>django_project/urls.py</code> maps URLs to specific functions and thereby defines that actions that
        various URLs imply.
    </li>
    <li><code>django_project/wsgi.py</code> is not needed in our examples.</li>
</ul>

Django comes with a web server for developing and debugging applications.
The server is started by running

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python manage.py runserver
Validating models...

0 errors found
March 34, 201x - 01:09:24
Django version 1.5, using settings &#39;django_project.settings&#39;
Development server is running at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
</pre>
</div>
<p>
    The output from starting the server tells that the server runs on the
    URL <code>http://127.0.0.1:8000/</code>.
    Load this URL into your browser to see a welcome message from Django,
    meaning that the server is working.

<p>
    Despite the fact that our introductory
    web applications do not need a database, you
    have to register a database with any Django project. To this end,
    open the <code>django_project/settings.py</code> file in a text editor,
    locate the <code>DATABASES</code> dictionary and type in the following
    code:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">os</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">relative2absolute_path</span>(relative_path):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return the absolute path correspodning to relative_path.&quot;&quot;&quot;</span>
    dir_of_this_file <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>dirname(os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>abspath(__file__))
    <span style="color: #008000; font-weight: bold">return</span> dir_of_this_file <span style="color: #666666">+</span> <span
            style="color: #BA2121">&#39;/&#39;</span> <span style="color: #666666">+</span> relative_path

DATABASES <span style="color: #666666">=</span> {
   <span style="color: #BA2121">&#39;default&#39;</span> : {
      <span style="color: #BA2121">&#39;ENGINE&#39;</span>: <span style="color: #BA2121">&#39;django.db.backends.sqlite3&#39;</span>,
      <span style="color: #BA2121">&#39;NAME&#39;</span>: relative2absolute_path(<span style="color: #BA2121">&#39;../database.db&#39;</span>)
   }
}
</pre>
</div>
<p>
    The <code>settings.py</code> file needs absolute paths to files, while it is
    more convenient for us to specify relative paths. Therefore,
    we made a function that figures out the absolute path to the <code>settings.py</code>
    file and then combines this absolute path with the relative path.
    The location and name of the database file can be chosen as desired.
    Note that one should <em>not</em> use <code>os.path.join</code> to create paths as Django
    always applies the forward slash between directories, also on Windows.

<h2 id="___sec18">Setting up a Django application </h2>

<p>
    The next step is to create a Django app for our scientific hello
    world program. We can place the app in any directory, but here we
    utilize the following organization.
    As neighbor to <code>django_project</code> we have
    a directory <code>apps</code> containing our various scientific applications.
    Under <code>apps</code> we create a directory <code>django_apps</code> with
    our different versions of Django applications.
    The directory <code>py_apps</code> contains the
    original <code>hw.py</code> program in the subdirectory <code>orig</code>,
    while split of this
    program according to the MVC pattern appears in the <code>mvc</code> directory.

<p>
    The directory <code>django_apps/hw1</code> is our first attempt to write
    a Django-based web interface for the <code>hw.py</code> program.
    The directory structure is laid out by
<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; cd ..
Terminal&gt; mkdir apps
Terminal&gt; cd apps
Terminal&gt; mkdir py_apps
Terminal&gt; cd py
Terminal&gt; mkdir orig mvc
Terminal&gt; cd ../..
Terminal&gt; mkdir django_apps
Terminal&gt; cd django_apps
</pre>
</div>
<p>
    The file <code>hw.py</code> is moved to <code>orig</code> while <code>mvc</code> contains
    the MVC refactored version with the files <code>model.py</code>, <code>view.py</code>, <code>compute.py</code>,
    and <code>controller.py</code>.

<p>
    The <code>hw1</code> directory, containing our first Django application, must be
    made with
<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python ../../django_project/manage.py startapp hw1
</pre>
</div>
<p>
    The command creates a directory <code>hw1</code> with four empty files:

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; cd hw1
Terminal&gt; ls
__init__.py models.py tests.py views.py
</pre>
</div>
<p>
    The <code>__init__.py</code> file will remain empty to just indicate that the
    Django application is a Python package. The other files need to be
    filled with the right content, which happens in the next section.

<p>
    At this point,
    we need to register some information about our application in the
    <code>django_project/settings.py</code> and <code>django_project/urls.py</code> files.

<p>
    <b>Step 1: Add the app.</b>
    Locate the <code>INSTALLED_APPS</code>
    tuple in <code>settings.py</code> and add your Django application as a Python package:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">INSTALLED_APPS <span
        style="color: #666666">=</span> (
    <span style="color: #BA2121">&#39;django.contrib.auth&#39;</span>,
    <span style="color: #BA2121">&#39;django.contrib.contenttypes&#39;</span>,
    <span style="color: #666666">...</span>
    <span style="color: #BA2121">&#39;hw1&#39;</span>,
)
</pre>
</div>
<p>
    Unfortunately, Django will not be able to find the package <code>hw1</code>
    unless we register the parent directory in <code>sys.path</code>:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">sys</span>
sys<span style="color: #666666">.</span>path<span style="color: #666666">.</span>insert(<span
            style="color: #666666">0</span>, relative2absolute_path(<span style="color: #BA2121">&#39;../../apps/django_apps&#39;</span>))
</pre>
</div>
<p>
    Note here that the relative path is given with respect to the
    location of the <code>settings.py</code> script.

<p>
    <b>Step 2: Add a template directory.</b>
    Make a subdirectory <code>templates</code> under <code>hw1</code>,

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; mkdir templates
</pre>
</div>
<p>
    and add the absolute path of this directory to the <code>TEMPLATE_DIRS</code> tuple:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">TEMPLATE_DIRS <span
        style="color: #666666">=</span> (
    relative2absolute_path(<span style="color: #BA2121">&#39;../../apps/django_apps/hw1/templates&#39;</span>),
)
</pre>
</div>
<p>
    The <code>templates</code> directory will hold templates for the HTML code applied
    in the web interfaces. The trailing comma is important as this is
    a tuple with only one element.

<p>
    <b>Step 3: Define the URL.</b>
    We need to connect the Django app with
    an URL. Our app will be associated with a Python function <code>index</code>
    in the <code>views</code> module within the <code>hw1</code> package.
    Say we want the corresponding URL to
    be named <code>hw1</code> relative to the server URL.
    This information is registered in the <code>django_project/urls.py</code> file
    by the syntax

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">urlpatterns <span
        style="color: #666666">=</span> patterns(<span style="color: #BA2121">&#39;&#39;</span>,
    url(<span style="color: #BA2121">r&#39;^hw1/&#39;</span>, <span style="color: #BA2121">&#39;django_apps.hw1.views.index&#39;</span>),
</pre>
</div>
<p>
    The first argument to the <code>url</code> function is a regular expression for
    the URL and the second argument is the name of the function to call,
    using Python's syntax for a function <code>index</code> in a module <code>views</code> in
    a package <code>hw1</code>.
    The function name <code>index</code> resembles the <code>index.html</code> main page associated
    with an URL, but any other name than <code>index</code> can be used.

<p>
    <!-- !split -->

<h2 id="___sec19">Programming the Django application </h2>

<p>
    The Django application is about filling the files <code>views.py</code> and <code>models.py</code>
    with content. The mathematical computations are performed in <code>compute.py</code>
    so we copy this file from the <code>mvc</code> directory to the <code>hw1</code> directory
    for convenience (we could alternatively add <code>../mvc</code> to <code>sys.path</code> such that
    <code>import compute</code> would work from the <code>hw1</code> directory).

<h3 id="___sec20">The user interaction </h3>

<p>
    The web application offers a text field where the user can
    write the value of <code>r</code>, see Figure <a href="#wf:hw1:django:fig:input">4</a>.
    After clicking on the <em>equals</em> button,
    the mathematics is performed and a new page as
    seen in Figure <a href="#wf:hw1:django:fig:result">5</a> appears.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 4: The input page.
<div id="wf:hw1:django:fig:input"></div>
</p></center>
<p><img src="fig-web4sa/hw1_django_input.png" align="bottom" width=600></p>
</center>

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 5: The result page.
<div id="wf:hw1:django:fig:result"></div>
</p></center>
<p><img src="fig-web4sa/hw1_django_output.png" align="bottom" width=600></p>
</center>

<h3 id="___sec21">The model </h3>

<p>
    The <code>models.py</code> file contains the model, which consists
    of the data we need in the application, stored in Django's data types.
    Our data consists of one number, called <code>r</code>, and <code>models.py</code> then
    look like

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">django.db</span> <span style="color: #008000; font-weight: bold">import</span> models
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">django.forms</span> <span
            style="color: #008000; font-weight: bold">import</span> ModelForm

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Input</span>(models<span style="color: #666666">.</span>Model):
    r <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField()

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(ModelForm):
    <span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Meta</span>:
        model <span style="color: #666666">=</span> Input
</pre>
</div>
<p>
    The <code>Input</code> class lists variables representing data as static class
    attributes. The <code>django.db.models</code> module contains various classes
    for different types of data, here we use <code>FloatField</code> to represent
    a floating-point number.
    The <code>InputForm</code> class has a the shown generic form across applications
    if we by convention apply the name <code>Input</code> for the class holding the data.

<h3 id="___sec22">The view </h3>

<p>
    The <code>views.py</code> file contains a function <code>index</code> which defines
    the actions we want to perform when invoking
    the URL ( here <code>http://127.0.0.1:8000/hw1/</code>).
    In addition, <code>views.py</code> has the <code>present_output</code> function from
    the <code>view.py</code> file in the <code>mvc</code> directory.

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">django.shortcuts</span> <span
        style="color: #008000; font-weight: bold">import</span> render_to_response
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">django.template</span> <span
            style="color: #008000; font-weight: bold">import</span> RequestContext
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">django.http</span> <span
            style="color: #008000; font-weight: bold">import</span> HttpResponse
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">models</span> <span style="color: #008000; font-weight: bold">import</span> InputForm
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>(request):
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span>:
        form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>POST)
        <span style="color: #008000; font-weight: bold">if</span> form<span style="color: #666666">.</span>is_valid():
            form <span style="color: #666666">=</span> form<span style="color: #666666">.</span>save(commit<span
            style="color: #666666">=</span><span style="color: #008000">False</span>)
            <span style="color: #008000; font-weight: bold">return</span> present_output(form)
    <span style="color: #008000; font-weight: bold">else</span>:
        form <span style="color: #666666">=</span> InputForm()

    <span style="color: #008000; font-weight: bold">return</span> render_to_response(<span style="color: #BA2121">&#39;hw1.html&#39;</span>,
            {<span style="color: #BA2121">&#39;form&#39;</span>: form}, context_instance<span
            style="color: #666666">=</span>RequestContext(request))

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">present_output</span>(form):
    r <span style="color: #666666">=</span> form<span style="color: #666666">.</span>r
    s <span style="color: #666666">=</span> compute(r)
    <span style="color: #008000; font-weight: bold">return</span> HttpResponse(<span style="color: #BA2121">&#39;Hello, World! sin(</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">)=</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (r, s))
</pre>
</div>
<p>
    The <code>index</code> function deserves some explanation. It must take one
    argument, usually called <code>request</code>. There are two modes in the function. Either
    the user has provided input on the web page, which means that
    <code>request.method</code> equals <code>'POST'</code>, or we show a new web page
    with which the user is supposed to interact.

<h3 id="___sec23">Making the input page </h3>

<p>
    The input consists of a web form with
    one field where we can fill in our <code>r</code> variable. This page
    is realized by the two central statements

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #408080; font-style: italic"># Make info needed in the web form</span>
form <span style="color: #666666">=</span> InputForm()
<span style="color: #408080; font-style: italic"># Make HTML code</span>
render_to_response(<span style="color: #BA2121">&#39;hw1.html&#39;</span>,
    {<span style="color: #BA2121">&#39;form&#39;</span>: form}, context_instance<span style="color: #666666">=</span>RequestContext(request))
</pre>
</div>
<p>
    The <code>hw1.html</code> file resides in the <code>templates</code> subdirectory and contains
    a template for the HTML code:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">&quot;post&quot;</span> <span style="color: #7D9029">action=</span><span
        style="color: #BA2121">&quot;&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>{% csrf_token %}
    Hello, World! The sine of {{ form.r }}
    <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;equals&quot;</span> <span
            style="color: #008000; font-weight: bold">/&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
</pre>
</div>
<p>
    This is a <em>template file</em> because it contains instructions like
    <code>{% csrf_token %}</code> and variables like <code>{{ form.r }}</code>. Django will
    replace the former by some appropriate HTML statements, while the
    latter simply extracts the numerical value of the variable <code>r</code> in
    our form (specified in the <code>Input</code> class in <code>models.py</code>).
    Typically, this <code>hw1.html</code> file
    results in the HTML code

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">&quot;post&quot;</span> <span style="color: #7D9029">action=</span><span
        style="color: #BA2121">&quot;&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">style=</span><span
            style="color: #BA2121">&#39;display:none&#39;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&#39;hidden&#39;</span> <span style="color: #7D9029">name=</span><span
            style="color: #BA2121">&#39;csrfmiddlewaretoken&#39;</span>
<span style="color: #7D9029">value=</span><span style="color: #BA2121">&#39;oPWMuuy1gLlXm9GvUZINv49eVUYnux5Q&#39;</span> <span
            style="color: #008000; font-weight: bold">/&gt;&lt;/div&gt;</span>
    Hello, World! The sine of <span style="color: #008000; font-weight: bold">&lt;input</span> <span
            style="color: #7D9029">type=</span><span style="color: #BA2121">&quot;text&quot;</span> <span
            style="color: #7D9029">name=</span><span style="color: #BA2121">&quot;r&quot;</span> <span
            style="color: #7D9029">id=</span><span style="color: #BA2121">&quot;id_r&quot;</span> <span
            style="color: #008000; font-weight: bold">/&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;equals&quot;</span> <span
            style="color: #008000; font-weight: bold">/&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
</pre>
</div>

<h3 id="___sec24">Making the results page </h3>

<p>
    When then user has filled in a value in the text field on the input
    page, the <code>index</code> function is called again and <code>request.method</code> equals
    <code>'POST'</code>. A new form object is made, this time with user info (<code>request.POST</code>).
    We can check that the form is valid and if so, proceed with
    computations followed by presenting the results in a
    new web page (see Figure <a href="#wf:hw1:django:fig:result">5</a>):

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>(request):
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span>:
        form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>POST)
        <span style="color: #008000; font-weight: bold">if</span> form<span style="color: #666666">.</span>is_valid():
            form <span style="color: #666666">=</span> form<span style="color: #666666">.</span>save(commit<span
            style="color: #666666">=</span><span style="color: #008000">False</span>)
            <span style="color: #008000; font-weight: bold">return</span> present_output(form)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">present_output</span>(form):
    r <span style="color: #666666">=</span> form<span style="color: #666666">.</span>r
    s <span style="color: #666666">=</span> compute(r)
    <span style="color: #008000; font-weight: bold">return</span> HttpResponse(<span style="color: #BA2121">&#39;Hello, World! sin(</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">)=</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (r, s))
</pre>
</div>
<p>
    The numerical value of <code>r</code> as given by the user is available as <code>form.r</code>.
    Instead of using a template for the output page, which is natural to
    do in more advanced cases, we here illustrate the possibility to
    send raw HTML to the output page by returning an <code>HttpResponse</code>
    object initialized by a string containing the desired HTML code.

<p>
    Launch this application by filling in the address <code>http://127.0.0.1:8000/hw1/</code>
    in your web browser. Make sure the Django development server is running,
    and if not, restart it by

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python ../../../django_project/manage.py runserver
</pre>
</div>
<p>
    Fill
    in some number on the input page and view the output.
    To show how easy it is to change the application, invoke the <code>views.py</code>
    file in an editor and add some color to the output HTML code from
    the <code>present_output</code> function:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">    <span
        style="color: #008000; font-weight: bold">return</span> HttpResponse(<span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">&lt;font color=&#39;blue&#39;&gt;Hello&lt;/font&gt;, World!</span>
<span style="color: #BA2121">sin(</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">)=</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"></span>
<span style="color: #BA2121">&quot;&quot;&quot;</span><span style="color: #666666">%</span> (r, s))
</pre>
</div>
<p>
    Go back to the input page, provide a new number, and observe how
    the "Hello" word now has a blue color.

<h2 id="___sec25">Equipping the input page with output results </h2>

<p>
    Instead of making a separate output page with the result, we can
    simply add the sine value to the input page. This makes the user
    feel that she interacts with the same page, as when operating a calculator.
    The output page should then look as shown in Figure <a href="#wf:hw2:django:fig:result">6</a>.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 6: The modified result page.
<div id="wf:hw2:django:fig:result"></div>
</p></center>
<p><img src="fig-web4sa/hw2_django_output.png" align="bottom" width=600></p>
</center>

<p>
    We need to make a new Django application, now called
    <a href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/django_apps/hw2"
       target="_self"><tt>hw2</tt></a>.
    Instead of running the standard
    <code>manage.py startapp hw2</code> command,
    we can simply copy the <code>hw1</code>
    directory to <code>hw2</code>. We need, of course, to add information about this
    new application in <code>settings.py</code> and <code>urls.py</code>.
    In the former file we must have

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">TEMPLATE_DIRS <span
        style="color: #666666">=</span> (
    relative2absolute_path(<span style="color: #BA2121">&#39;../../apps/django_apps/hw1/templates&#39;</span>),
    relative2absolute_path(<span style="color: #BA2121">&#39;../../apps/django_apps/hw2/templates&#39;</span>),
)

INSTALLED_APPS <span style="color: #666666">=</span> (
    <span style="color: #BA2121">&#39;django.contrib.auth&#39;</span>,
    <span style="color: #BA2121">&#39;django.contrib.contenttypes&#39;</span>,
    <span style="color: #BA2121">&#39;django.contrib.sessions&#39;</span>,
    <span style="color: #BA2121">&#39;django.contrib.sites&#39;</span>,
    <span style="color: #BA2121">&#39;django.contrib.messages&#39;</span>,
    <span style="color: #BA2121">&#39;django.contrib.staticfiles&#39;</span>,
    <span style="color: #408080; font-style: italic"># Uncomment the next line to enable the admin:</span>
    <span style="color: #408080; font-style: italic"># &#39;django.contrib.admin&#39;,</span>
    <span style="color: #408080; font-style: italic"># Uncomment the next line to enable admin documentation:</span>
    <span style="color: #408080; font-style: italic"># &#39;django.contrib.admindocs&#39;,</span>
    <span style="color: #BA2121">&#39;hw1&#39;</span>,
    <span style="color: #BA2121">&#39;hw2&#39;</span>,
)
</pre>
</div>
<p>
    In <code>urls.py</code> we add the URL <code>hw2</code> which is to call our <code>index</code> function
    in the <code>views.py</code> file of the <code>hw2</code> app:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">urlpatterns <span
        style="color: #666666">=</span> patterns(<span style="color: #BA2121">&#39;&#39;</span>,
    url(<span style="color: #BA2121">r&#39;^hw1/&#39;</span>, <span style="color: #BA2121">&#39;django_apps.hw1.views.index&#39;</span>),
    url(<span style="color: #BA2121">r&#39;^hw2/&#39;</span>, <span style="color: #BA2121">&#39;django_apps.hw2.views.index&#39;</span>),
</pre>
</div>
<p>
    The <code>views.py</code> file changes a bit since we shall generate almost the same
    web page on input and output. This makes the <code>present_output</code> function
    unnatural, and everything is done within the <code>index</code> function:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>(request):
    s <span style="color: #666666">=</span> <span style="color: #008000">None</span>  <span
            style="color: #408080; font-style: italic"># initial value of result</span>
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span>:
        form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>POST)
        <span style="color: #008000; font-weight: bold">if</span> form<span style="color: #666666">.</span>is_valid():
            form <span style="color: #666666">=</span> form<span style="color: #666666">.</span>save(commit<span
            style="color: #666666">=</span><span style="color: #008000">False</span>)
            r <span style="color: #666666">=</span> form<span style="color: #666666">.</span>r
            s <span style="color: #666666">=</span> compute(r)
    <span style="color: #008000; font-weight: bold">else</span>:
        form <span style="color: #666666">=</span> InputForm()

    <span style="color: #008000; font-weight: bold">return</span> render_to_response(<span style="color: #BA2121">&#39;hw2.html&#39;</span>,
            {<span style="color: #BA2121">&#39;form&#39;</span>: form,
             <span style="color: #BA2121">&#39;s&#39;</span>: <span style="color: #BA2121">&#39;</span><span
            style="color: #BB6688; font-weight: bold">%.5f</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> s <span style="color: #008000; font-weight: bold">if</span> <span
            style="color: #008000">isinstance</span>(s, <span style="color: #008000">float</span>) <span
            style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&#39;&#39;</span>
             }, context_instance<span style="color: #666666">=</span>RequestContext(request))
</pre>
</div>
<p>
    Note that the output variable <code>s</code> is computed within the <code>index</code>
    function and defaults to <code>None</code>. The template file <code>hw2.html</code>
    looks like

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">&quot;post&quot;</span> <span style="color: #7D9029">action=</span><span
        style="color: #BA2121">&quot;&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>{% csrf_token %}
    Hello, World! The sine of {{ form.r }}
    <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;equals&quot;</span> <span
            style="color: #008000; font-weight: bold">/&gt;</span>
{% if s != &#39;&#39; %}
{{ s }}
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
</pre>
</div>
<p>
    The difference from <code>hw1.html</code> is that we right after the <em>equals</em>
    button write out the value of <code>s</code>. However, we make a test that
    the value is only written if it is computed, here recognized by
    being a non-empty string. The <code>s</code> in the template file
    is substituted by the value of the object
    corresponding to the key <code>'s'</code> in the
    dictionary we pass to the <code>render_to_response</code>. As seen,
    we pass a string where <code>s</code> is formatted with five digits if <code>s</code>
    is a float, i.e., if <code>s</code> is computed. Otherwise, <code>s</code> has the
    default value <code>None</code> and we send an empty string to the template.
    The template language allows tests using Python syntax, but the
    if-block must be explicitly ended by <code>{% endif %}</code>.

<p>
    <!-- !split -->

<h1 id="wf:vib:flask">Handling multiple input variables in Flask</h1>

<p>
    The scientific hello world example shows how to work with one input
    variable and one output variable. We can easily derive an extensible
    recipe for apps with a collection of input variables and some
    associated HTML code as result. Multiple input variables are listed
    in the <code>InputForm</code> class using different types for different forms
    (text field, float field, integer field, check box field for boolean
    values, etc.). The value of these variables will be available in a
    <code>form</code> object for computation. It is then a matter of setting
    up a template code where the various variables if the <code>form</code> object
    are formatted in HTML code as desired.

<p>
    Our sample web application
    addresses the task of plotting the function \( u(t)=Ae^{-bt}\sin (wt) \) for
    \( t\in [0,T] \). The web application must have fields for the numbers \( A \),
    \( b \), \( w \), and \( T \), and a <em>Compute</em> button, as shown in Figure
    <a href="#wf:vib1:flask:fig:input">7</a>. Filling in values, say \( 0.1 \) for \( b \) and
    \( 20 \) for \( T \), results in what we see in Figure <a href="#wf:vib1:flask:fig:result">8</a>,
    i.e., a plot of \( u(t) \) is added after the input fields and the <em>Compute</em>
    button.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 7: The input page.
<div id="wf:vib1:flask:fig:input"></div>
</p></center>
<p><img src="fig-web4sa/vib1_flask_input.png" align="bottom" width=500></p>
</center>

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 8: The result page.
<div id="wf:vib1:flask:fig:result"></div>
</p></center>
<p><img src="fig-web4sa/vib1_flask_output.png" align="bottom" width=700></p>
</center>

<p>
    We shall make a series of different versions of this app:

<ol>
    <li><code>vib1</code> for the basic set-up and illustration of tailoring the HTML code.</li>
    <li><code>vib2</code> for custom validation of input, governed by the programmer,
        and inlined graphics in the HTML code.
    </li>
    <li><code>vib3</code> for interactive Bokeh plots.</li>
    <li><code>gen</code> for automatic generation of the Flask app (!).</li>
    <li><code>login</code> for storing computed results in user accounts.</li>
    <li><code>upload</code> for uploading files to a web app.</li>
</ol>

<h2 id="wf:vib1:flask:app">Programming the Flask application</h2>

<p>
    The forthcoming text explains the necessary steps to realize a
    Flask app that behaves as depicted in Figures <a href="#wf:vib1:flask:fig:input">7</a>
    and <a href="#wf:vib1:flask:fig:result">8</a>. We start with the
    <code>compute.py</code> module since it contains only the computation of \( u(t) \)
    and the making of the plot, without any interaction with Flask.

<p>
    The files associated with this app are found in the <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib1"
        target="_self"><tt>vib1</tt></a> directory.

<h3 id="___sec28">The compute part </h3>

<p>
    More specifically, inside <code>compute.py</code>, we have a function for
    evaluating \( u(t) \) and a <code>compute</code> function for making the plot. The
    return value of the latter is the name of the plot file, which should
    get a unique name every time the <code>compute</code> function is called such
    that the browser cannot reuse an already cached image when displaying
    the plot. Flask
    applications must have all extra files (CSS, images, etc.) in a
    subdirectory <code>static</code>.

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">numpy</span> <span
        style="color: #008000; font-weight: bold">import</span> exp, cos, linspace
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span
            style="color: #0000FF; font-weight: bold">time</span><span style="color: #666666">,</span> <span
            style="color: #0000FF; font-weight: bold">glob</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">damped_vibrations</span>(t, A, b, w):
    <span style="color: #008000; font-weight: bold">return</span> A<span style="color: #666666">*</span>exp(<span
            style="color: #666666">-</span>b<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>cos(w<span
            style="color: #666666">*</span>t)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute</span>(A, b, w, T, resolution<span
            style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, resolution<span
            style="color: #666666">+1</span>)
    u <span style="color: #666666">=</span> damped_vibrations(t, A, b, w)
    plt<span style="color: #666666">.</span>figure()  <span style="color: #408080; font-style: italic"># needed to avoid adding curves in plot</span>
    plt<span style="color: #666666">.</span>plot(t, u)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;A=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, b=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, w=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (A, b, w))
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>isdir(<span style="color: #BA2121">&#39;static&#39;</span>):
        os<span style="color: #666666">.</span>mkdir(<span style="color: #BA2121">&#39;static&#39;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Remove old plot files</span>
        <span style="color: #008000; font-weight: bold">for</span> filename <span
            style="color: #AA22FF; font-weight: bold">in</span> glob<span style="color: #666666">.</span>glob(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #BA2121">&#39;*.png&#39;</span>)):
            os<span style="color: #666666">.</span>remove(filename)
    <span style="color: #408080; font-style: italic"># Use time since Jan 1, 1970 in filename in order make</span>
    <span style="color: #408080; font-style: italic"># a unique filename that the browser has not chached</span>
    plotfile <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #008000">str</span>(time<span style="color: #666666">.</span>time()) <span
            style="color: #666666">+</span> <span style="color: #BA2121">&#39;.png&#39;</span>)
    plt<span style="color: #666666">.</span>savefig(plotfile)
    <span style="color: #008000; font-weight: bold">return</span> plotfile

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">print</span> compute(<span style="color: #666666">1</span>, <span
            style="color: #666666">0.1</span>, <span style="color: #666666">1</span>, <span
            style="color: #666666">20</span>)
</pre>
</div>
<p>
    <div class="alert alert-block alert-warning alert-text-normal">
        <b>Avoid file writing.</b>
<p>
    It is in general not a good idea to write plots to file or let a
    web app write to file. If this app is deployed at some web site and
    multiple users are running the app, the <code>os.remove</code> statements may remove
    plots created by all other users. However, the app is useful as a
    graphical user interface run locally on a machine.
    Later, we shall avoid writing plot files and instead
    store plots in strings and embed the strings
    in the <code>img</code> tag in the HTML code.
    </div>


<p>
    We organize the model, view, and controller as three separate
    files, as illustrated in
    the section <a href="#wf:hw3:flask">Splitting the app into model, view, and controller files</a>. This more
    complicated app involves
    more code and especially the model will soon be handy to isolate in its own
    file.

<h3 id="___sec29">The model </h3>

<p>
    Our first version of <code>model.py</code> reads

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">wtforms</span> <span
        style="color: #008000; font-weight: bold">import</span> Form, FloatField, validators
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
            style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(Form):
    A <span style="color: #666666">=</span> FloatField(
        label<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;amplitude (m)&#39;</span>, default<span style="color: #666666">=1.0</span>,
        validators<span style="color: #666666">=</span>[validators<span style="color: #666666">.</span>InputRequired()])
    b <span style="color: #666666">=</span> FloatField(
        label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;damping factor (kg/s)&#39;</span>, default<span
            style="color: #666666">=0</span>,
        validators<span style="color: #666666">=</span>[validators<span style="color: #666666">.</span>InputRequired()])
    w <span style="color: #666666">=</span> FloatField(
        label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;frequency (1/s)&#39;</span>, default<span
            style="color: #666666">=2*</span>pi,
        validators<span style="color: #666666">=</span>[validators<span style="color: #666666">.</span>InputRequired()])
    T <span style="color: #666666">=</span> FloatField(
        label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;time interval (s)&#39;</span>, default<span
            style="color: #666666">=18</span>,
        validators<span style="color: #666666">=</span>[validators<span style="color: #666666">.</span>InputRequired()])
</pre>
</div>
<p>
    As seen, the field classes can take a <code>label</code> argument for a longer
    description, here also including the units in which the variable is
    measured. It is also possible to add a <code>description</code> argument with
    some help message. Furthermore, we include a <code>default</code> value, which
    will appear in the text field such that the user does not need to
    fill in all values.

<h3 id="___sec30">The view </h3>

<p>
    The view component will of course make use of templates, and we shall experiment
    with different templates. Therefore, we allow a command-line argument
    to this Flask app for choosing which template we want. The rest of
    the <code>controller.py</code> file follows much the same set up as for the scientific
    hello world app:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">model</span> <span
        style="color: #008000; font-weight: bold">import</span> InputForm
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask</span> <span
            style="color: #008000; font-weight: bold">import</span> Flask, render_template, request
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute

app <span style="color: #666666">=</span> Flask(__name__)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/vib1&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        result <span style="color: #666666">=</span> compute(form<span style="color: #666666">.</span>A<span
            style="color: #666666">.</span>data, form<span style="color: #666666">.</span>b<span style="color: #666666">.</span>data,
                         form<span style="color: #666666">.</span>w<span style="color: #666666">.</span>data, form<span
            style="color: #666666">.</span>T<span style="color: #666666">.</span>data)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>

    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&#39;view.html&#39;</span>, form<span
            style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>

<h3 id="___sec31">The HTML template </h3>

<p>
    The details governing how the web page really looks like lie in the
    template file. Since we have several fields and want them nicely
    align in a tabular fashion, we place the field name, text areas,
    and labels inside an HTML table in our first attempt to write a
    template, <code>view_plain.html</code>:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td&gt;</span>{{ field }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Compute</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;500&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
</pre>
</div>
<p>
    Observe how easy it is to iterate over the <code>form</code> object and grab data
    for each field: <code>field.name</code> is the name of the variable in the
    <code>InputForm</code> class, <code>field.label</code> is the full name with units as given
    through the <code>label</code> keyword when constructing the field object, and
    writing the field object itself generates the text area for
    input (i.e., the HTML input form). The control statements we can
    use in the template are part of the <a href="http://jinja.pocoo.org/docs/" target="_self">Jinja2</a>
    templating language. For now, the if-test, for-loop and
    output of values (<code>{{ object }}</code>) are enough to generate the HTML
    code we want.

<p>
    Recall that the objects we need in the template, like <code>result</code> and <code>form</code>
    in the present case, are transferred to the template via keyword
    arguments to the <code>render_template</code> function. We can easily pass on
    any object in our application to the template. Debugging of the template
    is done by viewing the HTML source of the web page in the browser.

<p>
    You are encouraged to go to the <code>vib1</code> directory,
    run <code>python controller.py</code>, and load

<p>

    <!-- code=text typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">`http://127.0.0.1:5000/vib1`
</pre>
</div>
<p>
    into your web browser for testing.

<p>
    <!-- !split -->

<h2 id="___sec32">Implementing error checking in the template </h2>

<p>
    What happens if the user gives wrong input, for instance the letters <code>asd</code>
    instead of a number? Actually nothing! The <code>FloatField</code> object
    checks that the input is compatible with a real number in the
    <code>form.validate()</code> call, but returns just <code>False</code> if this is not
    the case. Looking at the code in <code>controller.py</code>,

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        result <span style="color: #666666">=</span> compute(form<span style="color: #666666">.</span>A<span
            style="color: #666666">.</span>data, form<span style="color: #666666">.</span>b<span style="color: #666666">.</span>data,
                         form<span style="color: #666666">.</span>w<span style="color: #666666">.</span>data, form<span
            style="color: #666666">.</span>T<span style="color: #666666">.</span>data)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
</pre>
</div>
<p>
    we realize that wrong input implies <code>result = None</code> and no computations
    and no plot! Fortunately, each field object gets an attribute <code>error</code>
    with information on errors that occur on input. We can write out
    this information on the web page, as exemplified in the template
    <code>view_errcheck.html</code>:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    {% if field.errors %}
      <span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;ul</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
      {% for error in field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;li&gt;&lt;font</span> <span
            style="color: #7D9029">color=</span><span style="color: #BA2121">&quot;red&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Compute</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;500&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
</pre>
</div>
<p>
    Two things are worth noticing here:

<ol>
    <li> We can control the width of the text field where the
        user writes the numbers, here set to 12 characters.
    </li>
    <li> We can make an extra column in the HTML table with a list
        of possible errors for each field object.
    </li>
</ol>

Let us test the error handling of the <code>A</code> field by
writing <code>asd</code> instead of a number. This input
triggers an error, whose message is written in red to the right of the label,
see Figure <a href="#wf:vib1:flask:fig:error1">9</a>.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 9: Error message because of wrong input.
<div id="wf:vib1:flask:fig:error1"></div>
</p></center>
<p><img src="fig-web4sa/vib1_flask_error1.png" align="bottom" width=500></p>
</center>

<p>
    It is possible to use the additional HTML5 fields for input in a Flask
    context. Instead of explaining how here, we recommend to use the
    <a href="https://github.com/hplgit/parampool" target="_self">Parampool</a>
    package to automatically generate Flask files with HTML5 fields.

<p>
    <!-- !split -->

<h2 id="___sec33">Using style sheets </h2>

<p>
    Web developers make heavy use of CSS style sheets to control the look
    and feel of web pages. Templates can utilize style sheets as any other
    standard HTML code. Here is a very simple example where we introduce
    a class <code>name</code> for the HTML table's column with the field name and set the
    foreground color of the text in this column to blue.
    The style sheet is called <code>basic.css</code> and <em>must</em> reside in the
    <code>static</code> subdirectory of the Flask application directory. The content
    of <code>basic.css</code> is just the line

<p>

    <!-- code=text (!bc txt) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">td.name { color: blue; }
</pre>
</div>
<p>
    The <code>view_css.html</code> file using this style sheet features a <code>link</code> tag
    to the style sheet in the HTML header, and the column containing
    the field name has
    the HTML tag <code>&lt;td class=&quot;name&quot;&gt;</code> to trigger the specification in
    the style sheet:

<p>

    <!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;head&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;link</span> <span style="color: #7D9029">rel=</span><span
            style="color: #BA2121">&quot;stylesheet&quot;</span> <span style="color: #7D9029">href=</span><span
            style="color: #BA2121">&quot;static/basic.css&quot;</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/css&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/head&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;body&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;name&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field(size=12) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
</pre>
</div>
<p>
    Just run <code>python controller.py view_css</code> to see that the names
    of the variables to set in the web page are blue.

<p>
    <!-- !split -->

<h2 id="___sec34">Using LaTeX mathematics </h2>

<p>
    Scientific applications frequently have many input data that are
    defined through mathematics and where the typesetting on the
    web page should be as close as possible to the typesetting where
    the mathematics is documented. In the present example we would like
    to typeset \( A \), \( b \), \( w \), and \( T \) with italic font as done
    in LaTeX. Fortunately, native LaTeX typesetting is available in
    HTML through the tool <a href="http://www.mathjax.org/" target="_self">MathJax</a>.
    Our template <code>view_tex.html</code> enables MathJax. Formulas are written
    with standard LaTeX inside <code>\(</code> and <code>\)</code>, while equations are surrounded
    by <code>$$</code>. Here we use formulas only:

<p>

    <!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
        style="color: #BA2121">&quot;text/x-mathjax-config&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
MathJax.Hub.Config({
  TeX<span style="color: #666666">:</span> {
     equationNumbers<span style="color: #666666">:</span> {  autoNumber<span style="color: #666666">:</span> <span
            style="color: #BA2121">&quot;AMS&quot;</span>  },
     extensions<span style="color: #666666">:</span> [<span style="color: #BA2121">&quot;AMSmath.js&quot;</span>, <span
            style="color: #BA2121">&quot;AMSsymbols.js&quot;</span>, <span style="color: #BA2121">&quot;autobold.js&quot;</span>, <span
            style="color: #BA2121">&quot;color.js&quot;</span>]
  }
});
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/javascript&quot;</span>
 <span style="color: #7D9029">src=</span><span style="color: #BA2121">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>\( {{ field.name }} \)<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
</pre>
</div>
<p>
    Figure <a href="#wf:vib1:flask:fig:latex">10</a> displays how the
    LaTeX rendering looks like in the browser.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 10: LaTeX typesetting of mathematical symbols.
<div id="wf:vib1:flask:fig:latex"></div>
</p></center>
<p><img src="fig-web4sa/vib1_flask_latex.png" align="bottom" width=650></p>
</center>

<p>
    <!-- !split -->

<h2 id="___sec35">Rearranging the elements in the HTML template </h2>

<p>
    Now we want to place the plot to the right of the input forms in
    the web page, see Figure <a href="#wf:vib1:flask:fig:sidebyside">11</a>. This can
    be accomplished by having an outer table with two rows. The first
    row contains the table with the input forms in the first column and
    the plot in the second column, while the second row features the
    <em>Compute</em> button in the first column.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 11: New design with input and output side by side.
<div id="wf:vib1:flask:fig:sidebyside"></div>
</p></center>
<p><img src="fig-web4sa/vib1_flask_table2.png" align="bottom" width=700></p>
</center>

<p>
    The enabling template file is <code>view_table.html</code>:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
        style="color: #BA2121">&quot;text/x-mathjax-config&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
MathJax.Hub.Config({
  TeX<span style="color: #666666">:</span> {
     equationNumbers<span style="color: #666666">:</span> {  autoNumber<span style="color: #666666">:</span> <span
            style="color: #BA2121">&quot;AMS&quot;</span>  },
     extensions<span style="color: #666666">:</span> [<span style="color: #BA2121">&quot;AMSmath.js&quot;</span>, <span
            style="color: #BA2121">&quot;AMSsymbols.js&quot;</span>, <span style="color: #BA2121">&quot;autobold.js&quot;</span>]
  }
});
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/javascript&quot;</span>
 <span style="color: #7D9029">src=</span><span style="color: #BA2121">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span> <span style="color: #408080; font-style: italic">&lt;!-- table with forms to the left and plot to the right --&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>\( {{ field.name }} \)<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    {% if field.errors %}
      <span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;ul</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
      {% for error in field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;li&gt;&lt;font</span> <span
            style="color: #7D9029">color=</span><span style="color: #BA2121">&quot;red&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/td&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;500&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;p&gt;&lt;input</span> <span
            style="color: #7D9029">type=</span><span style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">Compute</span><span style="color: #008000; font-weight: bold">&gt;&lt;/p&gt;&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
</pre>
</div>
<p>
    <!-- !split -->

<h2 id="___sec36">Bootstrap HTML style </h2>

<p>
    The <a href="http://getbootstrap.com/" target="_self">Bootstrap</a> framework for creating web pages
    has been very popular in recent years, both because of the design and
    the automatic support for responsive pages on all sorts of devices.
    Bootstrap can easily be used in combination with Flask. The template file
    <code>view_bootstrap.html</code> is identical to the former <code>view_table.html</code>,
    except that we load the Bootstrap CSS file and include in comments
    how to add the typical navigation bar found in many Bootstrap-based
    web pages. Moreover, we use the grid layout functionality of Bootstrap
    to control the placement of elements (name, input field, label,
    and error message) in the input form.

<p>
    The template looks like

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;html</span> <span style="color: #7D9029">lang=</span><span
            style="color: #BA2121">&quot;en&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>


<span style="color: #008000; font-weight: bold">&lt;link</span> <span style="color: #7D9029">href=</span>
<span style="color: #BA2121">&quot;http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css&quot;</span>
<span style="color: #7D9029">rel=</span><span style="color: #BA2121">&quot;stylesheet&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/x-mathjax-config&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
MathJax.Hub.Config({
  TeX<span style="color: #666666">:</span> {
     equationNumbers<span style="color: #666666">:</span> {  autoNumber<span style="color: #666666">:</span> <span
            style="color: #BA2121">&quot;AMS&quot;</span>  },
     extensions<span style="color: #666666">:</span> [<span style="color: #BA2121">&quot;AMSmath.js&quot;</span>, <span
            style="color: #BA2121">&quot;AMSsymbols.js&quot;</span>, <span style="color: #BA2121">&quot;autobold.js&quot;</span>, <span
            style="color: #BA2121">&quot;color.js&quot;</span>]
  }
});
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src=</span>
<span style="color: #BA2121">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #408080; font-style: italic">&lt;!--</span>
<span style="color: #408080; font-style: italic">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</span>
<span style="color: #408080; font-style: italic">&lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;bs-example-navbar-collapse-1&quot;&gt;</span>
<span style="color: #408080; font-style: italic">    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span>
<span style="color: #408080; font-style: italic">       {% for text, url in some_sequence %}</span>
<span style="color: #408080; font-style: italic">       &lt;li&gt;&lt;a href=&quot;/{{url}}&quot;&gt;{{ text }}&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #408080; font-style: italic">       {% endfor %}</span>
<span style="color: #408080; font-style: italic">       &lt;/ul&gt;</span>
<span style="color: #408080; font-style: italic">&lt;/div&gt;</span>
<span style="color: #408080; font-style: italic">&lt;/nav&gt;</span>
<span style="color: #408080; font-style: italic">--&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Damped sine wave<span
            style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;navbar-form navbar-top&quot;</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">&quot;post&quot;</span> <span style="color: #7D9029">action=</span><span
            style="color: #BA2121">&quot;&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;form-group&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;row&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
     <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;input-group&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;label</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-xs-1 control-label&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;span</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;input-group-addon&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span> \( {{ field.name }} \) <span
            style="color: #008000; font-weight: bold">&lt;/span&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/label&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-xs-2&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      {{ field(class_=&quot;form-control&quot;) }}
      <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-xs-3&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
        {{ field.label }}
      <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
      {% if field.errors %}
        {% for error in field.errors %}
          <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-xs-3&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;div</span> <span
            style="color: #7D9029">style=</span><span style="color: #BA2121">&quot;color: red;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
        {% endfor %}
      {% endif %}
     <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;br/&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;Compute&quot;</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;btn btn-default&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;400&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
</pre>
</div>
<p>
    The input fields and fonts now get the typical Bootstrap look and feel:

<p>
    <center>
<p><img src="fig-web4sa/vib1_flask_bootstrap.png" align="bottom" width=800></p></center>

<p>
    The only special feature in this template is the need to pass a CSS
    class <code>form-control</code> to the field object in the part that defines
    the input field. We also use the standard <code>input-group-addon</code> style
    in the name part of the Bootstrap form. A heading <em>Damped sine wave</em> was
    added to demonstrate the Bootstrap fonts.

<p>
    It is easy to switch to other Bootstrap styles, e.g., those in the
    "Bootswatch family": "http:bootswatch.com":

<p>

    <!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;link</span> <span style="color: #7D9029">href=</span>
<span style="color: #BA2121">&quot;http://netdna.bootstrapcdn.com/bootswatch/3.1.1/X/bootstrap.min.css&quot;</span>
<span style="color: #7D9029">rel=</span><span style="color: #BA2121">&quot;stylesheet&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
</pre>
</div>
<p>
    where <code>X</code> can be <code>journal</code>, <code>cosmo</code>, <code>flatly</code>, and other legal
    Bootswatch styles. The journal style looks like this:

<p>
    <center>
<p><img src="fig-web4sa/vib1_flask_bootswatch_journal.png" align="bottom" width=800></p></center>

<p>
    While <code>view_bootstrap.html</code> makes use of plain Bootstrap HTML code, there is
    also a higher-level framework, called <a href="http://pythonhosted.org/Flask-Bootstrap/" target="_self">Flask-Bootstrap</a>
    that combines Flask and Bootstrap. Installation of
    this extension is done by <code>sudo pip install flask-bootstrap</code>.

<p>
    After <code>app = Flask(__name__)</code> we need to do

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask_bootstrap</span> <span
        style="color: #008000; font-weight: bold">import</span> Bootstrap
Bootstrap(app)
</pre>
</div>
<p>
    We introduce a command-line argument to control whether we want the
    plain view or the Bootstrap view. The complete <code>controller.py</code> file
    then looks like

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">model</span> <span
        style="color: #008000; font-weight: bold">import</span> InputForm
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask</span> <span
            style="color: #008000; font-weight: bold">import</span> Flask, render_template, request
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

app <span style="color: #666666">=</span> Flask(__name__)

<span style="color: #008000; font-weight: bold">try</span>:
    template_name <span style="color: #666666">=</span> sys<span style="color: #666666">.</span>argv[<span
            style="color: #666666">1</span>]
<span style="color: #008000; font-weight: bold">except</span> <span
            style="color: #D2413A; font-weight: bold">IndexError</span>:
    template_name <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;view_plain&#39;</span>

<span style="color: #008000; font-weight: bold">if</span> template_name <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;view_flask_bootstrap&#39;</span>:
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask_bootstrap</span> <span
            style="color: #008000; font-weight: bold">import</span> Bootstrap
    Bootstrap(app)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/vib1&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        result <span style="color: #666666">=</span> compute(form<span style="color: #666666">.</span>A<span
            style="color: #666666">.</span>data, form<span style="color: #666666">.</span>b<span style="color: #666666">.</span>data,
                         form<span style="color: #666666">.</span>w<span style="color: #666666">.</span>data, form<span
            style="color: #666666">.</span>T<span style="color: #666666">.</span>data)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>

    <span style="color: #008000; font-weight: bold">return</span> render_template(template_name <span
            style="color: #666666">+</span> <span style="color: #BA2121">&#39;.html&#39;</span>,
                           form<span style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>
<p>
    The template employs new keywords <code>extends</code> and <code>block</code>:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">{% extends &quot;bootstrap/base.html&quot; %}

{% block styles %}
{{super()}}
<span style="color: #008000; font-weight: bold">&lt;style&gt;</span>
    <span style="color: #0000FF; font-weight: bold">.appsize</span> { <span style="color: #008000; font-weight: bold">width</span><span
            style="color: #666666">:</span> <span style="color: #666666">800px</span> }
<span style="color: #008000; font-weight: bold">&lt;/style&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/x-mathjax-config&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
MathJax.Hub.Config({
  TeX<span style="color: #666666">:</span> {
     equationNumbers<span style="color: #666666">:</span> {  autoNumber<span style="color: #666666">:</span> <span
            style="color: #BA2121">&quot;AMS&quot;</span>  },
     extensions<span style="color: #666666">:</span> [<span style="color: #BA2121">&quot;AMSmath.js&quot;</span>, <span
            style="color: #BA2121">&quot;AMSsymbols.js&quot;</span>, <span style="color: #BA2121">&quot;autobold.js&quot;</span>, <span
            style="color: #BA2121">&quot;color.js&quot;</span>]
  }
});
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src=</span>
<span style="color: #BA2121">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
{% endblock %}

<span style="color: #408080; font-style: italic">&lt;!--</span>
<span style="color: #408080; font-style: italic">{% block navbar %}</span>
<span style="color: #408080; font-style: italic">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</span>
<span style="color: #408080; font-style: italic">&lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;bs-example-navbar-collapse-1&quot;&gt;</span>
<span style="color: #408080; font-style: italic">    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span>
<span style="color: #408080; font-style: italic">       {% for f in some_sequence %}</span>
<span style="color: #408080; font-style: italic">       &lt;li&gt;&lt;a href=&quot;/{{f}}&quot;&gt;{{f}}&lt;/a&gt;&lt;/li&gt;</span>
<span style="color: #408080; font-style: italic">       {% endfor %}</span>
<span style="color: #408080; font-style: italic">       &lt;/ul&gt;</span>
<span style="color: #408080; font-style: italic">&lt;/div&gt;</span>
<span style="color: #408080; font-style: italic">&lt;/nav&gt;</span>
<span style="color: #408080; font-style: italic">{% endblock %}</span>
<span style="color: #408080; font-style: italic">--&gt;</span>

{% block content %}

<span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Damped sine wave<span
            style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;navbar-form navbar-top&quot;</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">&quot;post&quot;</span> <span style="color: #7D9029">action=</span><span
            style="color: #BA2121">&quot;&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;form-group&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;row&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
     <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;input-group appsize&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;label</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-sm-1 control-label&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;span</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;input-group-addon&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span> \( {{ field.name }} \) <span
            style="color: #008000; font-weight: bold">&lt;/span&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/label&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-sm-4&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      {{ field(class_=&quot;form-control&quot;) }}
      <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-sm-4&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
        {{ field.label }}
      <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
      {% if field.errors %}
        {% for error in field.errors %}
          <span style="color: #008000; font-weight: bold">&lt;div</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;col-sm-3&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;div</span> <span
            style="color: #7D9029">style=</span><span style="color: #BA2121">&quot;color: red;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
        {% endfor %}
      {% endif %}
     <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/div&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;br/&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;Compute&quot;</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;btn btn-default&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;500&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
{% endblock %}
</pre>
</div>
<p>
    It is important to have the MathJax script declaration and all styles within
    <code>{% block styles %}</code>.

<p>
    It seems easier to apply plain Bootstrap HTML code than the
    functionality in the Flask-Bootstrap layer.

<p>
    <!-- !split -->

<h2 id="wf:vib1:flask:validation">Custom validation</h2>

<p>
    The <code>FloatField</code> objects can check that the input is compatible with
    a number, but what if we want to control that \( A>0 \), \( b>0 \), and
    \( T \) is not greater than 30 periods (otherwise the plot gets cluttered)?
    We can write functions for checking appropriate conditions and
    supply the function to the list of validator functions in the call to
    the <code>FloatField</code> constructor or other field constructors. The extra
    code is a part of the <code>model.py</code> and the presented extensions appear
    in the directory <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib2"
        target="_self"><tt>vib2</tt></a>.

<h3 id="___sec38">Using Flask validators </h3>

<p>
    The simplest approach to validation is to use existing functionality
    in the web framework. Checking that \( A>0 \) can be done by
    the <code>NumberRange</code> validator which checks that the value is inside
    a prescribed interval:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">wtforms</span> <span
        style="color: #008000; font-weight: bold">import</span> Form, FloatField, validators

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(Form):
    A <span style="color: #666666">=</span> FloatField(
        label<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;amplitude (m)&#39;</span>, default<span style="color: #666666">=1.0</span>,
        validators<span style="color: #666666">=</span>[validators<span style="color: #666666">.</span>NumberRange(<span
            style="color: #666666">0</span>, <span style="color: #666666">1E+20</span>)])
</pre>
</div>

<h3 id="___sec39">Tailored validation </h3>

<p>
    We can also easily provide our own more tailored validators.
    As an example, let us explain how we can check that \( T \) is less than 30 periods.
    One period is \( 2\pi /w \) so we need to check if \( T> 30\cdot 2\pi/w \)
    and raise an exception in that case.
    A validation function takes two arguments: the whole <code>form</code> and the
    specific <code>field</code> to test:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">check_T</span>(form, field):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Form validation: failure if T &gt; 30 periods.&quot;&quot;&quot;</span>
    w <span style="color: #666666">=</span> form<span style="color: #666666">.</span>w<span
            style="color: #666666">.</span>data
    T <span style="color: #666666">=</span> field<span style="color: #666666">.</span>data
    period <span style="color: #666666">=</span> <span style="color: #666666">2*</span>pi<span
            style="color: #666666">/</span>w
    <span style="color: #008000; font-weight: bold">if</span> T <span style="color: #666666">&gt;</span> <span
            style="color: #666666">30*</span>period:
        num_periods <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span
            style="color: #008000">round</span>(T<span style="color: #666666">/</span>period))
        <span style="color: #008000; font-weight: bold">raise</span> validators<span style="color: #666666">.</span>ValidationError(
            <span style="color: #BA2121">&#39;Cannot plot as much as </span><span
            style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BA2121"> periods! T&lt;</span><span
            style="color: #BB6688; font-weight: bold">%.2f</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span>
            (num_periods, <span style="color: #666666">30*</span>period))
</pre>
</div>
<p>
    The appropriate exception is of type <code>validators.ValidationError</code>.
    Observe that through <code>form</code> we have in fact access to all the input
    data so we can easily use the value of \( w \) when checking the validity
    of the value of \( T \). The <code>check_T</code> function is easy to
    add to the list of validator functions in the call to the <code>FloatField</code>
    constructor for <code>T</code>:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>(Form):
    <span style="color: #666666">...</span>
    T <span style="color: #666666">=</span> FloatField(
        label<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;time interval&#39;</span>, default<span style="color: #666666">=6*</span>pi,
        validators<span style="color: #666666">=</span>[validators<span style="color: #666666">.</span>InputRequired(), check_T])
</pre>
</div>
<p>
    The validator
    objects are tested one by one as they appear in the list, and if
    one fails, the others are not invoked.
    We therefore add <code>check_T</code> after the check of input such that we know we
    have a value for all data when we run the computations and test
    in <code>check_T</code>.

<h3 id="___sec40">Tailored validation of intervals </h3>

<p>
    Although there is already a <code>NumberRange</code> validator for checking
    whether a value is inside an interval, we can write our own
    version with some improved functionality for open intervals where
    the maximum or minimum value can be infinite.
    The infinite value can on input be represented by <code>None</code>.
    A general such function may take the form

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">check_interval</span>(form, field, min_value<span
        style="color: #666666">=</span><span style="color: #008000">None</span>, max_value<span
        style="color: #666666">=</span><span style="color: #008000">None</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;For validation: failure if value is outside an interval.&quot;&quot;&quot;</span>
    failure <span style="color: #666666">=</span> <span style="color: #008000">False</span>
    <span style="color: #008000; font-weight: bold">if</span> min_value <span style="color: #AA22FF; font-weight: bold">is</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> field<span style="color: #666666">.</span>data <span
            style="color: #666666">&lt;</span> min_value:
            failure <span style="color: #666666">=</span> <span style="color: #008000">True</span>
    <span style="color: #008000; font-weight: bold">if</span> max_value <span style="color: #AA22FF; font-weight: bold">is</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> field<span style="color: #666666">.</span>data <span
            style="color: #666666">&gt;</span> max_value:
            failure <span style="color: #666666">=</span> <span style="color: #008000">True</span>
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">raise</span> validators<span style="color: #666666">.</span>ValidationError(
            <span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">=</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> not in [</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">, </span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">]&#39;</span> <span style="color: #666666">%</span>
            (field<span style="color: #666666">.</span>name, field<span style="color: #666666">.</span>data,
             <span style="color: #BA2121">&#39;-infty&#39;</span> <span
            style="color: #008000; font-weight: bold">if</span> min_value <span
            style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span> <span
            style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>(min_value),
             <span style="color: #BA2121">&#39;infty&#39;</span>  <span
            style="color: #008000; font-weight: bold">if</span> max_value <span
            style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span> <span
            style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>(max_value)))
</pre>
</div>
<p>
    The problem is that <code>check_interval</code> takes four arguments, not only
    the <code>form</code> and <code>field</code> arguments that a validator function in the
    Flask framework can accept.
    The way out of this difficulty is to use a Python tool <code>functools.partial</code>
    which allows us to call a function with some of the arguments set beforehand.
    Here, we want to create a new function that calls <code>check_interval</code>
    with some prescribed values of <code>min_value</code> and <code>max_value</code>.
    This function looks like it does not have these arguments, only
    <code>form</code> and <code>field</code>. The following function produces this function, which we
    can use as a valid Flask validator function:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">functools</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">interval</span>(min_value<span
            style="color: #666666">=</span><span style="color: #008000">None</span>, max_value<span
            style="color: #666666">=</span><span style="color: #008000">None</span>):
    <span style="color: #008000; font-weight: bold">return</span> functools<span style="color: #666666">.</span>partial(
        check_interval, min_value<span style="color: #666666">=</span>min_value, max_value<span
            style="color: #666666">=</span>max_value)
</pre>
</div>
<p>
    We can now in any field constructor just add
    <code>interval(a, b)</code> as a validator function, here checking that \( b\in [0,\infty) \):

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>(Form):
    <span style="color: #666666">...</span>
    b <span style="color: #666666">=</span> FloatField(
        label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;damping factor (kg/s)&#39;</span>, default<span
            style="color: #666666">=0</span>,
        validators<span style="color: #666666">=</span>[validators<span style="color: #666666">.</span>InputRequired(), interval(<span
            style="color: #666666">0</span>,<span style="color: #008000">None</span>)])
</pre>
</div>

<h3 id="___sec41">Demo </h3>

<p>
    Let us test our tailored error checking. Run <code>python controller.py</code>
    in the <code>vib2</code> directory and fill in \( -1.0 \) in the \( b \) field.
    Pressing <em>Compute</em> invokes our <code>interval(0,None)</code> function, which
    is nothing but a call to <code>check_interval</code> with the
    arguments <code>field</code>, <code>form</code>, <code>0</code>, and <code>None</code>.
    Inside this function,
    the test <code>if field.data &lt; min_value</code> becomes true, <code>failure</code>
    is set, and the exception is raised. The message in the exception
    is available in the <code>field.errors</code> attribute so our template
    will write it out in red, see Figure <a href="#wf:vib2:flask:fig:error1">12</a>.
    The template used in <code>vib2</code> is basically the same as <code>view_tex.html</code>
    in <code>vib1</code>, i.e., it feaures LaTeX mathematics and checking of
    <code>field.errors</code>.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 12: Triggering of a user-defined error check.
<div id="wf:vib2:flask:fig:error1"></div>
</p></center>
<p><img src="fig-web4sa/vib2_flask_error1.png" align="bottom" width=500></p>
</center>

<p>
    Finally, we mention a detail in the <code>controller.py</code> file in the <code>vib2</code>
    app: instead of sending <code>form.var.data</code> to the <code>compute</code> function we
    may automatically generate a set of local variables such that the
    application of data from the web page, here in the <code>compute</code> call, looks nicer:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        <span style="color: #008000; font-weight: bold">for</span> field <span
            style="color: #AA22FF; font-weight: bold">in</span> form:
            <span style="color: #408080; font-style: italic"># Make local variable (name field.name)</span>
            <span style="color: #008000; font-weight: bold">exec</span>(<span style="color: #BA2121">&#39;</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> = </span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (field<span style="color: #666666">.</span>name, field<span
            style="color: #666666">.</span>data))
        result <span style="color: #666666">=</span> compute(A, b, w, T)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>

    <span style="color: #008000; font-weight: bold">return</span> render_template(template, form<span
            style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>
<p>
    The idea is just to run <code>exec</code> on a declaration of a local variable
    with name <code>field.name</code> for each field in the form. This trick is often
    neat if web variables are buried in objects (<code>form.T.data</code>) and you want these
    variables in your
    code to look like they do in mathematical writing (<code>T</code> for \( T \)).

<p>
    <!-- !split -->

<h2 id="wf:vib2:flask:nofiles">Avoiding plot files</h2>

<p>
    Files with plots are easy to deal with as long as they are in the
    <code>static</code> subdirectory of the Flask application directory. However,
    as already pointed out, the previous <code>vib1</code> app, which writes plot
    files, is not suited for multiple simultaneous users since every
    user will destroy <em>all</em> existing plot files before making a new
    one. Therefore, we need a robust solution for multiple users of
    the app.

<p>
    The idea is to not write plot files, but instead return the plot
    as a string and embed that string directly in the HTML code.
    This is relatively straightforward with Matplotlib
    and Python. The relevant code is found in the <code>compute.py</code> file
    of the <code>vib2</code> app.

<h3 id="___sec43">PNG plots </h3>

<p>
    Python has the <code>io.StringIO</code> object for writing text to a
    string buffer with the same syntax as used for writing text to
    files. For binary streams, such as PNG files, one can use
    a similar object, <code>io.BytesIO</code>, to hold the stream (i.e., the plot file)
    in memory. The idea is to let Matplotlib write to
    a <code>io.BytesIO</code> object and afterwards extract the
    series of bytes in the plot file from this object and embed it in
    the HTML file directly. This approach avoids storing plots in separate
    files, at the cost of bigger HTML files.

<p>
    The first step is to let Matplotlib write the PNG data to
    the <code>BytesIO</code> buffer:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span
        style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plot</span>
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">io</span> <span
            style="color: #008000; font-weight: bold">import</span> BytesIO
<span style="color: #408080; font-style: italic"># run plt.plot, plt.title, etc.</span>
figfile <span style="color: #666666">=</span> BytesIO()
plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;png&#39;</span>)
figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)  <span
            style="color: #408080; font-style: italic"># rewind to beginning of file</span>
figdata_png <span style="color: #666666">=</span> figfile<span style="color: #666666">.</span>getvalue()  <span
            style="color: #408080; font-style: italic"># extract string (stream of bytes)</span>
</pre>
</div>
<p>
    Before the PNG data can be embedded in HTML we need to convert the
    data to base64 format:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">base64</span>
figdata_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figdata_png)
</pre>
</div>
<p>
    Now we can embed the PNG data in HTML by

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #666666">&lt;</span>img src<span style="color: #666666">=</span><span style="color: #BA2121">&quot;data:image/png;base64,PLOTSTR&quot;</span> width<span
        style="color: #666666">=</span><span style="color: #BA2121">&quot;500&quot;</span><span style="color: #666666">&gt;</span>
</pre>
</div>
<p>
    where <code>PLOTSTR</code> is the content of the string <code>figdata_png</code>.

<p>
    The complete <code>compute.py</code> function takes the form

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute</span>(A, b, w, T, resolution<span
        style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, resolution<span
            style="color: #666666">+1</span>)
    u <span style="color: #666666">=</span> damped_vibrations(t, A, b, w)
    plt<span style="color: #666666">.</span>figure()  <span style="color: #408080; font-style: italic"># needed to avoid adding curves in plot</span>
    plt<span style="color: #666666">.</span>plot(t, u)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;A=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, b=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, w=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (A, b, w))

    <span style="color: #408080; font-style: italic"># Make Matplotlib write to BytesIO file object and grab</span>
    <span style="color: #408080; font-style: italic"># return the object&#39;s string</span>
    <span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">io</span> <span
            style="color: #008000; font-weight: bold">import</span> BytesIO
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;png&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)  <span
            style="color: #408080; font-style: italic"># rewind to beginning of file</span>
    <span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">base64</span>
    figdata_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figfile<span
            style="color: #666666">.</span>getvalue())
    <span style="color: #008000; font-weight: bold">return</span> figdata_png
</pre>
</div>
<p>
    The relevant syntax in an HTML template is

<p>

    <!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
        style="color: #BA2121">&quot;data:image/png;base64,{{ results }}&quot;</span> <span style="color: #7D9029">width=</span><span
        style="color: #BA2121">&quot;500&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
</pre>
</div>
<p>
    if <code>results</code> holds the returned object from the <code>compute</code> function above.

<h3 id="___sec44">SVG plots </h3>

<p>
    Inline figures in HTML, instead of using files, are most often realized
    by XML code with the figure data in SVG format.
    Plot strings in the SVG format are created very similarly to the PNG
    example:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">figfile <span
        style="color: #666666">=</span> BytesIO()
plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;svg&#39;</span>)
figdata_svg <span style="color: #666666">=</span> figfile<span style="color: #666666">.</span>getvalue()
</pre>
</div>
<p>
    The <code>figdata_svg</code> string contains XML code text can almost
    be directly embedded in
    HTML5. However, the beginning of the text contains information before
    the <code>svg</code> tag that we want to remove:

<p>

    <!-- code=text (!bc dat) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
  &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Created with matplotlib (http://matplotlib.sourceforge.net/) --&gt;
&lt;svg height=&quot;441pt&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 585 441&quot; ...
</pre>
</div>
<p>
    The removal is done with a little string manipulation:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">figdata_svg <span
        style="color: #666666">=</span> <span style="color: #BA2121">&#39;&lt;svg&#39;</span> <span
        style="color: #666666">+</span> figfile<span style="color: #666666">.</span>getvalue()<span
        style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span
        style="color: #666666">1</span>]
</pre>
</div>
<p>
    Now, <code>figdata_svg</code> can be directly inserted in HTML code without
    any surrounding tags (because it is perfectly valid HTML code in itself).

<p>
    The SVG code generated by Matplotlib may contain UTF-8 characters
    so it is necessary to make a unicode string out of the text:
    <code>unicode(figdata_svg, 'utf-8')</code>, otherwise the HTML template will
    lead to an encoding exception.

<p>
    We have made an alternative compute function <code>compute_png_svg</code>
    that returns both a PNG and an SVG plot:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute_png_svg</span>(A, b, w, T, resolution<span
        style="color: #666666">=500</span>):
    <span style="color: #666666">...</span>
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;svg&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_svg <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&lt;svg&#39;</span> <span
            style="color: #666666">+</span> figfile<span style="color: #666666">.</span>getvalue()<span
            style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span
            style="color: #666666">1</span>]
    figdata_svg <span style="color: #666666">=</span> <span style="color: #008000">unicode</span>(figdata_svg, <span
            style="color: #BA2121">&#39;utf-8&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> figdata_png, figdata_svg
</pre>
</div>
<p>
    The relevant syntax for inserting an SVG plot in the HTML template is now

<p>

    <!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">{{ result[1]|safe }}
</pre>
</div>
<p>
    The use of <code>safe</code> is essential here.

<p>
    <div class="alert alert-block alert-notice alert-text-normal">
        <b>Important: use <code>safe</code> for verbatim HTML code:</b>
<p>
    Special HTML characters like <code>&lt;</code>, <code>&gt;</code>,
    <code>&</code>, <code>&quot;</code>, and <code>'</code> are escaped in a template string like <code>{{ str }}</code>
    (i.e., <code>&</code> is replaced by <code>&amp;</code> `<` is replaced by <code>&lt;</code>, etc.).
    We need to avoid this manipulation of the string content
    because <code>result[1]</code> contains
    XML code where the mentioned characters are essential part of the syntax.
    Writing <code>{{str|safe}}</code> ensures that the contents of the string <code>str</code>
    are not altered before being embedded in the HTML text.
    </div>


<p>
    An alternative template, <code>view_svg.html</code> applies the SVG plot instead
    of the PNG plot. We use the command-line argument <code>svg</code> for indicating
    that we want an SVG instead of a PNG plot:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #408080; font-style: italic"># SVG or PNG plot?</span>
svg <span style="color: #666666">=</span> <span style="color: #008000">False</span>
<span style="color: #008000; font-weight: bold">try</span>:
    <span style="color: #008000; font-weight: bold">if</span> sys<span style="color: #666666">.</span>argv[<span
            style="color: #666666">1</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;svg&#39;</span>:
        svg <span style="color: #666666">=</span> <span style="color: #008000">True</span>
<span style="color: #008000; font-weight: bold">except</span> <span
            style="color: #D2413A; font-weight: bold">IndexError</span>:
    <span style="color: #008000; font-weight: bold">pass</span>
<span style="color: #008000; font-weight: bold">if</span> svg:
    <span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute_png_svg <span
            style="color: #008000; font-weight: bold">as</span> compute
    template <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;view_svg.html&#39;</span>
<span style="color: #008000; font-weight: bold">else</span>:
    <span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute
    template <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;view.html&#39;</span>
</pre>
</div>

<h3 id="___sec45">Using mpld3 </h3>

<p>
    The <a href="http://mpld3.github.io" target="_self">mpld3</a> library can convert Matplotlib
    plots to HTML code that can be directly embedded in a web page. Here
    is a basic example:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #408080; font-style: italic"># Plot array y vs x</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">plt</span><span style="color: #666666">,</span> <span
            style="color: #0000FF; font-weight: bold">mpld3</span>
fig, ax <span style="color: #666666">=</span> plt<span style="color: #666666">.</span>subplots()
ax<span style="color: #666666">.</span>plot(x, y)
html_text <span style="color: #666666">=</span> mpld3<span style="color: #666666">.</span>fig_to_html(fig)
</pre>
</div>
<p>
    The string <code>html_text</code> contains all the HTML code that is needed to
    display the plot.

<p>
    The great advantage of the <code>mpld3</code> library is that it contains
    capabilities for creating custom interactive plots through combining
    Matplotlib with JavaScript, see the <a href="http://mpld3.github.io/examples/index.html#example-gallery"
                                           target="_self">mpld3 Example Gallery</a>.

<h2 id="wf:bokeh:flask">Plotting with the Bokeh library</h2>

<p>
    As an alternative to using Matplotlib for plotting, we can utilize
    the <a href="http://bokeh.pydata.org/en/latest/" target="_self">Bokeh</a> tool, which is
    particularly developed for graphics in web browsers.
    The <a href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib3"
           target="_self"><tt>vib3</tt></a> app is similar to the
    previously described <code>vib1</code> and <code>vib2</code> app, except that we make one plot with
    Bokeh. Only the <code>compute.py</code> and <code>view.html</code> files
    are different. Obviously, we need to run Bokeh in the compute function.
    Normally, Bokeh stores the HTML code for the plot in a file
    with a specified name. We can load the text in this file and
    extract the relevant HTML code for a plot. However, it is easier to
    use <a href="http://bokeh.pydata.org/en/latest/docs/user_guide/embed.html" target="_self">Bokeh tools</a> for
    returning the HTML code elements directly.
    The steps are exemplified in the <code>compute.py</code> file:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">numpy</span> <span
        style="color: #008000; font-weight: bold">import</span> exp, cos, linspace
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">bokeh.plotting</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span
            style="color: #0000FF; font-weight: bold">re</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">damped_vibrations</span>(t, A, b, w):
    <span style="color: #008000; font-weight: bold">return</span> A<span style="color: #666666">*</span>exp(<span
            style="color: #666666">-</span>b<span style="color: #666666">*</span>t)<span style="color: #666666">*</span>cos(w<span
            style="color: #666666">*</span>t)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute</span>(A, b, w, T, resolution<span
            style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, resolution<span
            style="color: #666666">+1</span>)
    u <span style="color: #666666">=</span> damped_vibrations(t, A, b, w)

    <span style="color: #408080; font-style: italic"># create a new plot with a title and axis labels</span>
    TOOLS <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;pan,wheel_zoom,box_zoom,reset,save,box_select,lasso_select&quot;</span>
    p <span style="color: #666666">=</span> plt<span style="color: #666666">.</span>figure(title<span
            style="color: #666666">=</span><span
            style="color: #BA2121">&quot;simple line example&quot;</span>, tools<span style="color: #666666">=</span>TOOLS,
                   x_axis_label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;t&#39;</span>, y_axis_label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;y&#39;</span>)

    <span style="color: #408080; font-style: italic"># add a line renderer with legend and line thickness</span>
    p<span style="color: #666666">.</span>line(t, u, legend<span style="color: #666666">=</span><span
            style="color: #BA2121">&quot;u(t)&quot;</span>, line_width<span style="color: #666666">=2</span>)

    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">bokeh.resources</span> <span
            style="color: #008000; font-weight: bold">import</span> CDN
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">bokeh.embed</span> <span
            style="color: #008000; font-weight: bold">import</span> components
    script, div <span style="color: #666666">=</span> components(p)
    head <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">&lt;link rel=&quot;stylesheet&quot;</span>
<span style="color: #BA2121"> href=&quot;http://cdn.pydata.org/bokeh/release/bokeh-0.9.0.min.css&quot;</span>
<span style="color: #BA2121"> type=&quot;text/css&quot; /&gt;</span>
<span style="color: #BA2121">&lt;script type=&quot;text/javascript&quot;</span>
<span style="color: #BA2121"> src=&quot;http://cdn.pydata.org/bokeh/release/bokeh-0.9.0.min.js&quot;&gt;</span>
<span style="color: #BA2121">&lt;/script&gt;</span>
<span style="color: #BA2121">&lt;script type=&quot;text/javascript&quot;&gt;</span>
<span style="color: #BA2121">Bokeh.set_log_level(&quot;info&quot;);</span>
<span style="color: #BA2121">&lt;/script&gt;</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">return</span> head, script, div
</pre>
</div>
<p>
    The key data returned from <code>compute</code> consists of a text for loading Bokeh
    tools in the <code>head</code> part of the HTML document (common for all plots in
    the file) and for the plot itself there is a <code>script</code> tag and a <code>div</code> tag. The
    <code>script</code> tag can be placed anywhere, while the <code>div</code> tag must be placed
    exactly where we want to have the plot. In case of multiple plots,
    there will be a common <code>script</code> tag and one <code>div</code> tag for each plot.

<p>
    We need to insert the three elements return from <code>compute</code>,
    available in the tuple <code>result</code>, into the <code>view.html</code> file.
    The link and scripts for Bokeh tools in <code>result[0]</code> is inserted
    in the <code>head</code> part, while the script and div tags for the plot
    is inserted where we want to have to plot.
    The complete <code>view.html</code> file looks like this:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;html</span> <span style="color: #7D9029">lang=</span><span
            style="color: #BA2121">&quot;en&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
   <span style="color: #008000; font-weight: bold">&lt;head&gt;</span>
    {{ result[0]|safe }}
<span style="color: #008000; font-weight: bold">&lt;/head&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/x-mathjax-config&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
MathJax.Hub.Config({
  TeX<span style="color: #666666">:</span> {
     equationNumbers<span style="color: #666666">:</span> {  autoNumber<span style="color: #666666">:</span> <span
            style="color: #BA2121">&quot;AMS&quot;</span>  },
     extensions<span style="color: #666666">:</span> [<span style="color: #BA2121">&quot;AMSmath.js&quot;</span>, <span
            style="color: #BA2121">&quot;AMSsymbols.js&quot;</span>, <span style="color: #BA2121">&quot;autobold.js&quot;</span>]
  }
});
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src=</span>
<span style="color: #BA2121">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">&quot;name&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>\( {{ field.name }} \) <span
            style="color: #999999; font-weight: bold">&amp;nbsp;&amp;nbsp;</span><span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field(size=12) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    {% if field.errors %}
      <span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;ul</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
      {% for error in field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;li&gt;&lt;font</span> <span
            style="color: #7D9029">color=</span><span style="color: #BA2121">&quot;red&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;Compute&quot;</span><span style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
<span style="color: #408080; font-style: italic">&lt;!-- script and div elements for Bokeh plot --&gt;</span>
{{ result[1]|safe }}
{{ result[2]|safe }}
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
</pre>
</div>
<p>
    A feature of Bokeh plots is that one can zoom, pan, and save
    to PNG file, among other
    things. There is a toolbar at the top for such actions.

<p>
    The <code>controller.py</code> file is basically the same as before (but simpler
    than in the <code>vib2</code> app since we do not deal with PNG and/or SVG plots):

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">model</span> <span
        style="color: #008000; font-weight: bold">import</span> InputForm
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask</span> <span
            style="color: #008000; font-weight: bold">import</span> Flask, render_template, request
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute

app <span style="color: #666666">=</span> Flask(__name__)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/vib3&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        <span style="color: #008000; font-weight: bold">for</span> field <span
            style="color: #AA22FF; font-weight: bold">in</span> form:
            <span style="color: #408080; font-style: italic"># Make local variable (name field.name)</span>
            <span style="color: #008000; font-weight: bold">exec</span>(<span style="color: #BA2121">&#39;</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> = </span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (field<span style="color: #666666">.</span>name, field<span
            style="color: #666666">.</span>data))
        result <span style="color: #666666">=</span> compute(A, b, w, T)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>

    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&#39;view.html&#39;</span>, form<span
            style="color: #666666">=</span>form,
                           result<span style="color: #666666">=</span>result)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>
<p>
    Finally, we remark that Bokeh plays very well with Flask.
    <a href="#wf:exer:bokeh_UI">Project 9: Interactive function exploration</a> suggests a web app that combines
    Bokeh with Flask in a very interactive way.

<h3 id="___sec47">Pandas highcharts plotting library </h3>

<p>
    The <a href="https://pypi.python.org/pypi/pandas-highcharts/" target="_self">pandas-highcharts</a>
    package is another strong alternative to Bokeh for interative
    plotting in web pages. It is a stable and widely used code.

<p>
    <!-- !split -->

<h2 id="wf:autogen:flask">Autogenerating the code</h2>

<p>
    We shall now present generic <code>model.py</code> and <code>controller.py</code>
    files that work with <em>any</em> <code>compute</code> function (!). This example will
    demonstrate some advanced, powerful features of Python. The source code
    is found in the <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen"
        target="_self"><tt>gen</tt></a>
    directory.

<h3 id="___sec49">Inspecting function signatures </h3>

<p>
    The basic idea is that the Python module <code>inspect</code> can be used to
    retrieve the names of the arguments and the default values of
    keyword arguments of <em>any</em> given <code>compute</code> function. Say we have some

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">mycompute</span>(A, m<span
        style="color: #666666">=0</span>, s<span style="color: #666666">=1</span>, w<span
        style="color: #666666">=1</span>, x_range<span style="color: #666666">=</span>[<span
        style="color: #666666">-3</span>,<span style="color: #666666">3</span>]):
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">return</span> result
</pre>
</div>
<p>
    Running

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>defaults
</pre>
</div>
<p>
    leads to

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
        style="color: #666666">=</span> [<span style="color: #BA2121">&#39;A&#39;</span>, <span style="color: #BA2121">&#39;m&#39;</span>, <span
        style="color: #BA2121">&#39;s&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>, <span
        style="color: #BA2121">&#39;x_range&#39;</span>]
defaults <span style="color: #666666">=</span> (<span style="color: #666666">0</span>, <span
            style="color: #666666">1</span>, <span style="color: #666666">1</span>, [<span
            style="color: #666666">-3</span>, <span style="color: #666666">3</span>])
</pre>
</div>
<p>
    We have all the argument names in <code>arg_names</code> and
    <code>defaults[i]</code> is the default value of keyword argument
    <code>arg_names[j]</code>, where <code>j = len(arg_names) - len(defaults) + i</code>.

<h3 id="___sec50">Generating the model </h3>

<p>
    Knowing the name <code>name</code> of some argument in the <code>compute</code>
    function, we can make the corresponding class attribute
    in the <code>InputForm</code> class by

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
</div>
<p>
    For name equal to <code>'A'</code> this is the same as hardcoding

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>:
    A <span style="color: #666666">=</span> FloatForm()
</pre>
</div>
<p>
    Assuming that all arguments in <code>compute</code> are floats, we could
    do

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>:
    <span style="color: #008000; font-weight: bold">pass</span>  <span style="color: #408080; font-style: italic"># Empty class</span>

arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>args
<span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names:
    <span style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
</div>
<p>
    However, we can do better than this: for
    keyword arguments the type of the default value can be used to
    select the appropriate form class. The complete <code>model.py</code> file
    then goes as follows:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">Example on generic model.py file which inspects the arguments</span>
<span style="color: #BA2121; font-style: italic">of the compute function and automatically generates a relevant</span>
<span style="color: #BA2121; font-style: italic">InputForm class.</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>

<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">wtforms</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
            style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute_gamma <span
            style="color: #008000; font-weight: bold">as</span> compute
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
            style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
            style="color: #666666">.</span>defaults

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(wtforms<span style="color: #666666">.</span>Form):
    <span style="color: #008000; font-weight: bold">pass</span>

<span style="color: #408080; font-style: italic"># Augment defaults with None elements for the positional</span>
<span style="color: #408080; font-style: italic"># arguments</span>
defaults <span style="color: #666666">=</span> [<span style="color: #008000">None</span>]<span
            style="color: #666666">*</span>(<span style="color: #008000">len</span>(arg_names)<span
            style="color: #666666">-</span><span style="color: #008000">len</span>(defaults)) <span
            style="color: #666666">+</span> <span style="color: #008000">list</span>(defaults)
<span style="color: #408080; font-style: italic"># Map type of default to right form field</span>
type2form <span style="color: #666666">=</span> {<span style="color: #008000">type</span>(<span style="color: #666666">1.0</span>): wtforms<span
            style="color: #666666">.</span>FloatField,
             <span style="color: #008000">type</span>(<span style="color: #666666">1</span>):   wtforms<span
            style="color: #666666">.</span>IntegerField,
             <span style="color: #008000">type</span>(<span style="color: #BA2121">&#39;&#39;</span>):  wtforms<span
            style="color: #666666">.</span>TextField,
             }

<span style="color: #008000; font-weight: bold">for</span> name, value <span style="color: #AA22FF; font-weight: bold">in</span> <span
            style="color: #008000">zip</span>(arg_names, defaults):
    <span style="color: #008000; font-weight: bold">if</span> value <span
            style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
        <span style="color: #008000">setattr</span>(InputForm, name, wtforms<span style="color: #666666">.</span>FloatField(
            validators<span style="color: #666666">=</span>[wtforms<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()]))
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">type</span>(value) <span
            style="color: #AA22FF; font-weight: bold">in</span> type2form:
            <span style="color: #008000">setattr</span>(InputForm, name, type2form[<span
            style="color: #008000">type</span>(value)](
                default<span style="color: #666666">=</span>value,
                validators<span style="color: #666666">=</span>[wtforms<span
            style="color: #666666">.</span>validators<span style="color: #666666">.</span>InputRequired()]))
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span
            style="color: #D2413A; font-weight: bold">TypeError</span>(<span
            style="color: #BA2121">&#39;argument </span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> not supported&#39;</span> <span style="color: #666666">%</span>
                            name, <span style="color: #008000">type</span>(value))

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">for</span> item <span
            style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">dir</span>(InputForm):
        <span style="color: #008000; font-weight: bold">if</span> item <span style="color: #AA22FF; font-weight: bold">in</span> arg_names:
            <span style="color: #008000; font-weight: bold">print</span> item, <span
            style="color: #008000">getattr</span>(InputForm, item)
</pre>
</div>
<p>
    (The <code>compute_gamma</code> function imported from <code>compute</code> is the
    only application-specific statement in this code and will be explained later.)

<h3 id="___sec51">Generating the view </h3>

<p>
    The call to <code>compute</code> in the <code>controller.py</code> file must also be expressed
    in a general way such that the call handles any type and number of
    parameters. This can be done in two ways, using either positional
    or keyword arguments.

<p>
    The technique with positional arguments
    is explained first. It consists of collecting all parameters in
    a list or tuple, called <code>args</code>, and then calling <code>compute(*args)</code>
    (which is equivalent to <code>compute(args[0], args[1], ..., args[n])</code>
    if <code>n</code> is <code>len(args)-1</code>). The elements of <code>args</code> are the values of the
    form variables. We know the name of a form variable as a string
    <code>name</code> (from <code>arg_names</code>), and if <code>form</code> is the form object,
    the construction <code>getattr(form, name).data</code> extracts the value
    that the user provided (<code>getattr(obj, attr)</code> gets the attribute, with name
    available as a string in <code>attr</code>, in the object <code>obj</code>).
    For exampe, if <code>name</code> is <code>'A'</code>, <code>getattr(form, name).data</code> is the same as
    <code>form.A.data</code>.
    Collecting all form variables, placing them in a list,
    and calling <code>compute</code> are done with

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
        style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
        style="color: #666666">.</span>args
args <span style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
            style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names]
result <span style="color: #666666">=</span> compute(<span style="color: #666666">*</span>args)
</pre>
</div>
<p>
    Our <code>InputForm</code> class guarantees that all arguments in <code>compute</code>
    are present in the form, but to be absolutely safe we can
    test if <code>name</code> is present in the <code>form</code> object:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">args <span
        style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
        style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
        style="color: #AA22FF; font-weight: bold">in</span> arg_names
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)]
</pre>
</div>
<p>
    A potential problem with the <code>args</code> list is that the values might
    be in wrong order. It appears, fortunately, that the order we
    assign attributes to the form class is preserved when iterating over
    the form. Nevertheless, using keyword arguments instead of positional
    arguments provides a completely safe solution to calling <code>compute</code>
    with the correct arguments. Keyword arguments are placed in a
    dictionary <code>kwargs</code> and <code>compute</code> is called as <code>compute(**kwargs)</code>.
    The generic solution is

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">kwargs <span
        style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
        style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
        style="color: #AA22FF; font-weight: bold">in</span> arg_names
          <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
</pre>
</div>
<p>
    The <code>compute(**kwargs)</code> call is equivalent to <code>compute(A=1, b=3, w=0.5)</code>
    in case <code>kwargs = {'w'=0.5, 'A':1, 'b':3}</code> (recall that the order of
    the keys in a Python dictionary is undetermined).

<h3 id="___sec52">Generating the template </h3>

<p>
    It remains to generate the right HTML template. The HTML code depends
    on what the returned <code>result</code> object from <code>compute</code> contains. Only a
    human who has read the <code>compute</code> code knows the details of the returned
    result. Therefore, we leave it to a human to provide the part
    of the HTML template that renders the result. The file <code>templates/view_results.html</code> contains this
    human-provided code, while <code>templates/view.html</code>
    is a completely generic template for the forms:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span> <span
            style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{% if field.errors %}
      <span style="color: #008000; font-weight: bold">&lt;ul</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
      {% for error in field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
      {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
    {% endif %}<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Compute</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>

{% if result != None %}
{{ result|safe }}
{% endif %}
</pre>
</div>
<p>
    At the end of this code, an HTML text <code>result</code> (string) is to be
    inserted. This text is typically generated by calling Flask's
    <code>render_template</code> function, which uses <code>templates/view_results.html</code>
    to turn the return object <code>result</code> from the compute function into the
    desired HTML code:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">if</span> result:
        result <span style="color: #666666">=</span> render_template(<span style="color: #BA2121">&#39;view_results.html&#39;</span>, result<span
            style="color: #666666">=</span>result)
        <span style="color: #408080; font-style: italic"># result is now rendered HTML text</span>
    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&#39;view.html&#39;</span>, form<span
            style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)
</pre>
</div>
<p>
    <div class="alert alert-block alert-notice alert-text-normal">
        <b>Notice.</b>
<p>
    A perhaps simpler alternative would be to have a generic
    <code>view_forms.html</code> file and a user-specific
    <code>view_results.html</code> and explicitly combining them into a new
    file. This requires file writing by the app, which one normally
    wants to avoid. Especially if the web app gets multiple users,
    the file writing may lead to corrupt files.
    </div>


<p>
    The complete, generic form of the <code>index</code> function becomes

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        arg_names <span style="color: #666666">=</span> inspect<span
            style="color: #666666">.</span>getargspec(compute)<span style="color: #666666">.</span>args
        kwargs <span style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
            style="color: #666666">.</span>data
                  <span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names <span
            style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
        result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
    <span style="color: #008000; font-weight: bold">if</span> result:
        <span style="color: #408080; font-style: italic"># result must be transformed to HTML and inserted as a</span>
        <span style="color: #408080; font-style: italic"># string in the generic view.html file</span>
        result <span style="color: #666666">=</span> render_template(<span style="color: #BA2121">&#39;view_results.html&#39;</span>, result<span
            style="color: #666666">=</span>result)
    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&#39;view.html&#39;</span>, form<span
            style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>

<h3 id="___sec53">Application </h3>

<p>
    Let us apply the files above to plot the gamma probability density function

    $$ g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
    e^{-\left(\frac{x}{A}\right)^h},
    $$

    and its cumulative density

    $$ G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,$$

    computed by numerically the Trapezoidal rule, for instance.
    We also want to compute and display
    the mean value \( A\Gamma(a + 1/h)/\Gamma(a) \) and
    standard deviation

    $$ \sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - \Gamma(a+1/h)^2}.$$

    Here, \( \Gamma(a) \) is the gamma function, which can be computed
    by <code>math.gamma(a)</code> in Python.
    Below is a <code>compute.py</code> file with the
    relevant implementations of \( g(x;a,h,A) \) (<code>gamma_density</code>),
    \( G(x; a, h, A) \) (<code>gamma_cumulative</code>), and a function <code>compute_gamma</code> for
    making a plot of \( g \) og \( G \) for \( x\in [0,7\sigma] \).

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_density</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    xA <span style="color: #666666">=</span> x<span style="color: #666666">/</span><span
            style="color: #008000">float</span>(A)
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">abs</span>(h)<span
            style="color: #666666">/</span>(math<span style="color: #666666">.</span>gamma(a)<span
            style="color: #666666">*</span>A)<span style="color: #666666">*</span>(xA)<span
            style="color: #666666">**</span>(a<span style="color: #666666">*</span>h<span
            style="color: #666666">-1</span>)<span style="color: #666666">*</span>exp(<span
            style="color: #666666">-</span>xA<span style="color: #666666">**</span>h)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_cumulative</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span style="color: #408080; font-style: italic"># Assume x is array.</span>
    g <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    r <span style="color: #666666">=</span> zeros_like(x)
    <span style="color: #008000; font-weight: bold">for</span> i <span
            style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span
            style="color: #008000">len</span>(r)<span style="color: #666666">-1</span>):
        r[i<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> r[i] <span
            style="color: #666666">+</span> <span style="color: #666666">0.5*</span>(g[i] <span
            style="color: #666666">+</span> g[i<span style="color: #666666">+1</span>])<span
            style="color: #666666">*</span>(x[i<span style="color: #666666">+1</span>] <span
            style="color: #666666">-</span> x[i])
    <span style="color: #008000; font-weight: bold">return</span> r

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute_gamma</span>(a<span
            style="color: #666666">=0.5</span>, h<span style="color: #666666">=2.0</span>, A<span
            style="color: #666666">=</span>math<span style="color: #666666">.</span>sqrt(<span
            style="color: #666666">2</span>), resolution<span style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    gah <span style="color: #666666">=</span> math<span style="color: #666666">.</span>gamma(a <span
            style="color: #666666">+</span> <span style="color: #666666">1./</span>h)
    mean <span style="color: #666666">=</span> A<span style="color: #666666">*</span>gah<span
            style="color: #666666">/</span>math<span style="color: #666666">.</span>gamma(a)
    stdev <span style="color: #666666">=</span> A<span style="color: #666666">/</span>math<span
            style="color: #666666">.</span>gamma(a)<span style="color: #666666">*</span>math<span
            style="color: #666666">.</span>sqrt(
        math<span style="color: #666666">.</span>gamma(a <span style="color: #666666">+</span> <span
            style="color: #666666">2./</span>h)<span style="color: #666666">*</span>math<span
            style="color: #666666">.</span>gamma(a) <span style="color: #666666">-</span> gah<span
            style="color: #666666">**2</span>)
    x <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span
            style="color: #666666">7*</span>stdev, resolution<span style="color: #666666">+1</span>)
    y <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()  <span style="color: #408080; font-style: italic"># needed to avoid adding curves in plot</span>
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;a=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, h=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, A=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (a, h, A))
    <span style="color: #408080; font-style: italic"># Make Matplotlib write to BytesIO file object and grab</span>
    <span style="color: #408080; font-style: italic"># return the object&#39;s string</span>
    <span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">io</span> <span
            style="color: #008000; font-weight: bold">import</span> BytesIO
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;png&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)  <span
            style="color: #408080; font-style: italic"># rewind to beginning of file</span>
    <span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">base64</span>
    figdata_density_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figfile<span
            style="color: #666666">.</span>getvalue())
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;svg&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_density_svg <span style="color: #666666">=</span> <span
            style="color: #BA2121">&#39;&lt;svg&#39;</span> <span style="color: #666666">+</span> figfile<span
            style="color: #666666">.</span>getvalue()<span style="color: #666666">.</span>split(<span
            style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span style="color: #666666">1</span>]
    figdata_density_svg <span style="color: #666666">=</span> <span style="color: #008000">unicode</span>(figdata_density_svg,<span
            style="color: #BA2121">&#39;utf-8&#39;</span>)

    y <span style="color: #666666">=</span> gamma_cumulative(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>grid(<span style="color: #008000">True</span>)
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;png&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_cumulative_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figfile<span
            style="color: #666666">.</span>getvalue())
    figfile <span style="color: #666666">=</span> BytesIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;svg&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_cumulative_svg <span style="color: #666666">=</span> <span
            style="color: #BA2121">&#39;&lt;svg&#39;</span> <span style="color: #666666">+</span> figfile<span
            style="color: #666666">.</span>getvalue()<span style="color: #666666">.</span>split(<span
            style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span style="color: #666666">1</span>]
    figdata_cumulative_svg <span style="color: #666666">=</span> <span style="color: #008000">unicode</span>(figdata_cumulative_svg,<span
            style="color: #BA2121">&#39;utf-8&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> figdata_density_png, figdata_cumulative_png, \
           figdata_density_svg, figdata_cumulative_svg, \
           <span style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span
            style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> mean, <span
            style="color: #BA2121">&#39;</span><span style="color: #BB6688; font-weight: bold">%.2f</span><span
            style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> stdev
</pre>
</div>
<p>
    The <code>compute_gamma</code> function returns a tuple of six values.
    We want output as displayed in Figure <a href="#wf:gen:flask:fig:gamma">13</a>.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 13: Design of a web page illustrating the gamma probability functions.
<div id="wf:gen:flask:fig:gamma"></div>
</p></center>
<p><img src="fig-web4sa/gen_flask_gamma.png" align="bottom" width=700></p>
</center>

<p>
    The design is realized in the file <code>view_results.html</code> shown below.

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;data:image/png;base64,{{ result[0] }}&quot;</span> <span
            style="color: #7D9029">width=</span><span style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;data:image/png;base64,{{ result[1] }}&quot;</span> <span
            style="color: #7D9029">width=</span><span style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ result[2]|safe }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ result[3]|safe }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>
Mean value: {{ result[4] }} <span style="color: #008000; font-weight: bold">&lt;br&gt;</span>
Standard deviation value: {{ result[5] }}
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
</pre>
</div>
<p>
    To create the web application, we just perform the following steps:

<ol>
    <li> copy the generic <code>controller.py</code> and <code>model.py</code> files to a new directory</li>
    <li> write the compute function in a file <code>compute.py</code></li>
    <li> edit <code>controller.py</code> and <code>model.py</code> to use the right name of the
        compute function (<code>from compute import name as compute</code>)
    </li>
    <li> add an appropriate <code>templates/view_forms.html</code> file that visualizes
        the returned value <code>results</code> from the compute function
    </li>
</ol>

<!-- !split -->

<h2 id="wf:flask:login">User login and storage of computed results</h2>

<p>
    We now want to make an app where the computed results can be stored in
    a database. To this end, each user must create an account and login to
    this account for archiving results and for browsing previous runs of
    the application. More files are needed for this purpose, compared to
    the previous apps, and the files are located in the <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/login"
        target="_self"><tt>login</tt></a> directory.

<h3 id="___sec55">Required additional software </h3>

<p>
    Three more packages are needed for this more advanced application:

<ul>
    <li><a href="https://flask-login.readthedocs.org/en/latest/" target="_self">Flask-Login</a></li>
    <li><a href="http://flask.pocoo.org/docs/0.10/patterns/sqlalchemy/" target="_self">Flask-SQLAlchemy</a></li>
    <li><a href="http://packages.python.org/Flask-Mail" target="_self">Flask-Mail</a></li>
</ul>

Installation is done by

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">sudo pip install --upgrade flask-login
sudo pip install --upgrade flask-sqlalchemy
sudo pip install --upgrade flask-mail
</pre>
</div>

<h3 id="___sec56">The compute part </h3>

<p>
    The <code>compute.py</code> file contains the <code>compute</code>
    function from the <code>vib2</code> app in the section <a href="#wf:vib2:flask:nofiles">Avoiding plot files</a>.

<p>
    There is quite much Flask code required for user accounts and login.
    The files here were generated by the Parampool package and then
    edited and specialized to the present application. In general,
    it is not recommended to hack further on the example given here,
    but rather utilize Parampool to generate web apps with user accounts
    and login.

<h3 id="___sec57">The interfaces of the app </h3>

<p>
    The first page after starting the app (<code>python controller.py</code>)
    shows input fields for the numerical parameters, but there are also
    links to the right for registering a new user or logging in to an
    existing account:

<p>
    <center>
<p><img src="fig-web4sa/login_main.png" align="bottom" width=700></p></center>

<p>
    Clicking on <em>Register</em> brings up a registration page:

<p>
    <center>
<p><img src="fig-web4sa/login_register.png" align="bottom" width=700></p></center>

<p>
    Already registered users can just log in:

<p>
    <center>
<p><img src="fig-web4sa/login_login.png" align="bottom" width=700></p></center>

<p>
    Then the fields with input parameters are shown again. After pressing
    <em>Compute</em> we are left with a combination of input and results, plus
    a field where the user can write a comment about this simulation:

<p>
    <center>
<p><img src="fig-web4sa/login_results.png" align="bottom" width=700></p></center>

<p>
    All simulations (input data, results, and comment) are stored in
    a database. Clicking on <em>Previous simulation</em> brings us to an
    overview of what is in the database:

<p>
    <center>
<p><img src="fig-web4sa/login_old.png" align="bottom" width=500></p></center>

<p>
    Here, one can browse previous results, remove entries, or erase the
    whole database.

<h3 id="___sec58">The source code </h3>

<p>
    Rather than explaining everything about the source code
    in detail, we primarily list
    the various code files below. A starting point is the central <code>controller.py</code>
    file, which is now quite lengthy and involves four different
    URLs (the input page, the login page, the registration page, and the
    previous results page).

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">os</span>
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute <span
            style="color: #008000; font-weight: bold">as</span> compute_function

<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask</span> <span
            style="color: #008000; font-weight: bold">import</span> Flask, render_template, request, redirect, url_for
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">forms</span> <span
            style="color: #008000; font-weight: bold">import</span> ComputeForm
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">db_models</span> <span style="color: #008000; font-weight: bold">import</span> db, User, Compute
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask.ext.login</span> <span
            style="color: #008000; font-weight: bold">import</span> LoginManager, current_user, \
     login_user, logout_user, login_required
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">app</span> <span
            style="color: #008000; font-weight: bold">import</span> app

login_manager <span style="color: #666666">=</span> LoginManager()
login_manager<span style="color: #666666">.</span>init_app(app)

<span style="color: #AA22FF">@login_manager.user_loader</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">load_user</span>(user_id):
    <span style="color: #008000; font-weight: bold">return</span> db<span style="color: #666666">.</span>session<span
            style="color: #666666">.</span>query(User)<span style="color: #666666">.</span>get(user_id)

<span style="color: #408080; font-style: italic"># Path to the web application</span>
<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
    user <span style="color: #666666">=</span> current_user
    form <span style="color: #666666">=</span> ComputeForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&quot;POST&quot;</span>:
        <span style="color: #008000; font-weight: bold">if</span> form<span style="color: #666666">.</span>validate():

            result <span style="color: #666666">=</span> compute_function(form<span
            style="color: #666666">.</span>A<span style="color: #666666">.</span>data, form<span style="color: #666666">.</span>b<span
            style="color: #666666">.</span>data,
                                      form<span style="color: #666666">.</span>w<span style="color: #666666">.</span>data, form<span
            style="color: #666666">.</span>T<span style="color: #666666">.</span>data)
            <span style="color: #008000; font-weight: bold">if</span> user<span style="color: #666666">.</span>is_authenticated():
                <span style="color: #008000">object</span> <span style="color: #666666">=</span> Compute()
                form<span style="color: #666666">.</span>populate_obj(<span style="color: #008000">object</span>)
                <span style="color: #008000">object</span><span style="color: #666666">.</span>result <span
            style="color: #666666">=</span> result
                <span style="color: #008000">object</span><span style="color: #666666">.</span>user <span
            style="color: #666666">=</span> user
                db<span style="color: #666666">.</span>session<span style="color: #666666">.</span>add(<span
            style="color: #008000">object</span>)
                db<span style="color: #666666">.</span>session<span style="color: #666666">.</span>commit()

                <span style="color: #408080; font-style: italic"># Send email notification</span>
                <span style="color: #008000; font-weight: bold">if</span> user<span style="color: #666666">.</span>notify <span
            style="color: #AA22FF; font-weight: bold">and</span> user<span style="color: #666666">.</span>email:
                    send_email(user)
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">if</span> user<span style="color: #666666">.</span>is_authenticated():
            <span style="color: #008000; font-weight: bold">if</span> user<span
            style="color: #666666">.</span>Compute<span style="color: #666666">.</span>count() <span
            style="color: #666666">&gt;</span> <span style="color: #666666">0</span>:
                instance <span style="color: #666666">=</span> user<span style="color: #666666">.</span>Compute<span
            style="color: #666666">.</span>order_by(<span style="color: #BA2121">&#39;-id&#39;</span>)<span
            style="color: #666666">.</span>first()
                result <span style="color: #666666">=</span> instance<span style="color: #666666">.</span>result
                form <span style="color: #666666">=</span> populate_form_from_instance(instance)

    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;view.html&quot;</span>, form<span
            style="color: #666666">=</span>form,
                           result<span style="color: #666666">=</span>result, user<span style="color: #666666">=</span>user)


<span style="color: #008000; font-weight: bold">def</span> <span
            style="color: #0000FF">populate_form_from_instance</span>(instance):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Repopulate form with previous values&quot;&quot;&quot;</span>
    form <span style="color: #666666">=</span> ComputeForm()
    <span style="color: #008000; font-weight: bold">for</span> field <span
            style="color: #AA22FF; font-weight: bold">in</span> form:
        field<span style="color: #666666">.</span>data <span style="color: #666666">=</span> <span
            style="color: #008000">getattr</span>(instance, field<span style="color: #666666">.</span>name)
    <span style="color: #008000; font-weight: bold">return</span> form

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">send_email</span>(user):
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask.ext.mail</span> <span
            style="color: #008000; font-weight: bold">import</span> Mail, Message
    mail <span style="color: #666666">=</span> Mail(app)
    msg <span style="color: #666666">=</span> Message(<span style="color: #BA2121">&quot;Compute Computations Complete&quot;</span>,
                  recipients<span style="color: #666666">=</span>[user<span style="color: #666666">.</span>email])
    msg<span style="color: #666666">.</span>body <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">A simulation has been completed by the Flask Compute app.</span>
<span style="color: #BA2121">Please log in at</span>

<span style="color: #BA2121">http://localhost:5000/login</span>

<span style="color: #BA2121">to see the results.</span>

<span style="color: #BA2121">---</span>
<span style="color: #BA2121">If you don&#39;t want email notifications when a result is found,</span>
<span style="color: #BA2121">please register a new user and leave the &#39;notify&#39; field</span>
<span style="color: #BA2121">unchecked.</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span>
    mail<span style="color: #666666">.</span>send(msg)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/reg&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">create_login</span>():
    <span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">forms</span> <span style="color: #008000; font-weight: bold">import</span> register_form
    form <span style="color: #666666">=</span> register_form(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        user <span style="color: #666666">=</span> User()
        form<span style="color: #666666">.</span>populate_obj(user)
        user<span style="color: #666666">.</span>set_password(form<span style="color: #666666">.</span>password<span
            style="color: #666666">.</span>data)

        db<span style="color: #666666">.</span>session<span style="color: #666666">.</span>add(user)
        db<span style="color: #666666">.</span>session<span style="color: #666666">.</span>commit()

        login_user(user)
        <span style="color: #008000; font-weight: bold">return</span> redirect(url_for(<span style="color: #BA2121">&#39;index&#39;</span>))
    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;reg.html&quot;</span>, form<span
            style="color: #666666">=</span>form)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/login&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">login</span>():
    <span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">forms</span> <span style="color: #008000; font-weight: bold">import</span> login_form
    form <span style="color: #666666">=</span> login_form(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        user <span style="color: #666666">=</span> form<span style="color: #666666">.</span>get_user()
        login_user(user)
        <span style="color: #008000; font-weight: bold">return</span> redirect(url_for(<span style="color: #BA2121">&#39;index&#39;</span>))
    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;login.html&quot;</span>, form<span
            style="color: #666666">=</span>form)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/logout&#39;</span>)
<span style="color: #AA22FF">@login_required</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">logout</span>():
    logout_user()
    <span style="color: #008000; font-weight: bold">return</span> redirect(url_for(<span style="color: #BA2121">&#39;index&#39;</span>))

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/old&#39;</span>)
<span style="color: #AA22FF">@login_required</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">old</span>():
    data <span style="color: #666666">=</span> []
    user <span style="color: #666666">=</span> current_user
    <span style="color: #008000; font-weight: bold">if</span> user<span style="color: #666666">.</span>is_authenticated():
        instances <span style="color: #666666">=</span> user<span style="color: #666666">.</span>Compute<span
            style="color: #666666">.</span>order_by(<span style="color: #BA2121">&#39;-id&#39;</span>)<span
            style="color: #666666">.</span>all()
        <span style="color: #008000; font-weight: bold">for</span> instance <span
            style="color: #AA22FF; font-weight: bold">in</span> instances:
            form <span style="color: #666666">=</span> populate_form_from_instance(instance)

            result <span style="color: #666666">=</span> instance<span style="color: #666666">.</span>result
            <span style="color: #008000; font-weight: bold">if</span> instance<span style="color: #666666">.</span>comments:
                comments <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&lt;h3&gt;Comments&lt;/h3&gt;&quot;</span> <span
            style="color: #666666">+</span> instance<span style="color: #666666">.</span>comments
            <span style="color: #008000; font-weight: bold">else</span>:
                comments <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
            data<span style="color: #666666">.</span>append(
                {<span style="color: #BA2121">&#39;form&#39;</span>:form, <span
            style="color: #BA2121">&#39;result&#39;</span>:result,
                 <span style="color: #BA2121">&#39;id&#39;</span>:instance<span style="color: #666666">.</span>id, <span
            style="color: #BA2121">&#39;comments&#39;</span>: comments})

    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;old.html&quot;</span>, data<span
            style="color: #666666">=</span>data)

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/add_comment&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #AA22FF">@login_required</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">add_comment</span>():
    user <span style="color: #666666">=</span> current_user
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> user<span style="color: #666666">.</span>is_authenticated():
        instance <span style="color: #666666">=</span> user<span style="color: #666666">.</span>Compute<span
            style="color: #666666">.</span>order_by(<span style="color: #BA2121">&#39;-id&#39;</span>)<span
            style="color: #666666">.</span>first()
        instance<span style="color: #666666">.</span>comments <span style="color: #666666">=</span> request<span
            style="color: #666666">.</span>form<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;comments&quot;</span>, <span
            style="color: #008000">None</span>)
        db<span style="color: #666666">.</span>session<span style="color: #666666">.</span>commit()
    <span style="color: #008000; font-weight: bold">return</span> redirect(url_for(<span style="color: #BA2121">&#39;index&#39;</span>))

<span style="color: #AA22FF">@app.route</span>(<span style="color: #BA2121">&#39;/delete/&lt;id&gt;&#39;</span>, methods<span
            style="color: #666666">=</span>[<span style="color: #BA2121">&#39;GET&#39;</span>, <span
            style="color: #BA2121">&#39;POST&#39;</span>])
<span style="color: #AA22FF">@login_required</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">delete_post</span>(<span
            style="color: #008000">id</span>):
    <span style="color: #008000">id</span> <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span
            style="color: #008000">id</span>)
    user <span style="color: #666666">=</span> current_user
    <span style="color: #008000; font-weight: bold">if</span> user<span style="color: #666666">.</span>is_authenticated():
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">id</span> <span
            style="color: #666666">==</span> <span style="color: #666666">-1</span>:
            instances <span style="color: #666666">=</span> user<span style="color: #666666">.</span>Compute<span
            style="color: #666666">.</span>delete()
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">try</span>:
                instance <span style="color: #666666">=</span> user<span style="color: #666666">.</span>Compute<span
            style="color: #666666">.</span>filter_by(<span style="color: #008000">id</span><span style="color: #666666">=</span><span
            style="color: #008000">id</span>)<span style="color: #666666">.</span>first()
                db<span style="color: #666666">.</span>session<span style="color: #666666">.</span>delete(instance)
            <span style="color: #008000; font-weight: bold">except</span>:
                <span style="color: #008000; font-weight: bold">pass</span>

        db<span style="color: #666666">.</span>session<span style="color: #666666">.</span>commit()
    <span style="color: #008000; font-weight: bold">return</span> redirect(url_for(<span style="color: #BA2121">&#39;old&#39;</span>))


<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>isfile(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>join(
        os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>dirname(__file__), <span
            style="color: #BA2121">&#39;sqlite.db&#39;</span>)):
        db<span style="color: #666666">.</span>create_all()
    app<span style="color: #666666">.</span>run(debug<span style="color: #666666">=</span><span style="color: #008000">True</span>)
</pre>
</div>
<p>
    <!-- We need to copy the app code since it contains the password to -->
    <!-- an existing gmail account. -->

<p>
    Creation of the <code>app</code> object is put in a separate file <code>app.py</code>:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">os</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask</span> <span
            style="color: #008000; font-weight: bold">import</span> Flask

app <span style="color: #666666">=</span> Flask(__name__)
app<span style="color: #666666">.</span>config[<span
            style="color: #BA2121">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color: #666666">=</span> <span
            style="color: #BA2121">&#39;sqlite:///sqlite.db&#39;</span>
app<span style="color: #666666">.</span>secret_key <span style="color: #666666">=</span> os<span style="color: #666666">.</span>urandom(<span
            style="color: #666666">24</span>)

<span style="color: #408080; font-style: italic"># Email settings</span>
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">base64</span>
app<span style="color: #666666">.</span>config<span style="color: #666666">.</span>update(
        MAIL_SERVER<span style="color: #666666">=</span><span style="color: #BA2121">&#39;smtp.gmail.com&#39;</span>,
        MAIL_PORT<span style="color: #666666">=587</span>,
        MAIL_USE_TLS<span style="color: #666666">=</span><span style="color: #008000">True</span>,
        MAIL_USERNAME <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;cbcwebsolvermail@gmail.com&#39;</span>,
        MAIL_PASSWORD <span style="color: #666666">=</span> base64<span
            style="color: #666666">.</span>decodestring(<span style="color: #BA2121">&#39;WGlmZmljdox0UFch&#39;</span>),
        MAIL_DEFAULT_SENDER <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;Some name &lt;name@gmail.com&gt;&#39;</span>
        )
</pre>
</div>
<p>
    The forms for the compute function and for the login is
    stored in a file called <code>forms.py</code>:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">wtforms</span> <span
        style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">wtf</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
            style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">ComputeForm</span>(wtf<span style="color: #666666">.</span>Form):
    A <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>FloatField(label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;\( A \)&#39;</span>, default<span
            style="color: #666666">=1.0</span>,
        validators<span style="color: #666666">=</span>[wtf<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()])
    b <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>FloatField(label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;\( b \)&#39;</span>, default<span
            style="color: #666666">=0.0</span>,
        validators<span style="color: #666666">=</span>[wtf<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()])
    w <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>FloatField(label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;\( w \)&#39;</span>, default<span
            style="color: #666666">=</span>pi,
        validators<span style="color: #666666">=</span>[wtf<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()])
    T <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>FloatField(label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;\( T \)&#39;</span>, default<span
            style="color: #666666">=18</span>,
        validators<span style="color: #666666">=</span>[wtf<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()])
    resolution <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>IntegerField(label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;resolution&#39;</span>, default<span
            style="color: #666666">=500</span>,
        validators<span style="color: #666666">=</span>[wtf<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()])

<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">db_models</span> <span style="color: #008000; font-weight: bold">import</span> db, User
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">flask.ext.wtf.html5</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">html5</span>

<span style="color: #408080; font-style: italic"># Standard Forms</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">register_form</span>(wtf<span
            style="color: #666666">.</span>Form):
    username <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>TextField(
        label<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;Username&#39;</span>, validators<span style="color: #666666">=</span>[wtf<span
            style="color: #666666">.</span>validators<span style="color: #666666">.</span>Required()])
    password <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>PasswordField(
        label<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;Password&#39;</span>, validators<span style="color: #666666">=</span>[
            wtf<span style="color: #666666">.</span>validators<span style="color: #666666">.</span>Required(),
            wtf<span style="color: #666666">.</span>validators<span style="color: #666666">.</span>EqualTo(
                <span style="color: #BA2121">&#39;confirm&#39;</span>, message<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;Passwords must match&#39;</span>)])
    confirm  <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>PasswordField(
        label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Confirm Password&#39;</span>,
        validators<span style="color: #666666">=</span>[wtf<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>Required()])
    email    <span style="color: #666666">=</span> html5<span style="color: #666666">.</span>EmailField(label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;Email&#39;</span>)
    notify   <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>BooleanField(label<span
            style="color: #666666">=</span><span style="color: #BA2121">&#39;Email notifications&#39;</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">validate</span>(<span
            style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">if</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> wtf<span style="color: #666666">.</span>Form<span
            style="color: #666666">.</span>validate(<span style="color: #008000">self</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">False</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span
            style="color: #666666">.</span>notify<span style="color: #666666">.</span>data <span
            style="color: #AA22FF; font-weight: bold">and</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span
            style="color: #666666">.</span>email<span style="color: #666666">.</span>data:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>notify<span
            style="color: #666666">.</span>errors<span style="color: #666666">.</span>append(
        <span style="color: #BA2121">&#39;Cannot send notifications without a valid email address&#39;</span>)
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">False</span>

        <span style="color: #008000; font-weight: bold">if</span> db<span style="color: #666666">.</span>session<span
            style="color: #666666">.</span>query(User)<span style="color: #666666">.</span>filter_by(
            username<span style="color: #666666">=</span><span style="color: #008000">self</span><span
            style="color: #666666">.</span>username<span style="color: #666666">.</span>data)<span
            style="color: #666666">.</span>count() <span style="color: #666666">&gt;</span> <span
            style="color: #666666">0</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>username<span
            style="color: #666666">.</span>errors<span style="color: #666666">.</span>append(<span
            style="color: #BA2121">&#39;User already exists&#39;</span>)
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">False</span>

        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">True</span>

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">login_form</span>(wtf<span style="color: #666666">.</span>Form):
    username <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>TextField(
        label<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;Username&#39;</span>, validators<span style="color: #666666">=</span>[wtf<span
            style="color: #666666">.</span>validators<span style="color: #666666">.</span>Required()])
    password <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>PasswordField(
        label<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;Password&#39;</span>, validators<span style="color: #666666">=</span>[wtf<span
            style="color: #666666">.</span>validators<span style="color: #666666">.</span>Required()])

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">validate</span>(<span
            style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">if</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> wtf<span style="color: #666666">.</span>Form<span
            style="color: #666666">.</span>validate(<span style="color: #008000">self</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">False</span>

        user <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get_user()

        <span style="color: #008000; font-weight: bold">if</span> user <span style="color: #AA22FF; font-weight: bold">is</span> <span
            style="color: #008000">None</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>username<span
            style="color: #666666">.</span>errors<span style="color: #666666">.</span>append(<span
            style="color: #BA2121">&#39;Unknown username&#39;</span>)
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">False</span>

        <span style="color: #008000; font-weight: bold">if</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> user<span style="color: #666666">.</span>check_password(<span
            style="color: #008000">self</span><span style="color: #666666">.</span>password<span style="color: #666666">.</span>data):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>password<span
            style="color: #666666">.</span>errors<span style="color: #666666">.</span>append(<span
            style="color: #BA2121">&#39;Invalid password&#39;</span>)
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">False</span>

        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">True</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_user</span>(<span
            style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">return</span> db<span
            style="color: #666666">.</span>session<span style="color: #666666">.</span>query(User)<span
            style="color: #666666">.</span>filter_by(
            username<span style="color: #666666">=</span><span style="color: #008000">self</span><span
            style="color: #666666">.</span>username<span style="color: #666666">.</span>data)<span
            style="color: #666666">.</span>first()
</pre>
</div>
<p>
    Database-related code for the SQLAlchemy database is collected in
    <code>db_models.py</code>:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">flask.ext.sqlalchemy</span> <span
        style="color: #008000; font-weight: bold">import</span> SQLAlchemy
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">werkzeug</span> <span style="color: #008000; font-weight: bold">import</span> generate_password_hash, check_password_hash
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">app</span> <span
            style="color: #008000; font-weight: bold">import</span> app

db <span style="color: #666666">=</span> SQLAlchemy(app)

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">User</span>(db<span
            style="color: #666666">.</span>Model):
    <span style="color: #008000">id</span> <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>Integer, primary_key<span style="color: #666666">=</span><span
            style="color: #008000">True</span>)
    username <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String(<span style="color: #666666">50</span>), unique<span
            style="color: #666666">=</span><span style="color: #008000">True</span>)
    pwhash <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String())
    email <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String(<span style="color: #666666">120</span>), nullable<span
            style="color: #666666">=</span><span style="color: #008000">True</span>)
    notify <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>Boolean())

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__repr__</span>(<span
            style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&#39;&lt;User </span><span
            style="color: #BB6688; font-weight: bold">%r</span><span style="color: #BA2121">&gt;&#39;</span> <span
            style="color: #666666">%</span> (<span style="color: #008000">self</span><span
            style="color: #666666">.</span>username)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">check_password</span>(<span
            style="color: #008000">self</span>, pw):
        <span style="color: #008000; font-weight: bold">return</span> check_password_hash(<span style="color: #008000">self</span><span
            style="color: #666666">.</span>pwhash, pw)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_password</span>(<span
            style="color: #008000">self</span>, pw):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>pwhash <span
            style="color: #666666">=</span> generate_password_hash(pw)

    <span style="color: #008000; font-weight: bold">def</span> <span
            style="color: #0000FF">is_authenticated</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">True</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">is_active</span>(<span
            style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">True</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">is_anonymous</span>(<span
            style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">False</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_id</span>(<span
            style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span
            style="color: #666666">.</span>id

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Compute</span>(db<span style="color: #666666">.</span>Model):
    <span style="color: #008000">id</span> <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>Integer, primary_key<span style="color: #666666">=</span><span
            style="color: #008000">True</span>)

    A <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String())
    b <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String())
    w <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String())
    T <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String())
    resolution <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>Integer)

    result <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String())
    comments <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>String(), nullable<span style="color: #666666">=</span><span
            style="color: #008000">True</span>)
    user_id <span style="color: #666666">=</span> db<span style="color: #666666">.</span>Column(db<span
            style="color: #666666">.</span>Integer, db<span style="color: #666666">.</span>ForeignKey(<span
            style="color: #BA2121">&#39;user.id&#39;</span>))
    user <span style="color: #666666">=</span> db<span style="color: #666666">.</span>relationship(<span
            style="color: #BA2121">&#39;User&#39;</span>,
           backref<span style="color: #666666">=</span>db<span style="color: #666666">.</span>backref(<span
            style="color: #BA2121">&#39;Compute&#39;</span>, lazy<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39;dynamic&#39;</span>))
</pre>
</div>
<p>
    Finally, we need views. For the results of the computation we have
    a <code>view.html</code> file that is very similar to <code>view_table.html</code>
    in the <code>vib1</code> app:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;html</span> <span style="color: #7D9029">lang=</span><span
            style="color: #BA2121">&quot;en&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;head&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;meta</span> <span style="color: #7D9029">charset=</span><span
            style="color: #BA2121">&quot;utf-8&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;title&gt;</span>Flask Vib app<span
            style="color: #008000; font-weight: bold">&lt;/title&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/head&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;body&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/x-mathjax-config&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
MathJax.Hub.Config({
  TeX<span style="color: #666666">:</span> {
     equationNumbers<span style="color: #666666">:</span> {  autoNumber<span style="color: #666666">:</span> <span
            style="color: #BA2121">&quot;AMS&quot;</span>  },
     extensions<span style="color: #666666">:</span> [<span style="color: #BA2121">&quot;AMSmath.js&quot;</span>, <span
            style="color: #BA2121">&quot;AMSsymbols.js&quot;</span>, <span style="color: #BA2121">&quot;autobold.js&quot;</span>, <span
            style="color: #BA2121">&quot;color.js&quot;</span>]
  }
});
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/javascript&quot;</span> <span style="color: #7D9029">src=</span>
<span style="color: #BA2121">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>

{% if user.is_anonymous() %}
  <span style="color: #008000; font-weight: bold">&lt;p</span> <span style="color: #7D9029">align=</span><span
            style="color: #BA2121">&quot;right&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;a</span> <span style="color: #7D9029">href=</span><span
            style="color: #BA2121">&quot;/login&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>Login<span
            style="color: #008000; font-weight: bold">&lt;/a&gt;</span>
  / <span style="color: #008000; font-weight: bold">&lt;a</span> <span style="color: #7D9029">href=</span><span
            style="color: #BA2121">&quot;/reg&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>Register<span
            style="color: #008000; font-weight: bold">&lt;/a&gt;&lt;/p&gt;</span>
{% else %}
  <span style="color: #008000; font-weight: bold">&lt;p</span> <span style="color: #7D9029">align=</span><span
            style="color: #BA2121">&quot;right&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>Logged in as {{user.username}}<span
            style="color: #008000; font-weight: bold">&lt;br&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;a</span> <span style="color: #7D9029">href=</span><span
            style="color: #BA2121">&quot;/old&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>Previous simulations<span
            style="color: #008000; font-weight: bold">&lt;a/&gt;&lt;br&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;a</span> <span style="color: #7D9029">href=</span><span
            style="color: #BA2121">&quot;/logout&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>Logout<span
            style="color: #008000; font-weight: bold">&lt;/a&gt;&lt;/p&gt;</span>
{% endif %}

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #408080; font-style: italic">&lt;!-- Input and Results are typeset as a two-column table --&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td</span> <span style="color: #7D9029">valign=</span><span
            style="color: #BA2121">&quot;top&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Input:<span style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span> <span
            style="color: #7D9029">enctype=</span><span style="color: #BA2121">multipart/form-data</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field(size=20) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>
      {% if field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;ul</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
        {% for error in field.errors %}
          <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
        {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
      {% endif %}
      <span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;Compute&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/td&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;td</span> <span style="color: #7D9029">valign=</span><span
            style="color: #BA2121">&quot;top&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  {% if result != None %}
    <span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Results:<span
            style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;data:image/png;base64,{{ result|safe }}&quot;</span> <span
            style="color: #7D9029">width=</span><span style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
    {% if not user.is_anonymous() %}
      <span style="color: #008000; font-weight: bold">&lt;h3&gt;</span>Comments:<span
            style="color: #008000; font-weight: bold">&lt;/h3&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">&quot;post&quot;</span> <span style="color: #7D9029">action=</span><span
            style="color: #BA2121">&quot;/add_comment&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;textarea</span> <span
            style="color: #7D9029">name=</span><span style="color: #BA2121">&quot;comments&quot;</span> <span
            style="color: #7D9029">rows=</span><span style="color: #BA2121">&quot;4&quot;</span> <span
            style="color: #7D9029">cols=</span><span style="color: #BA2121">&quot;40&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/textarea&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span
            style="color: #7D9029">type=</span><span style="color: #BA2121">&quot;submit&quot;</span> <span
            style="color: #7D9029">value=</span><span style="color: #BA2121">&quot;Add&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
      {% endif %}

  {% endif %}
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
</pre>
</div>
<p>
    The <code>login.html</code> template for the login page takes the form

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;html</span> <span style="color: #7D9029">lang=</span><span
            style="color: #BA2121">&quot;en&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;head&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;meta</span> <span style="color: #7D9029">charset=</span><span
            style="color: #BA2121">&quot;utf-8&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;title&gt;</span>Flask Vib app<span
            style="color: #008000; font-weight: bold">&lt;/title&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/head&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Login:<span style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
    {% for field in form %}
      <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field(size=20) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>
            {% if field.errors %}
              <span style="color: #008000; font-weight: bold">&lt;ul</span> <span
            style="color: #7D9029">class=</span><span style="color: #BA2121">errors</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
              {% for error in field.errors %}
                <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
              {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
            {% endif %}<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
    {% endfor %}
  <span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span
            style="color: #7D9029">type=</span><span style="color: #BA2121">&quot;submit&quot;</span> <span
            style="color: #7D9029">value=</span><span style="color: #BA2121">&quot;Login&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
</pre>
</div>
<p>
    The page for registering a new user has a simple template <code>reg.html</code>:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;html</span> <span style="color: #7D9029">lang=</span><span
            style="color: #BA2121">&quot;en&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;head&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;meta</span> <span style="color: #7D9029">charset=</span><span
            style="color: #BA2121">&quot;utf-8&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;title&gt;</span>Flask Vib app<span
            style="color: #008000; font-weight: bold">&lt;/title&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/head&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Register:<span
            style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
   {% for field in form %}
     <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
         <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field(size=20) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>
            {% if field.errors %}
              <span style="color: #008000; font-weight: bold">&lt;ul</span> <span
            style="color: #7D9029">class=</span><span style="color: #BA2121">errors</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
              {% for error in field.errors %}
                <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
              {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
            {% endif %}<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
   {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Register</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
</pre>
</div>
<p>
    The final file is <code>old.html</code> for retrieving old simulations:

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;html</span> <span style="color: #7D9029">lang=</span><span
            style="color: #BA2121">&quot;en&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;head&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;meta</span> <span style="color: #7D9029">charset=</span><span
            style="color: #BA2121">&quot;utf-8&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;title&gt;</span>Flask Vib app<span
            style="color: #008000; font-weight: bold">&lt;/title&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/head&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;body&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/x-mathjax-config&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
MathJax.Hub.Config({
  TeX<span style="color: #666666">:</span> {
     equationNumbers<span style="color: #666666">:</span> {  autoNumber<span style="color: #666666">:</span> <span
            style="color: #BA2121">&quot;AMS&quot;</span>  },
     extensions<span style="color: #666666">:</span> [<span style="color: #BA2121">&quot;AMSmath.js&quot;</span>, <span
            style="color: #BA2121">&quot;AMSsymbols.js&quot;</span>, <span style="color: #BA2121">&quot;autobold.js&quot;</span>, <span
            style="color: #BA2121">&quot;color.js&quot;</span>]
  }
});
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;script </span><span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;text/javascript&quot;</span>
 <span style="color: #7D9029">src=</span><span style="color: #BA2121">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/script&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Previous simulations<span
            style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p</span> <span style="color: #7D9029">align=</span><span
            style="color: #BA2121">&quot;right&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;a</span> <span style="color: #7D9029">href=</span><span
            style="color: #BA2121">&quot;/&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>Back to index<span
            style="color: #008000; font-weight: bold">&lt;/a&gt;&lt;/p&gt;</span>
{% if data %}
  {% for post in data %}
    <span style="color: #008000; font-weight: bold">&lt;hr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td</span> <span style="color: #7D9029">valign=</span><span
            style="color: #BA2121">&quot;top&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;30%&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;h3&gt;</span>Input<span
            style="color: #008000; font-weight: bold">&lt;/h3&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
      {% for field in post.form %}
        <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}:<span
            style="color: #999999; font-weight: bold">&amp;nbsp;</span><span style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.data }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
      {% endfor %}
      <span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td</span> <span style="color: #7D9029">valign=</span><span
            style="color: #BA2121">&quot;top&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;60%&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;h3&gt;</span>Results<span
            style="color: #008000; font-weight: bold">&lt;/h3&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;data:image/png;base64,{{ post.result|safe }}&quot;</span> <span
            style="color: #7D9029">width=</span><span style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
    {% if True %}
      <span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
      {{ comments }}
    {% endif %}
    <span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;td</span> <span style="color: #7D9029">valign=</span><span
            style="color: #BA2121">&quot;top&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;60%&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">&quot;POST&quot;</span> <span style="color: #7D9029">action=</span><span
            style="color: #BA2121">&quot;/delete/{{ post.id }}&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">&quot;Delete&quot;</span>
       <span style="color: #7D9029">title=</span><span
            style="color: #BA2121">&quot;Delete this post from database&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
   {% endfor %}
   <span style="color: #008000; font-weight: bold">&lt;hr&gt;</span>
   <span style="color: #008000; font-weight: bold">&lt;center&gt;</span>
   <span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">&quot;POST&quot;</span> <span style="color: #7D9029">action=</span><span
            style="color: #BA2121">&quot;/delete/-1&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
     <span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">&quot;Delete all&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
   <span style="color: #008000; font-weight: bold">&lt;/form&gt;</span>
   <span style="color: #008000; font-weight: bold">&lt;/center&gt;</span>
{% else %}
  No previous simulations
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
</pre>
</div>
<p>
    <div class="alert alert-block alert-warning alert-text-normal">
        <b>Warning.</b>
<p>

<ul>
    <li> Sending email from the app does not work.</li>
    <li> Storing comments does not work.</li>
</ul>
</div>


<p>

    <!-- begin inline comment -->
    <font color="red">(<b>hpl 1</b>: Check if an autogenerated app from <code>_generate_app.py</code> can send mail and
        store comments. Need a <code>compute</code> function that returns full HTML text then.)</font>
    <!-- end inline comment -->

<h3 id="___sec59">Resources </h3>

<p>
    Working with a database in Flask is described here:

<ul>
    <li><a href="http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html" target="_self"><tt>http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html</tt></a>,
    </li>
    <li><a href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database" target="_self"><tt>http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database</tt></a>,
    </li>
    <li><a href="https://flask-login.readthedocs.org/en/latest/" target="_self">The Flask login extension</a></li>
</ul>

<!-- !split -->

<h2 id="wf:flask:upload">Uploading of files</h2>

<h3 id="___sec61">Overview of the application </h3>

<p>
    Many user interfaces need the user to provide data files. A minimalistic
    application is to have a button for uploading a single file.
    As example we use a file with a series of numbers, and the application's
    purpose is to compute the mean and standard deviation of the numbers.
    The first user interface just has the <em>Choose File</em> and <em>Compute</em> buttons:

<p>
    <center>
<p><img src="fig-web4sa/upload1.png" align="bottom" width=550></p></center>

<p>
    Clicking on <em>Choose File</em> brings up a file browser where the user can
    choose the file to uploaded to the application. Say this is a file
    <code>testfile.dat</code>. The interface now looks like

<p>
    <center>
<p><img src="fig-web4sa/upload2.png" align="bottom" width=550></p></center>

<p>
    Pressing thereafter <em>Compute</em> leads to storage of
    <code>testfile.dat</code> on the server in a subdirectory <code>uploads</code> and
    computation of basic statistics of the numbers in the file.
    The resulting output looks like

<p>
    <center>
<p><img src="fig-web4sa/upload3.png" align="bottom" width=550></p></center>

<p>
    The text &quot;No file chosen&quot; is automatically displayed by the
    widget object used for file upload and indicates that a new
    file can be chosen. Below we shall present all parts of the code
    needed to create this interactive application.

<h3 id="___sec62">The model class </h3>

<p>
    The widget <code>FieldField</code> is used for an input field with a <em>Choose File</em>
    button:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">wtforms</span> <span
        style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">wtf</span>

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Average</span>(wtf<span style="color: #666666">.</span>Form):
    filename   <span style="color: #666666">=</span> wtf<span style="color: #666666">.</span>FileField(validators<span
            style="color: #666666">=</span>
                               [wtf<span style="color: #666666">.</span>validators<span style="color: #666666">.</span>InputRequired()])
</pre>
</div>

<h3 id="___sec63">The controller file </h3>

<p>
    The controller file needs some special code to specify a directory
    to store uploaded files. We also include some code to check that
    the file has a name with the right extension.

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #408080; font-style: italic"># Relative path of directory for uploaded files</span>
UPLOAD_DIR <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;uploads/&#39;</span>

app<span style="color: #666666">.</span>config[<span style="color: #BA2121">&#39;UPLOAD_FOLDER&#39;</span>] <span
            style="color: #666666">=</span> UPLOAD_DIR
app<span style="color: #666666">.</span>secret_key <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;MySecretKey&#39;</span>

<span style="color: #008000; font-weight: bold">if</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>isdir(UPLOAD_DIR):
    os<span style="color: #666666">.</span>mkdir(UPLOAD_DIR)

<span style="color: #408080; font-style: italic"># Allowed file types for file upload</span>
ALLOWED_EXTENSIONS <span style="color: #666666">=</span> <span style="color: #008000">set</span>([<span
            style="color: #BA2121">&#39;txt&#39;</span>, <span style="color: #BA2121">&#39;dat&#39;</span>, <span
            style="color: #BA2121">&#39;npy&#39;</span>])

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">allowed_file</span>(filename):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Does filename have the right extension?&quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&#39;.&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">in</span> filename <span
            style="color: #AA22FF; font-weight: bold">and</span> \
           filename<span style="color: #666666">.</span>rsplit(<span style="color: #BA2121">&#39;.&#39;</span>, <span
            style="color: #666666">1</span>)[<span style="color: #666666">1</span>] <span
            style="color: #AA22FF; font-weight: bold">in</span> ALLOWED_EXTENSIONS
</pre>
</div>
<p>
    The <code>index</code> function must have code for saving the file, and as usual,
    calling the compute function and rendering a new page:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> Average(request<span style="color: #666666">.</span>form)
    filename <span style="color: #666666">=</span> <span style="color: #008000">None</span>  <span
            style="color: #408080; font-style: italic"># default</span>
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span>:

        <span style="color: #408080; font-style: italic"># Save uploaded file on server if it exists and is valid</span>
        <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>files:
            <span style="color: #008000">file</span> <span style="color: #666666">=</span> request<span
            style="color: #666666">.</span>files[form<span style="color: #666666">.</span>filename<span
            style="color: #666666">.</span>name]
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">file</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> allowed_file(<span
            style="color: #008000">file</span><span style="color: #666666">.</span>filename):
                <span style="color: #408080; font-style: italic"># Make a valid version of filename for any file ystem</span>
                filename <span style="color: #666666">=</span> secure_filename(<span
            style="color: #008000">file</span><span style="color: #666666">.</span>filename)
                <span style="color: #008000">file</span><span style="color: #666666">.</span>save(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>join(app<span
            style="color: #666666">.</span>config[<span style="color: #BA2121">&#39;UPLOAD_FOLDER&#39;</span>],
                                       filename))

        result <span style="color: #666666">=</span> compute_function(filename)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>

    <span style="color: #008000; font-weight: bold">return</span> render_template(<span style="color: #BA2121">&quot;view.html&quot;</span>, form<span
            style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)
</pre>
</div>

<h3 id="___sec64">The compute function </h3>

<p>
    We assume that the uploaded file is available in the <code>uploads</code>
    subdirectory, so the compute function needs to open this file, read
    the numbers, and compute statistics. The file reading and computations
    are easily done by <code>numpy</code> functions. The results are presented in
    an HTML table.

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span
        style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute_mean_std</span>(filename<span
            style="color: #666666">=</span><span style="color: #008000">None</span>):
    data <span style="color: #666666">=</span> np<span style="color: #666666">.</span>loadtxt(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;uploads&#39;</span>, filename))
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">Data from file &lt;tt&gt;</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&lt;/tt&gt;:</span>
<span style="color: #BA2121">&lt;p&gt;</span>
<span style="color: #BA2121">&lt;table border=1&gt;</span>
<span style="color: #BA2121">&lt;tr&gt;&lt;td&gt; mean    &lt;/td&gt;&lt;td&gt; </span><span
            style="color: #BB6688; font-weight: bold">%.3g</span><span
            style="color: #BA2121"> &lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #BA2121">&lt;tr&gt;&lt;td&gt; st.dev. &lt;/td&gt;&lt;td&gt; </span><span
            style="color: #BB6688; font-weight: bold">%.3g</span><span
            style="color: #BA2121"> &lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span> <span style="color: #666666">%</span> (filename, np<span
            style="color: #666666">.</span>mean(data), np<span style="color: #666666">.</span>std(data))
</pre>
</div>

<h3 id="___sec65">The HTML template </h3>

<p>
    Although the present minimalistic application only needs a very simple
    HTML template, we reuse a quite generic template known from previous examples,
    where the input variables are listed to the left and the output of the
    compute function is presented to the right. Such a template looks like

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #BC7A00">&lt;!DOCTYPE html&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;html&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;head&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;meta</span> <span style="color: #7D9029">charset=</span><span
            style="color: #BA2121">&quot;utf-8&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;title&gt;</span>Flask Average app<span
            style="color: #008000; font-weight: bold">&lt;/title&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/head&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;body&gt;</span>

  <span style="color: #408080; font-style: italic">&lt;!-- Input and Results are typeset as a two-column table --&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;td</span> <span style="color: #7D9029">valign=</span><span
            style="color: #BA2121">&quot;top&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Input:<span
            style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>

      <span style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
            style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span> <span
            style="color: #7D9029">enctype=</span><span
            style="color: #BA2121">&quot;multipart/form-data&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
          {% for field in form %}
            <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
                <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field(size=20) }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
                <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{% if field.errors %}
                  <span style="color: #008000; font-weight: bold">&lt;ul</span> <span
            style="color: #7D9029">class=</span><span style="color: #BA2121">errors</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
                  {% for error in field.errors %}
                    <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
                  {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
                {% endif %}<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
          {% endfor %}
        <span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span
            style="color: #7D9029">type=</span><span style="color: #BA2121">&quot;submit&quot;</span> <span
            style="color: #7D9029">value=</span><span style="color: #BA2121">&quot;Compute&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/form&gt;&lt;/p&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/td&gt;</span>

  <span style="color: #008000; font-weight: bold">&lt;td</span> <span style="color: #7D9029">valign=</span><span
            style="color: #BA2121">&quot;top&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
    {% if result != None %}
      <span style="color: #008000; font-weight: bold">&lt;h2&gt;</span>Results:<span
            style="color: #008000; font-weight: bold">&lt;/h2&gt;</span>
        {{ result|safe }}

    {% endif %}
  <span style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/body&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/html&gt;</span>
</pre>
</div>
<p>
    The complete set of files is found in the <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/upload"
        target="_self"><tt>upload</tt></a> directory.

<p>
    <!-- !split -->

<h1 id="wf:vib:django">Handling multiple input variables in Django</h1>

<p>
    We shall briefly how to work with multi-variable input in Django.
    The text is the Django counterpart to the section <a href="#wf:vib:flask">Handling multiple input variables in
    Flask</a>.
    There are four float input variables: \( A \), \( b \), \( w \), and \( T \).
    A function <code>compute</code> in the file <code>compute.py</code> makes
    a plot of the function \( u(t)=Ae^{-bt}\sin (wt) \)
    depending on these four parameters and returns
    the name of the plot file. Our task is to define four input fields,
    execute the <code>compute</code> function and show the input fields together with
    the resulting plot,
    cf. Figures <a href="#wf:vib1:flask:fig:input">7</a>
    and <a href="#wf:vib1:flask:fig:result">8</a>.

<h2 id="___sec67">Programming the Django application </h2>

<h3 id="___sec68">Adding the app to a project </h3>

<p>
    Any Django app needs a project, but here we reuse the project
    we set up for the scientific hello world examples. We go to
    the directory <code>apps/django_apps</code> and create the Django app <code>vib1</code>:

<p>

    <!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python ../../django_project/manage.py startapp vib1
</pre>
</div>
<p>
    Then we

<ol>
    <li> add <code>relative2absolute_path('../../apps/django_apps/vib1/templates'),</code>
        to the <code>TEMPLATE_DIRS</code> tuple in <code>settings.py</code>,
    </li>
    <li> add <code>vib1</code> to the <code>INSTALLED_APPS</code> tuple, and</li>
    <li> add <code>url(r'^vib1/', 'django_apps.vib1.views.index')</code> to the <code>patterns</code>
        call in <code>urls.py</code>.
    </li>
</ol>

These steps ensure that Django can find our application as a module/package,
that Django can find our templates associated with this application,
and that the URL address applies the name <code>vib1</code> to reach the application.

<h3 id="___sec69">The compute part </h3>

<p>
    The computations in our application are put in a file <code>compute.py</code>
    and explained in detail in the section <a href="#wf:vib1:flask:app">Programming the Flask application</a>.
    We can equally well utilize the Bokeh library for plotting using
    the code shown in the section <a href="#wf:bokeh:flask">Plotting with the Bokeh library</a>.

<h3 id="___sec70">The model </h3>

<p>
    We can now write <code>models.py</code> and the <code>Input</code> class that defines
    the form fields for the four input variables:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">django.db</span> <span style="color: #008000; font-weight: bold">import</span> models
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">django.forms</span> <span
            style="color: #008000; font-weight: bold">import</span> ModelForm
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
            style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Input</span>(models<span style="color: #666666">.</span>Model):
    A <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; amplitude (m)&#39;</span>, default<span
            style="color: #666666">=1.0</span>)
    b <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; damping coefficient (kg/s)&#39;</span>, default<span
            style="color: #666666">=0.0</span>)
    w <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; frequency (1/s)&#39;</span>, default<span
            style="color: #666666">=2*</span>pi)
    T <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39; time interval (s)&#39;</span>, default<span style="color: #666666">=18</span>)

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(ModelForm):
    <span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Meta</span>:
        model <span style="color: #666666">=</span> Input
</pre>
</div>
<p>
    Note here that we can provide a more explanatory name than just
    the variable name, e.g., <code>' amplitude (m)'</code> for <code>A</code>. However,
    Django will always capitalize these descriptions, so if one really
    needs lower case names (e.g., to be compatible with a mathematical notation
    or when just listing the unit),
    one must start the text with a space, as we have demonstrated above.
    We also provide a default
    value such that all fields have a value when the user sees
    the page.

<h3 id="___sec71">The view </h3>

<p>
    The <code>views.py</code> file looks as follows:

<p>

    <!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">django.shortcuts</span> <span
        style="color: #008000; font-weight: bold">import</span> render_to_response
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">django.template</span> <span
            style="color: #008000; font-weight: bold">import</span> RequestContext
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">django.http</span> <span
            style="color: #008000; font-weight: bold">import</span> HttpResponse
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">models</span> <span style="color: #008000; font-weight: bold">import</span> InputForm
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>(request):
    os<span style="color: #666666">.</span>chdir(os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>dirname(__file__))
    result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span>:
        form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>POST)
        <span style="color: #008000; font-weight: bold">if</span> form<span style="color: #666666">.</span>is_valid():
            form2 <span style="color: #666666">=</span> form<span style="color: #666666">.</span>save(commit<span
            style="color: #666666">=</span><span style="color: #008000">False</span>)
            result <span style="color: #666666">=</span> compute(form2<span style="color: #666666">.</span>A, form2<span
            style="color: #666666">.</span>b, form2<span style="color: #666666">.</span>w, form2<span
            style="color: #666666">.</span>T)
            result <span style="color: #666666">=</span> result<span style="color: #666666">.</span>replace(<span
            style="color: #BA2121">&#39;static/&#39;</span>, <span style="color: #BA2121">&#39;&#39;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        form <span style="color: #666666">=</span> InputForm()

    <span style="color: #008000; font-weight: bold">return</span> render_to_response(<span style="color: #BA2121">&#39;vib1.html&#39;</span>,
            {<span style="color: #BA2121">&#39;form&#39;</span>: form,
             <span style="color: #BA2121">&#39;result&#39;</span>: result,
             }, context_instance<span style="color: #666666">=</span>RequestContext(request))
</pre>
</div>
<p>
    Some remarks are necessary:

<ol>
    <li> Doing an <code>os.chdir</code> to the current working directory is necessary
        as Django may be left back in another working directory if you have
        tested other apps.
    </li>
    <li> The <code>form2</code> object from <code>form.save</code> is the object we extract
        data from and send to <code>compute</code>, but the original <code>form</code>
        object is needed when making the HTML page through the template.
    </li>
    <li> Images, media files, style sheets, javascript files, etc. must
        reside in a subdirectory <code>static</code>. The specifications of the
        URL applies tools to find this <code>static</code> directory and then
        the <code>static</code> prefix in the <code>result</code> filename must be removed.
    </li>
</ol>

The template for rendering the page is listed next.

<p>

    <!-- code=html (!bc htmlpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>{% csrf_token %}
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.errors }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Compute</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
{% load static %}
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{% get_static_prefix %}{{ result }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">500</span><span style="color: #008000; font-weight: bold">&gt;</span>
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
</pre>
</div>
<p>
    The tricky part is the syntax for displaying <em>static content</em>, such as
    the plot file made in the <code>compute</code> function.

<h2 id="___sec72">Custom validation </h2>

<p>
    Django has a series of methods available for user-provided validation
    of form data. These are exemplified in the app <code>vib2</code>, which
    is an extension of the <code>vib1</code> app with additional code. (This other
    app needs of course registrations in <code>settings.py</code> and <code>urls.py</code>, similar
    to what we did for the <code>vib1</code> app.)

<p>
    Making sure that \( A>0 \) is easiest done with a built-in Django
    validator for minimum value checking:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">Input</span>(models<span style="color: #666666">.</span>Model):
    A <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; amplitude (m)&#39;</span>, default<span
            style="color: #666666">=1.0</span>,
        validators<span style="color: #666666">=</span>[MinValueValidator(<span style="color: #666666">0</span>)])
</pre>
</div>
<p>
    We can write our own validators, which are functions taking the value
    is the only argument and raising a <code>ValidationError</code> exception if the
    value is wrong. Checking that a value is inside an interval can first
    be implemented by

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">check_interval</span>(value, min_value<span
        style="color: #666666">=</span><span style="color: #008000">None</span>, max_value<span
        style="color: #666666">=</span><span style="color: #008000">None</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Validate that a value is inside an interval.&quot;&quot;&quot;</span>
    failure <span style="color: #666666">=</span> <span style="color: #008000">False</span>
    <span style="color: #008000; font-weight: bold">if</span> min_value <span style="color: #AA22FF; font-weight: bold">is</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> value <span style="color: #666666">&lt;</span> min_value:
            failure <span style="color: #666666">=</span> <span style="color: #008000">True</span>
    <span style="color: #008000; font-weight: bold">if</span> max_value <span style="color: #AA22FF; font-weight: bold">is</span> <span
            style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> value <span style="color: #666666">&gt;</span> max_value:
            failure <span style="color: #666666">=</span> <span style="color: #008000">True</span>
    <span style="color: #008000; font-weight: bold">if</span> failure:
        <span style="color: #008000; font-weight: bold">raise</span> ValidationError(
            <span style="color: #BA2121">&#39;value=</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> not in [</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">, </span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">]&#39;</span> <span
            style="color: #666666">%</span>
            (value,
             <span style="color: #BA2121">&#39;-infty&#39;</span> <span
            style="color: #008000; font-weight: bold">if</span> min_value <span
            style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span> <span
            style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>(min_value),
             <span style="color: #BA2121">&#39;infty&#39;</span> <span
            style="color: #008000; font-weight: bold">if</span> max_value <span
            style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span> <span
            style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>(max_value)))
</pre>
</div>
<p>
    However, this function takes more than the value as argument. We therefore
    need to wrap it by a function with <code>value</code> as the only argument. The following
    utility returns such a
    function (see the section <a href="#wf:vib1:flask:validation">Custom validation</a> for more
    explanation):

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">functools</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">interval</span>(min_value<span
            style="color: #666666">=</span><span style="color: #008000">None</span>, max_value<span
            style="color: #666666">=</span><span style="color: #008000">None</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Django-compatible interface to check_interval.&quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">return</span> functools<span style="color: #666666">.</span>partial(
        check_interval, min_value<span style="color: #666666">=</span>min_value, max_value<span
            style="color: #666666">=</span>max_value)
</pre>
</div>
<p>
    Now, <code>interval(0, 1)</code> returns a function that takes <code>value</code> as its
    only argument and checks if it is inside \( [0,1] \).
    Such a function can be inserted in the <code>validators</code> list in
    the field constructor, here to tell that \( b \) must be in \( [0,\infty) \):

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">Input</span>(models<span style="color: #666666">.</span>Model):
    <span style="color: #666666">...</span>
    b <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; damping coefficient (kg/s)&#39;</span>, default<span
            style="color: #666666">=0.0</span>,
        validators<span style="color: #666666">=</span>[interval(<span style="color: #666666">0</span>,<span
            style="color: #008000">None</span>)])
</pre>
</div>
<p>
    A final example on custom validation is to avoid plotting more
    than 30 periods of the oscillating function \( u \). This translates
    to checking that \( T \) is geater
    than 30 periods, i.e., \( T>30\cdot 2\pi/w \). The task is done in
    the <code>InputForm</code> class, where any method <code>clean_name</code> can do
    validation and adjustment of the field name <code>name</code>. The code for
    a <code>clean_T</code> method goes as follows:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>(ModelForm):
    <span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Meta</span>:
        model <span style="color: #666666">=</span> Input

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">clean_T</span>(<span
            style="color: #008000">self</span>):
        T <span style="color: #666666">=</span> <span style="color: #008000">self</span><span
            style="color: #666666">.</span>cleaned_data[<span style="color: #BA2121">&#39;T&#39;</span>]
        w <span style="color: #666666">=</span> <span style="color: #008000">self</span><span
            style="color: #666666">.</span>cleaned_data[<span style="color: #BA2121">&#39;w&#39;</span>]
        period <span style="color: #666666">=</span> <span style="color: #666666">2*</span>pi<span
            style="color: #666666">/</span>w
        <span style="color: #008000; font-weight: bold">if</span> T <span style="color: #666666">&gt;</span> <span
            style="color: #666666">30*</span>period:
            num_periods <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span
            style="color: #008000">round</span>(T<span style="color: #666666">/</span>period))
            <span style="color: #008000; font-weight: bold">raise</span> ValidationError(
                <span style="color: #BA2121">&#39;Cannot plot as much as </span><span
            style="color: #BB6688; font-weight: bold">%d</span><span
            style="color: #BA2121"> periods! T &lt; </span><span
            style="color: #BB6688; font-weight: bold">%.2f</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span>
                (num_periods, <span style="color: #666666">30*</span>period))
        <span style="color: #008000; font-weight: bold">return</span> T
</pre>
</div>
<p>
    We refer to the vast Django documentation for many other ways of
    validating forms. The reader is encouraged to run the <code>vib2</code>
    application and test out the validations we have implemented.

<h2 id="___sec73">Customizing widgets </h2>

<p>
    One will occasionally have full control of the layout of the individual
    elements in a web form. These are typeset inside <code>input</code> tags in
    HTML. Django associates the term <em>widget</em> with an HTML form field. To set
    the size (width) of the field and other properties, one must in
    Django specify a <code>widgets</code> dictionary in the form class. The key
    is the name of the parameter in the model class, while the value
    is a widget class name. Standard input fields for numbers and
    text apply the <code>TextInput</code> widget. An example
    on setting the size of the <code>T</code> field to a width of 10 characters goes
    like

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">django.forms</span> <span
        style="color: #008000; font-weight: bold">import</span> TextInput

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(ModelForm):
    <span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Meta</span>:
        model <span style="color: #666666">=</span> Input
        widgets <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&#39;T&#39;</span>: TextInput(attrs<span style="color: #666666">=</span>{<span
            style="color: #BA2121">&#39;size&#39;</span>: <span style="color: #666666">10</span>}),
        }
</pre>
</div>
<p>
    At the time of this writing, Django does not yet support the many
    additional HTML5 input fields. Nevertheless, the <code>parampool</code> package
    gives access to HTML5 widgets in a Django context.
    We recommend to use <code>parampool</code> to automatically generate the necessary
    Django files, and
    then one can view the form class in the <code>models.py</code> file for how
    HTML5 widgets can be used in the definition of the <code>widgets</code>
    dictionary.

<p>
    <!-- !split -->

<h2 id="___sec74">Resources </h2>

<p>
    Below are some resources for accounts and login with Django as well as
    utilization of Bootstrap styles in the views.

<ul>
    <li><a href="https://docs.djangoproject.com/en/dev/topics/auth/default/#user-objects" target="_self">Django: make
        user</a></li>
    <li><a href="https://docs.djangoproject.com/en/dev/topics/db/queries/" target="_self">Django: read and write
        database</a></li>
    <li><a href="http://stackoverflow.com/questions/11821116/django-and-bootstrap-what-app-is-recommended"
           target="_self"><tt>http://stackoverflow.com/questions/11821116/django-and-bootstrap-what-app-is-recommended</tt></a>
    </li>
    <li><a href="https://github.com/dyve/django-bootstrap3"
           target="_self"><tt>https://github.com/dyve/django-bootstrap3</tt></a></li>
    <li><a href="https://www.youtube.com/watch?v=3Bwl5CYa5Uc" target="_self"><tt>https://www.youtube.com/watch?v=3Bwl5CYa5Uc</tt></a>
    </li>
</ul>

<!-- !split -->

<h1 id="___sec75">Exercises </h1>

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:add2">Exercise 1: Add two numbers</h2>

<p>
    Make a web application that reads two numbers from a web page,
    adds the numbers, and prints the sum in a new web page.
    Package the necessary files that constitute the application
    in a tar file.
    Filename: <code>add2.tar.gz</code>.

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:upload">Exercise 2: Upload data file and visualize curves</h2>

<p>
    Suppose you have tabular data in a file:

<p>

    <!-- code=text (!bc dat) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">#  t        y       error
0.0000    1.2345   1.4E-4
1.0000    0.9871  -4.9E-3
1.2300    0.5545   8.2E-3
</pre>
</div>
<p>
    That is, there is a comment line with headings for the various
    columns, and then floating-point values are listed with an
    arbitrary number of columns and rows. You want to upload such
    a data file to a web application and have the each column, from
    the second one, plotted against the the values in the first column.
    In the particular example, <code>y</code> and <code>error</code> should be plotted against
    <code>t</code>, yielding two curves.

<p>
    The web application may have one field: the name of the file to upload.
    Search for constructions on how to upload a files and write this
    application. Generate a suitable data file for testing purposes.
    Filename: <code>upload.tar.gz</code>.

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:formula">Exercise 3: Plot a user-specified formula</h2>

<p>
    The purpose of this exercise is to write a web application that
    can visualize any user-given formula. For example, in the interface below,

<p>
    <center>
<p><img src="fig-web4sa/plot_formula.png" align="bottom" width=600></p></center>

<p>
    the user has

<ul>
    <li> specified a curve \( \sin (x) \) (<code>sin(x)</code>) to be plotted</li>
    <li> specified the \( x \) interval to be \( [0,2\pi] \) (<code>[0, 2*pi]</code>)</li>
    <li> clicked <em>Compute</em> to get a blue line with the sine curve</li>
    <li> specified a new formula \( \sin(x)e^{-x} \) (<code>sin(x)*exp(-x)</code>)</li>
    <li> chosen <em>No</em> as the answer to <em>Erase all curves?</em></li>
    <li> clicked <em>Compute</em> to have the \( \sin(x)e^{-x} \) drawn
        with green line without erasing the previous curve
    </li>
</ul>

That is, the user can fill in any expression in \( x \), specify the
domain for plotting, and choose whether new curves should be added
to the plot or if all curves should be erased prior to drawing a
new one.

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 1.</b>
    You may use the <code>vib1</code> app from the section <a href="#wf:vib1:flask:app">Programming the Flask
    application</a>
    with the <code>view_errcheck.html</code> template as starting point.
    Preferably, let plots be created as strings, as explained for the <code>vib2</code>
    app in the section <a href="#wf:vib2:flask:nofiles">Avoiding plot files</a>.

<p>
    The <em>Formula</em> and <em>Domain</em> fields need to be <code>TextField</code> objects,
    and the compute function must perform an <code>eval</code> on the user's input.
    The <em>Erase</em> field is a <code>SelectField</code> object with selections <em>Yes</em> and
    <em>No</em>. The former means that the compute function calls the <code>figure</code>
    function in Matplotlib before creating a new plot. If this is not
    done, a new formula will be plotting in the same figure as the last one.
    With the Yes/No selection, it is possible either plot individual curves
    or compare curves in the same plot.

<p>
    <!-- --- end hint in exercise --- -->

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 2.</b>
    Performing <code>eval</code> on the user's input requires that names like
    <code>sin</code>, <code>exp</code>, and <code>pi</code> are defined. The simplest approach is to
    do a

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">numpy</span> <span
        style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
</pre>
</div>
<p>
    in the top of the file containing the compute function. All the names
    from <code>numpy</code> are then available as global variables and one can simply
    do <code>domain = eval(domain)</code> to turn the string <code>domain</code> coming from
    the <em>Domain</em> text field into a Python list with two elements.

<p>
    A better approach is not to rely on global variables, but run <code>eval</code>
    in the <code>numpy</code> namespace:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">numpy</span>
domain <span style="color: #666666">=</span> <span style="color: #008000">eval</span>(domain, numpy<span
            style="color: #666666">.</span>__dict__)
</pre>
</div>
<p>
    The evaluation of the formula is slightly more complicated if <code>eval</code>
    is to be run with the <code>numpy</code> namespace. One first needs
    to create \( x \) coordinates:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">x <span
        style="color: #666666">=</span> numpy<span style="color: #666666">.</span>linspace(domain[<span
        style="color: #666666">0</span>], domain[<span style="color: #666666">1</span>], <span style="color: #666666">10001</span>)
</pre>
</div>
<p>
    Now, <code>eval(formula, numpy.__dict__)</code> will not work because a formula
    like <code>sin(x)</code> needs both <code>sin</code> and <code>x</code> in the namespace. The latter
    is not in the namespace and must be explicitly included. A new namespace
    can be made:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">namespace <span
        style="color: #666666">=</span> numpy<span style="color: #666666">.</span>__dict__<span
        style="color: #666666">.</span>copy()
namespace<span style="color: #666666">.</span>update({<span style="color: #BA2121">&#39;x&#39;</span>: x})
formula <span style="color: #666666">=</span> <span style="color: #008000">eval</span>(formula, namespace)
</pre>
</div>
<p>
    <!-- --- end hint in exercise --- -->

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 3.</b>
    You should add tests when evaluating and using the strings from input
    as these may have wrong syntax.

<p>
    <!-- --- end hint in exercise --- -->
    Filename: <code>plot_formula.tar.gz</code>.

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:Taylor">Exercise 4: Visualize Taylor polynomial approximations</h2>

<p>
    This exercise develops a web application that can plot Taylor polynomial
    approximations of <em>any</em> degree
    to <em>any</em> user-given formula. You should do
    <a href="#wf:exer:formula">Exercise 3: Plot a user-specified formula</a> first as many of the techniques there
    must be used and even further developed in the present exercise.

<p>
    The figure below shows an example of what one can do in the
    web app:

<p>
    <center>
<p><img src="fig-web4sa/Taylor_approx.png" align="bottom" width=600></p></center>

<p>
    Here, the user has

<ul>
    <li> filled in the formula \( \sin(x) \) (<code>sin(x)</code>)</li>
    <li> specified <em>N</em> to be 3</li>
    <li> clicked <em>Compute</em> to get the formula \( \sin(x) \) plotted together with
        the Taylor polynomial approximation of degree 3, expanded around \( x=0 \)
    </li>
    <li> changed <em>N</em> to 5</li>
    <li> chosen <em>No</em> for the question <em>Erase all curves?</em></li>
    <li> clicked <em>Compute</em> to have the series expansion of degree 5 plotted
        in the same plot
    </li>
    <li> changed <em>N</em> to 10</li>
    <li> clicked <em>Compute</em> to have the series expansion of degree 10 plotted
        in the same plot
    </li>
</ul>

We can use <code>sympy</code> to produce Taylor polynomial expansions of arbitrary
expressions. Here is a session demonstrating how to obtain the
series expansion of \( e^{-x}\sin (\pi x) \) to 2nd degree.

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">&gt;&gt;&gt;</span> <span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">sympy</span> <span style="color: #008000; font-weight: bold">as</span> <span
        style="color: #0000FF; font-weight: bold">sp</span>
<span style="color: #666666">&gt;&gt;&gt;</span> x <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>symbols(<span
            style="color: #BA2121">&#39;x&#39;</span>)
<span style="color: #666666">&gt;&gt;&gt;</span> f <span style="color: #666666">=</span> sp<span style="color: #666666">.</span>exp(<span
            style="color: #666666">-</span>x)<span style="color: #666666">*</span>sp<span
            style="color: #666666">.</span>sin(sp<span style="color: #666666">.</span>pi<span
            style="color: #666666">*</span>x)
<span style="color: #666666">&gt;&gt;&gt;</span> f<span style="color: #666666">.</span>series(x, <span
            style="color: #666666">0</span>, <span style="color: #666666">3</span>)
pi<span style="color: #666666">*</span>x <span style="color: #666666">-</span> pi<span
            style="color: #666666">*</span>x<span style="color: #666666">**2</span> <span
            style="color: #666666">+</span> O(x<span style="color: #666666">**3</span>)
<span style="color: #666666">&gt;&gt;&gt;</span> sp<span style="color: #666666">.</span>latex(f<span
            style="color: #666666">.</span>series(x, <span style="color: #666666">0</span>, <span
            style="color: #666666">3</span>))
<span style="color: #BA2121">&#39;</span><span style="color: #BB6622; font-weight: bold">\\</span><span
            style="color: #BA2121">pi x - </span><span style="color: #BB6622; font-weight: bold">\\</span><span
            style="color: #BA2121">pi x^{2} + </span><span style="color: #BB6622; font-weight: bold">\\</span><span
            style="color: #BA2121">mathcal{O}</span><span style="color: #BB6622; font-weight: bold">\\</span><span
            style="color: #BA2121">left(x^{3}</span><span style="color: #BB6622; font-weight: bold">\\</span><span
            style="color: #BA2121">right)&#39;</span>
<span style="color: #666666">&gt;&gt;&gt;</span> fs <span style="color: #666666">=</span> f<span style="color: #666666">.</span>series(x, <span
            style="color: #666666">0</span>, <span style="color: #666666">3</span>)<span style="color: #666666">.</span>removeO()  <span
            style="color: #408080; font-style: italic"># get rid of O() term</span>
<span style="color: #666666">&gt;&gt;&gt;</span> fs
<span style="color: #666666">-</span>pi<span style="color: #666666">*</span>x<span
            style="color: #666666">**2</span> <span style="color: #666666">+</span> pi<span
            style="color: #666666">*</span>x
<span style="color: #666666">&gt;&gt;&gt;</span> f_func <span style="color: #666666">=</span> sp<span
            style="color: #666666">.</span>lambdify([x], fs)     <span style="color: #408080; font-style: italic"># make Python function</span>
<span style="color: #666666">&gt;&gt;&gt;</span> f_func(<span style="color: #666666">1</span>)
<span style="color: #666666">0.0</span>
<span style="color: #666666">&gt;&gt;&gt;</span> f_func(<span style="color: #666666">2</span>)
<span style="color: #666666">-6.283185307179586</span>
</pre>
</div>
<p>
    Basically, the steps above must be carried out to create a Python
    function for the series expansion such that it can be plotted.
    A similar <code>sp.lambdify</code> call on the original formula is also necessary
    to plot that one.

<p>
    However, the challenge is that the formula is available only as a
    string, and it may contain an independent variable whose name is also
    only available through a string from the web interface. That is, we
    may give formulas like <code>exp(-t)</code> if <code>t</code> is chosen as independent
    variable. Also, the expression does not contain function names
    prefixed with <code>sympy</code> or <code>sp</code>, just plain names like <code>sin</code>, <code>cos</code>,
    <code>exp</code>, etc. An example on <code>formula</code> is <code>cos(pi*x) + log(x)</code>.

<p>
    <b>a)</b>
    Write a function

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">formula2series2pyfunc</span>(formula, N, x, x0<span
        style="color: #666666">=0</span>):
</pre>
</div>
<p>
    that takes a <code>sympy</code> formula, and integer <code>N</code>, a <code>sympy</code> symbol <code>x</code>
    and another <code>sympy</code> symbol <code>x0</code> and returns
    1) a Python function for <code>formula</code>, 2) a Python function for the
    series expansion of degree <code>N</code> of the formula around <code>x0</code>, and
    3) a LaTeX string containing the formula for the series expansion.

<p>
    Put the function in a file <code>compute.py</code>. You should thereafter be able to run
    the following session:

<p>

    <!-- code=python (!bc pyshell) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">&gt;&gt;&gt;</span> <span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">compute</span>
<span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">sympy</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">sp</span>
<span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">sympy</span> <span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #666666">*</span>
<span style="color: #666666">&gt;&gt;&gt;</span> t <span style="color: #666666">=</span> symbols(<span
            style="color: #BA2121">&#39;t&#39;</span>)
<span style="color: #666666">&gt;&gt;&gt;</span> formula <span style="color: #666666">=</span> exp(<span
            style="color: #666666">-2*</span>t)
<span style="color: #666666">&gt;&gt;&gt;</span> f, s, latex <span style="color: #666666">=</span> compute<span
            style="color: #666666">.</span>formula2series2pyfunc(formula, <span style="color: #666666">3</span>, t)
<span style="color: #666666">&gt;&gt;&gt;</span> latex
<span style="color: #BA2121">&#39;- </span><span style="color: #BB6622; font-weight: bold">\\</span><span
            style="color: #BA2121">frac{4 t^{3}}{3} + 2 t^{2} - 2 t + 1&#39;</span>
<span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">numpy</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #666666">&gt;&gt;&gt;</span> t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span
            style="color: #666666">0</span>, <span style="color: #666666">2</span>)
<span style="color: #666666">&gt;&gt;&gt;</span> plt<span style="color: #666666">.</span>plot(t, f(t), t, s(t))
[<span style="color: #666666">&lt;</span>matplotlib<span style="color: #666666">.</span>lines<span
            style="color: #666666">.</span>Line2D at <span style="color: #666666">0x7fc6c020f350&gt;</span>,
 <span style="color: #666666">&lt;</span>matplotlib<span style="color: #666666">.</span>lines<span
            style="color: #666666">.</span>Line2D at <span style="color: #666666">0x7fc6c020f5d0&gt;</span>]
<span style="color: #666666">&gt;&gt;&gt;</span> plt<span style="color: #666666">.</span>show()
</pre>
</div>
<p>
    The resulting plot is displayed below.

<p>
    <center>
<p><img src="fig-web4sa/Taylor_approx_exp2t.png" align="bottom" width=500></p></center>

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint.</b>
    The series expansion is obtained by <code>formula.series(x, x0, N)</code>,
    but the output contains an <code>O()</code> term which makes it impossible to
    convert the expression to a Python function via <code>sympy.lambify</code>.
    Use

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">series <span
        style="color: #666666">=</span> formula<span style="color: #666666">.</span>series(x, x0, N<span
        style="color: #666666">+1</span>)<span style="color: #666666">.</span>removeO()
</pre>
</div>
<p>
    to get an expression that can be used as argument to <code>sympy.lambdify</code>.
    We use <code>N+1</code> since <code>N</code> in the <code>series</code> function refers to the degree
    of the <code>O()</code> term, which is now removed.

<p>
    For the LaTeX expression it is natural to have the <code>O()</code> term:
<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">latex <span
        style="color: #666666">=</span> sympy<span style="color: #666666">.</span>latex(formula<span
        style="color: #666666">.</span>series(x, x0, N<span style="color: #666666">+1</span>))
</pre>
</div>
<p>
    because then the terms start with the lowest order (and not the highest
    order as is the case when <code>removeO()</code> is used).

<p>
    <!-- --- end hint in exercise --- -->

<p>
    <b>b)</b>
    Write the compute function:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">visualize_series</span>(
    formula,                  <span style="color: #408080; font-style: italic"># string: formula</span>
    independent_variable,     <span style="color: #408080; font-style: italic"># string: name of independent var.</span>
    N,                        <span
            style="color: #408080; font-style: italic"># int: degree of polynomial approx.</span>
    xmin, xmax, ymin, ymax,   <span style="color: #408080; font-style: italic"># strings: extent of axes</span>
    legend_loc,               <span style="color: #408080; font-style: italic"># string: upper left, etc.</span>
    x0<span style="color: #666666">=</span><span style="color: #BA2121">&#39;0&#39;</span>,                   <span
            style="color: #408080; font-style: italic"># string: point of expansion</span>
    erase<span style="color: #666666">=</span><span style="color: #BA2121">&#39;yes&#39;</span>,              <span
            style="color: #408080; font-style: italic"># string: &#39;yes&#39; or &#39;no&#39;</span>
    ):
</pre>
</div>
<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 1.</b>
    Converting the string <code>formula</code> to a valid <code>sympy</code> expression is
    challenging. First, create a local variable for a <code>sympy</code> symbol
    with the content of
    <code>independent_variable</code> as name, since such a variable is needed
    with performing <code>eval</code> on <code>formula</code>. Also introduce a variable <code>x</code>
    to point to the same <code>sympy</code> symbol. Relevant code is

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #408080; font-style: italic"># Turn independent variable into sympy symbol, stored in x</span>
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">sympy</span> <span
            style="color: #008000; font-weight: bold">as</span> <span
            style="color: #0000FF; font-weight: bold">sp</span>
<span style="color: #008000; font-weight: bold">exec</span>(<span style="color: #BA2121">&#39;x = </span><span
            style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> = sp.symbols(&quot;</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&quot;)&#39;</span> <span
            style="color: #666666">%</span>
     (independent_variable, independent_variable))
</pre>
</div>
<p>
    <!-- --- end hint in exercise --- -->

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 2.</b>
    Evaluating <code>formula</code> in the namespace of <code>sympy</code> (so that all the <code>sin</code>,
    <code>exp</code>, <code>pi</code>, and similar symbols are defined properly as <code>sympy</code>
    objects) needs a merge of the <code>sympy</code> namespace and the variable for
    the <code>sympy</code> symbol representing the independent variable:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">namespace <span
        style="color: #666666">=</span> sp<span style="color: #666666">.</span>__dict__<span
        style="color: #666666">.</span>copy()
local <span style="color: #666666">=</span> {}
local[independent_variable] <span style="color: #666666">=</span> x
namespace<span style="color: #666666">.</span>update(local)
formula <span style="color: #666666">=</span> <span style="color: #008000">eval</span>(formula, namespace)
</pre>
</div>
<p>
    Turning <code>x0</code> into a valid <code>sympy</code> expression is easier: <code>x0 = eval(x0,
    sp.__dict__)</code>.

<p>
    <!-- --- end hint in exercise --- -->

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 3.</b>
    Note that in the web interface, the minimum and maximum values on the axis
    can be mathematical expressions such as <code>2*pi</code>. This means that these
    quantities must be strings that are evaluated in the <code>numpy</code> namespace, e.g.,

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span
        style="color: #0000FF; font-weight: bold">np</span>
xmin <span style="color: #666666">=</span> <span style="color: #008000">eval</span>(xmin, np<span
            style="color: #666666">.</span>__dict__)
</pre>
</div>
<p>
    <!-- --- end hint in exercise --- -->

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 4.</b>
    Getting the legends right when plotting multiple curves in the same
    plot is a bit tricky. One solution is to have a global variable <code>legends</code>
    that is initialized to <code>[]</code> and do the following inside the compute function:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span
        style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #008000; font-weight: bold">global</span> legends
<span style="color: #008000; font-weight: bold">if</span> erase <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;yes&#39;</span>:   <span style="color: #408080; font-style: italic"># Start new figure?</span>
    plt<span style="color: #666666">.</span>figure()
    legends <span style="color: #666666">=</span> []
<span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> legends:
    <span style="color: #408080; font-style: italic"># We come here every time the figure is empty so</span>
    <span style="color: #408080; font-style: italic"># we need to draw the formula</span>
    legends<span style="color: #666666">.</span>append(<span style="color: #BA2121">&#39;$</span><span
            style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">$&#39;</span> <span
            style="color: #666666">%</span> sp<span style="color: #666666">.</span>latex(formula))
    plt<span style="color: #666666">.</span>plot(x, f(x))
</pre>
</div>
<p>
    Here, <code>f</code> is the Python function for computing the <code>numpy</code> variant
    of the expression in <code>formula</code>.

<p>
    <!-- --- end hint in exercise --- -->

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 5.</b>
    Use the test block in the file to call the compute function several
    times with different values of the <code>erase</code> parameter to test that
    the erase functionality is correct.

<p>
    <!-- --- end hint in exercise --- -->

<p>
    <b>c)</b>
    Write the remaining files. These have straightforward content if
    <a href="#wf:exer:formula">Exercise 3: Plot a user-specified formula</a> is done and understood.

<p>
    Filename: <code>Taylor_approx.tar.gz</code>.

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:gen:demo">Exercise 5: Extend the <code>gen</code> app</h2>

<p>
    Add a new argument <code>x_axis</code> to the <code>compute</code> function in the
    <a href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen"
       target="_self"><tt>gen</tt></a>
    application from the section <a href="#wf:autogen:flask">Autogenerating the code</a>. The <code>x_axis</code>
    argument measures the extent
    of the \( x \) axis in the plots in terms of the number of standard
    deviations (default may be 7). Observe how the web interface
    automatically adds the new argument and how the plots adapt!

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:addmul">Exercise 6: Make a web app with multiple apps</h2>

<p>
    The purpose of this exercise is to look into web apps with
    multipe submit buttons. More precisely, we want a web app
    that can perform two actions: add \( a+b \) and multiply \( pq \).
    There should be two parts of the open web page:

<ol>
    <li> Two fields for \( a \) and \( b \) and an <code>Add</code> button. Clicking on <code>Add</code>
        brings up a new line below add: <code>Sum: 3</code> if \( a+b=3 \).
    </li>
    <li> Two fields for \( p \) and \( q \) and a <code>Multiply</code> button. Clicking on <code>Multiply</code>
        brings up a new line below add: <code>Product: 5</code> if \( pq=5 \).
    </li>
</ol>

That is, the web app actually features two apps in the page.

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 1.</b>
    Make two input form classes, say <code>AddForm</code> and <code>MulForm</code> in <code>model.py</code>.
    Since it suffices to fill in either \( a \) and \( b \) or \( p \) and \( q \), all
    fields cannot be required.
    Let the controller process both classes and collect the two forms
    and two results in a <code>form</code> dictionary and a <code>result</code> dictionary
    that is passed on the to the <code>view.html</code> file.

<p>
    <!-- --- end hint in exercise --- -->

<p>
    <!-- --- begin hint in exercise --- -->

<p>
    <b>Hint 2.</b>
    To detect which &quot;subapp&quot; (add or multply) that was used, one can
    give a name to the submit button and in the controller check which
    of the submit buttons that was pressed (and then perform the associated
    computation and update of results). In <code>view.html</code>:

<p>

    <!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
        style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">name=</span><span
        style="color: #BA2121">&quot;btn&quot;</span> <span style="color: #7D9029">value=</span><span
        style="color: #BA2121">&quot;Add&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;</span>
...
<span style="color: #008000; font-weight: bold">&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">&quot;submit&quot;</span> <span style="color: #7D9029">name=</span><span
            style="color: #BA2121">&quot;btn&quot;</span> <span style="color: #7D9029">value=</span><span
            style="color: #BA2121">&quot;Multiply&quot;</span><span style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;</span>
</pre>
</div>
<p>
    In <code>controller.py</code>:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
        style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
        style="color: #AA22FF; font-weight: bold">and</span> f<span style="color: #666666">.</span>validate() <span
        style="color: #AA22FF; font-weight: bold">and</span> \
       request<span style="color: #666666">.</span>form[<span style="color: #BA2121">&#39;btn&#39;</span>] <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;Multiply&#39;</span>:
    result[<span style="color: #BA2121">&#39;mul&#39;</span>] <span style="color: #666666">=</span> mul(f<span
            style="color: #666666">.</span>p<span style="color: #666666">.</span>data, f<span
            style="color: #666666">.</span>q<span style="color: #666666">.</span>data)
</pre>
</div>
<p>
    <!-- --- end hint in exercise --- -->
    Filename: <code>addmul.tar.gz</code>.

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:gen:lists">Exercise 7: Equip the <code>gen</code> app with more data types</h2>

<p>
    In the <a href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen"
              target="_self"><tt>gen</tt></a>
    application from the section <a href="#wf:autogen:flask">Autogenerating the code</a>,
    use the <code>label</code> argument in the form field objects to add an
    information of the type of data that is to be supplied in the
    text field. Extend the <code>model.py</code> file to also handle
    lists, tuples, and Numerical Python arrays. For these three
    new data types, use a <code>TextField</code> object and run <code>eval</code>
    on the text in the <code>view.py</code> file.
    A simple test is to extend the <code>compute</code> function with an
    argument <code>x_range</code> for the range of the \( x \) axis, specified as
    an interval (2-list or 2-tuple).
    Filename: <code>gen_ext.tar.gz</code>.

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="___sec83">Exercise 8: Auto-generate code from function signature </h2>

<p>
    Given a <code>compute</code> with a set of positional and keyword
    arguments, the purpose of this exercise is to <em>automatically</em> generate the
    Flask files <code>model.py</code> and <code>controller.py</code>. Use the Python <code>inspect</code>
    module, see the section <a href="#wf:autogen:flask">Autogenerating the code</a>, to extract
    the positional and keyword arguments in <code>compute</code>, and use this
    information to construct the relevant Python code in strings. Write
    the strings to <code>model.py</code> and <code>controller.py</code> files. Assume as
    in the section <a href="#wf:autogen:flask">Autogenerating the code</a> that the user provides
    a file <code>view_results.html</code> for defining how the returned object
    from the <code>compute</code> function is to be rendered.

<p>
    Test the code generator on the <code>compute</code> function in the <code>vib1</code>
    application to check that the generated
    <code>model.py</code> and <code>controller.py</code> files are correct.
    Filename: <code>generate_flask.py</code>.

<p>
    <!-- --- end exercise --- -->

<p>
    <!-- --- begin exercise --- -->

<h2 id="wf:exer:bokeh_UI">Project 9: Interactive function exploration</h2>

<p>
    The <a href="http://bokeh.pydata.org/en/latest/" target="_self">Bokeh</a> Python library works
    very well with Flask. The purpose of this exercise is to make a web app
    where one can explore how parameters in a function influence
    the function's shape. Given some function \( f(x;p_0,p_1,\ldots,p_n) \),
    where \( x \) is the independent variable and \( p_0,p_1,\ldots,p_n \) are
    parameters, we want to create a user interface with a plot field
    and text fields or
    sliders for \( p_0,p_1,\ldots,p_n \) such that altering any parameter
    immediately updates the graph of the \( f \) as a function of \( x \).
    The Bokeh web side contains a <a href="http://bokeh.pydata.org/en/latest/docs/server_gallery/sliders_server.html"
                                     target="_self">demo</a>: for the specific function

    $$ f(x;x_0,A,\phi,\omega)= x_0 + A\sin(\omega (x + \phi)).$$

    However, this project is about accepting any function
    \( f(x;p_0,p_1,\ldots,p_n) \) and creating tailored Flask/Bokeh code of the type
    in the demo. The user must specify a Python function for \( f \):

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(x, p):
    x_0, A, phi, omega <span style="color: #666666">=</span> p
    <span style="color: #008000; font-weight: bold">return</span> x_0 <span style="color: #666666">+</span> A<span
            style="color: #666666">*</span>sin(omega<span style="color: #666666">*</span>(x <span
            style="color: #666666">-</span> phi))
</pre>
</div>
<p>
    where <code>p</code> is a list of parameter values. In addition, the user must
    provide info about each parameter: the name, a range or a number,
    and if range, a default value. Here is an example:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">p_info <span
        style="color: #666666">=</span> [
    (<span style="color: #BA2121">&#39;offset&#39;</span>, [<span style="color: #666666">-2</span>, <span
            style="color: #666666">2</span>], <span style="color: #666666">0</span>),
    (<span style="color: #BA2121">&#39;amplitude&#39;</span>, [<span style="color: #666666">0</span>, <span
            style="color: #666666">5</span>], <span style="color: #666666">2.5</span>),
    (<span style="color: #BA2121">&#39;phase&#39;</span>, <span style="color: #666666">0</span>),
    (<span style="color: #BA2121">&#39;frequency&#39;</span>, [<span style="color: #666666">1</span>, <span
            style="color: #666666">10</span>], <span style="color: #666666">1</span>)]
</pre>
</div>
<p>
    Parameters with an interval range get a slider for setting the value,
    while parameters with only a number, as for <code>phase</code> in this example,
    get a text field where the user can alter the number.

<p>
    The user must also provide a suitable range for the \( x \) axis.
    As test case beyond the example above, try a Gaussian function
    with this input from the user:

<p>

    <!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span
        style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gaussian</span>(x, p):
    mu, sigma <span style="color: #666666">=</span> p
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">1./</span>(sigma<span
            style="color: #666666">*</span>np<span style="color: #666666">.</span>sqrt(<span
            style="color: #666666">2*</span>np<span style="color: #666666">.</span>pi))<span
            style="color: #666666">*</span>\
           np<span style="color: #666666">.</span>exp(<span style="color: #666666">-0.5*</span>(x <span
            style="color: #666666">-</span> mu)<span style="color: #666666">**2/</span>sigma<span
            style="color: #666666">**2</span>)

p_info <span style="color: #666666">=</span> [
    (<span style="color: #BA2121">&#39;mean&#39;</span>, [<span style="color: #666666">-2</span>, <span
            style="color: #666666">2</span>], <span style="color: #666666">0</span>),
    (<span style="color: #BA2121">&#39;standard deviation&#39;</span>, [<span style="color: #666666">0.1</span>, <span
            style="color: #666666">4</span>], <span style="color: #666666">1</span>)]

x_axis <span style="color: #666666">=</span> [<span style="color: #666666">-10</span>, <span
            style="color: #666666">10</span>]
</pre>
</div>
<p>
    Filename: <code>expore_func.tar.gz</code>.

<p>
    <!-- --- end exercise --- -->

<h1 id="___sec85">Resources </h1>

<h2 id="___sec86">Flask resources </h2>

<ul>
    <li><a href="http://flask.pocoo.org/" target="_self">Flask website</a></li>
    <li><a href="http://flask.pocoo.org/docs/0.10/tutorial/" target="_self">Flask Quick Start</a></li>
    <li><a href="http://flask.pocoo.org/docs/0.10/tutorial/" target="_self">Flask tutorial</a></li>
    <li><a href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world" target="_self">The
        Flask Mega-Tutorial</a> by M. Grinberg
    </li>
    <li><a href="http://wtforms.simplecodes.com/docs/0.6/index.html" target="_self">WTForms Documentation</a></li>
    <li><a href="http://jinja.pocoo.org/docs/" target="_self">The Jinja2 templating language</a></li>
    <li><a href="http://werkzeug.pocoo.org/" target="_self">The Werkzeug library</a></li>
    <li><a href="http://code.tutsplus.com/tutorials/an-introduction-to-pythons-flask-framework--net-28822"
           target="_self">An Introduction to Python's Flask Framework</a> by L. Polepeddi
    </li>
    <li><a href="https://realpython.com/blog/python/introduction-to-flask-part-1-setting-up-a-static-site/"
           target="_self">Discover Flask, Part I - Setting up a Static Site</a></li>
    <li> Flaskr: A Minimal Blog Application: <a href="https://github.com/mitsuhiko/flask/tree/master/examples/flaskr/"
                                                target="_self">Code</a>, <a
            href="https://stormpath.com/blog/build-a-flask-app-in-30-minutes/" target="_self">Explanation</a></li>
    <li><a href="http://peterhudec.github.io/authomatic/examples/flask-simple.html" target="_self">Flask Login with
        Facebook, Twitter, and OpenID</a></li>
    <li><a href="http://blog.shea.io/lightweight-python-apps-with-flask-twitter-bootstrap-and-heroku/" target="_self">Lightweight
        Python Apps with Flask, Bootstrap, and Heroku</a> by R. Shea
    </li>
    <li><a href="https://www.digitalocean.com/community/tutorials/how-to-structure-large-flask-applications"
           target="_self">How to Structure Large Flask Applications</a></li>
    <li><a href="https://exploreflask.com/index.html" target="_self">Explore Flask</a> by R. Picard (online book)</li>
    <li><a href="http://www.datacommunitydc.org/blog/2014/02/flask-mega-meta-tutorial-data-scientists" target="_self">Flask
        Mega Tutorial for Data Scientists</a></li>
    <li><a href="http://maximebf.com/blog/2012/10/building-websites-in-python-with-flask/#.UxV4jHVdXn4" target="_self">Quick
        Flask++ tutorial</a></li>
    <li><a href="https://github.com/mbr/flask-bootstrap" target="_self">Flask-Bootstrap</a> with <a
            href="http://pythonhosted.org/Flask-Bootstrap/" target="_self">documentation</a>, <a
            href="http://pythonhosted.org/Flask-Bootstrap/basic-usage.html" target="_self">basic usage</a> and <a
            href="https://github.com/mbr/flask-bootstrap/blob/master/sample_application/__init__.py" target="_self">example</a>
    </li>
    <li><a href="http://www.skulpt.org/" target="_self">Skulpt: Interactive Python in the browser</a> (but no support
        for <code>numpy</code>, <code>scipy</code>, or <code>matplotlib</code>)
    </li>
</ul>

<h2 id="___sec87">Django resources </h2>

<ul>
    <li><a href="https://www.djangoproject.com/" target="_self">Django webpage</a></li>
    <li><a href="https://code.djangoproject.com/wiki/Tutorials" target="_self">List of Web tutorials</a></li>
    <li><a href="http://www.youtube.com/playlist?list=PL385A53B00B8B158E" target="_self">YouTube videos</a></li>
    <li><a href="http://www.effectivedjango.com/tutorial/" target="_self">Effective Django Tutorial</a></li>
    <li><a href="http://lightbird.net/dbe2/" target="_self">Django by Example</a> (blog, questionnaire, etc.)</li>
    <li><a href="http://www.blopig.com/blog/2013/09/django-for-scientific-applications/" target="_self">Django for
        Scientific Applications</a></li>
    <li>
        <a href="http://www.datacommunitydc.org/blog/2013/12/a-tutorial-for-deploying-a-django-application-that-uses-numpy-and-scipy-to-google-compute-engine-using-apache2-and-modwsgi"
           target="_self">A Tutorial for Deploying a Django Application that Uses Numpy and Scipy to Google Compute
            Engine Using Apache2 and modwsgi</a></li>
</ul>


<!-- ------------------- end of main content --------------- -->


<center style="font-size:80%">
    <!-- copyright --> &copy; 2015, Anders E. Johansen, Hans Petter Langtangen. Released under CC Attribution 4.0
    license
</center>


</body>
</html>
    

