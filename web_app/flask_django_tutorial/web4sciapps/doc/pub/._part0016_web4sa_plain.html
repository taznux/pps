<?xml version="1.0" encoding="utf-8" ?>
<!--
Automatically generated HTML file from Doconce source
(http://code.google.com/p/doconce/)
-->

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generator" content="Doconce: http://code.google.com/p/doconce/"/>
    <meta name="description"
          content="Using Web Frameworks to Ease the Development of Web Applications for Computational Science">
    <meta name="keywords"
          content="web frameworks,MVC pattern,Flask installation,Flask input forms,Flask HTML templates,Flask MVC pattern,Flask troubleshooting,Django installation,Django making a project,Django making an application,Django input forms,Django HTML templates,Flask input forms,Flask error checking,Flask CSS style sheets,Flask LaTeX mathematics,Flask input validation,Django input forms,Django input validation">


    <style type="text/css">
    body {
      font-family: Helvetica, Verdana, Arial, Sans-serif;
      color: #404040;
      background: #ffffff;
    }
    h1 { font-size: 1.8em;  color: #8A0808; }
    h2 { font-size: 1.5em;  color: #8A0808; }
    h3, h4 { color: #8A0808; }
    a { color: #8A0808; text-decoration:none; }
    tt { font-family: "Courier New", Courier; }
    pre { background: #ededed; color: #000; padding: 15px;}
    p { text-indent: 0px; }
    hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
    p.caption { width: 80%; font-style: normal; text-align: left; }
    hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}


    </style>

</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(' Web frameworks ', 1, None, '___sec0'),
              (' The MVC pattern ', 2, None, '___sec1'),
              (' A very simple application ', 2, None, '___sec2'),
              (' Application of the MVC pattern ',
               2,
               'wf:hw:mvc',
               'wf:hw:mvc'),
              (' Making a Flask application ', 1, None, '___sec4'),
              (' Programming the Flask application ', 2, None, '___sec5'),
              (' Equipping the input page with output results ',
               2,
               None,
               '___sec6'),
              (' Splitting the app into model, view, and controller files ',
               2,
               'wf:hw3:flask',
               'wf:hw3:flask'),
              (' Troubleshooting ', 2, None, '___sec8'),
              (' Making a Django application ', 1, None, '___sec9'),
              (' Installing Django ', 2, None, '___sec10'),
              (' Setting up a Django project ', 2, None, '___sec11'),
              (' Setting up a Django application ', 2, None, '___sec12'),
              (' Programming the Django application ', 2, None, '___sec13'),
              (' Equipping the input page with output results ',
               2,
               None,
               '___sec14'),
              (' Handling multiple input variables in Flask ',
               1,
               'wf:vib:flask',
               'wf:vib:flask'),
              (' Programming the Flask application ', 2, None, '___sec16'),
              (' Implementing error checking in the template ',
               2,
               None,
               '___sec17'),
              (' Using style sheets ', 2, None, '___sec18'),
              (' Using LaTeX mathematics ', 2, None, '___sec19'),
              (' Rearringing the elements in the HTML template ',
               2,
               None,
               '___sec20'),
              (' User-provided validation ', 2, None, '___sec21'),
              (' Autogenerating the code ',
               2,
               'wf:vib3:flask:autogen',
               'wf:vib3:flask:autogen'),
              (' Handling multiple input variables in Django ',
               1,
               'wf:vib:django',
               'wf:vib:django'),
              (' Programming the Django application ', 2, None, '___sec24'),
              (' User-provided validation ', 2, None, '___sec25'),
              (' Exercise 1: Add two numbers ',
               2,
               'wf:exer:add2',
               'wf:exer:add2'),
              (' Remaining ', 1, None, '___sec27')]}
end of tocinfo -->

<body>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
  }
});

</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- Fix slow MathJax rendering in IE8 -->
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">


<a name="part0016"></a>

<a href="._part0015_web4sa_plain.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/prev1.png"
                                            border=0 alt="previous"></a>

<a href="._part0017_web4sa_plain.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/next1.png"
                                            border=0 alt="next"></a>
<p>
    <!-- !split -->

<h3>Autogenerating the code <a name="wf:vib3:flask:autogen"></a></h3>

<p>


    We shall now present generic <code>model.py</code>, <code>view.py</code>, and <code>controller.py</code>
    files that work with <em>any</em> <code>compute</code> function (!). This example will
    demonstrate some advanced, powerful features of Python.

<p>
    The basic idea is that the Python module <code>inspect</code> can be used to
    retrieve the names of the arguments, and the default values of
    keyword arguments of any given <code>compute</code> function. Say we have some

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">mycompute</span>(A, m<span
        style="color: #666666">=0</span>, s<span style="color: #666666">=1</span>, w<span
        style="color: #666666">=1</span>, x_range<span style="color: #666666">=</span>[<span
        style="color: #666666">-3</span>,<span style="color: #666666">3</span>]):
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">return</span> result
</pre>
</div>
<p>
    Running

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">import</span> <span
        style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>defaults
</pre>
</div>
<p>
    leads to

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
        style="color: #666666">=</span> [<span style="color: #BA2121">&#39;A&#39;</span>, <span style="color: #BA2121">&#39;m&#39;</span>, <span
        style="color: #BA2121">&#39;s&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>, <span
        style="color: #BA2121">&#39;x_range&#39;</span>]
defaults <span style="color: #666666">=</span> (<span style="color: #666666">0</span>, <span
            style="color: #666666">1</span>, <span style="color: #666666">1</span>, [<span
            style="color: #666666">-3</span>, <span style="color: #666666">3</span>])
</pre>
</div>
<p>

    Knowing the names <code>name</code> of some argument in the <code>compute</code>
    function, we can make the corresponding class attribute
    in the <code>InputForm</code> class by

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
</div>
<p>
    For name equal to <code>'A'</code> this is the same as hardcoding

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>:
    A <span style="color: #666666">=</span> FloatForm()
</pre>
</div>
<p>
    Assuming that all arguments in <code>compute</code> are floats, we could
    do

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">class</span> <span
        style="color: #0000FF; font-weight: bold">InputForm</span>:
    <span style="color: #008000; font-weight: bold">pass</span>  <span style="color: #408080; font-style: italic"># Empty class</span>

arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(mycompute)<span
            style="color: #666666">.</span>args
<span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names:
    <span style="color: #008000">setattr</span>(InputForm, name, FloatForm())
</pre>
</div>
<p>
    However, we can do better than this: default values can be set for
    keyword arguments, and the type of default value can be used to
    select the appropriate form class. The complete <code>model.py</code> file
    then goes as follows:

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">Example on generic model.py file which inspects the arguments</span>
<span style="color: #BA2121; font-style: italic">of the compute function and automatically generates a relevant</span>
<span style="color: #BA2121; font-style: italic">InputForm class.</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>

<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">wtforms</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
            style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute_gamma <span
            style="color: #008000; font-weight: bold">as</span> compute
<span style="color: #008000; font-weight: bold">import</span> <span
            style="color: #0000FF; font-weight: bold">inspect</span>
arg_names <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
            style="color: #666666">.</span>args
defaults  <span style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
            style="color: #666666">.</span>defaults

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(wtforms<span style="color: #666666">.</span>Form):
    <span style="color: #008000; font-weight: bold">pass</span>

<span style="color: #408080; font-style: italic"># Augment defaults with None elements for the positional</span>
<span style="color: #408080; font-style: italic"># arguments</span>
defaults <span style="color: #666666">=</span> [<span style="color: #008000">None</span>]<span
            style="color: #666666">*</span>(<span style="color: #008000">len</span>(arg_names)<span
            style="color: #666666">-</span><span style="color: #008000">len</span>(defaults)) <span
            style="color: #666666">+</span> <span style="color: #008000">list</span>(defaults)
<span style="color: #408080; font-style: italic"># Map type of default to right form field</span>
type2form <span style="color: #666666">=</span> {<span style="color: #008000">type</span>(<span style="color: #666666">1.0</span>): wtforms<span
            style="color: #666666">.</span>FloatField,
             <span style="color: #008000">type</span>(<span style="color: #666666">1</span>):   wtforms<span
            style="color: #666666">.</span>IntegerField,
             <span style="color: #008000">type</span>(<span style="color: #BA2121">&#39;&#39;</span>):  wtforms<span
            style="color: #666666">.</span>TextField,
             }

<span style="color: #008000; font-weight: bold">for</span> name, value <span style="color: #AA22FF; font-weight: bold">in</span> <span
            style="color: #008000">zip</span>(arg_names, defaults):
    <span style="color: #008000; font-weight: bold">if</span> value <span
            style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
        <span style="color: #008000">setattr</span>(InputForm, name, wtforms<span style="color: #666666">.</span>FloatField(
            validators<span style="color: #666666">=</span>[wtforms<span style="color: #666666">.</span>validators<span
            style="color: #666666">.</span>InputRequired()]))
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">type</span>(value) <span
            style="color: #AA22FF; font-weight: bold">in</span> type2form:
            <span style="color: #008000">setattr</span>(InputForm, name, type2form[<span
            style="color: #008000">type</span>(value)](
                default<span style="color: #666666">=</span>value,
                validators<span style="color: #666666">=</span>[wtforms<span
            style="color: #666666">.</span>validators<span style="color: #666666">.</span>InputRequired()]))
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span
            style="color: #D2413A; font-weight: bold">TypeError</span>(<span
            style="color: #BA2121">&#39;argument </span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121"> not supported&#39;</span> <span style="color: #666666">%</span>
                            name, <span style="color: #008000">type</span>(value))

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #008000; font-weight: bold">for</span> item <span
            style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">dir</span>(InputForm):
        <span style="color: #008000; font-weight: bold">if</span> item <span style="color: #AA22FF; font-weight: bold">in</span> arg_names:
            <span style="color: #008000; font-weight: bold">print</span> item, <span
            style="color: #008000">getattr</span>(InputForm, item)
</pre>
</div>
<p>
    (The <code>compute_gamma</code> function imported from <code>compute</code> will be treated later.)

<p>
    The call to <code>compute</code> in the <code>view.py</code> file must also be expressed
    in a general way such that it handle any type and number of
    parameters. This is achieved by collecting all parameters in
    a list or tuple, called <code>args</code>, and then calling <code>compute(*args)</code>
    (which is equivalent to <code>compute(args[0], args[1], ..., args[l])</code>
    if <code>l</code> is <code>len(args)-1</code>). The value of the form variable with
    name <code>name</code> (string) is extracted by <code>getattr(form, name).data</code>,
    which is the same as <code>form.A.data</code> if <code>name</code> equals <code>'A'</code>.
    Collecting all arguments and calling <code>compute</code> are done with

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">arg_names <span
        style="color: #666666">=</span> inspect<span style="color: #666666">.</span>getargspec(compute)<span
        style="color: #666666">.</span>args
args <span style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
            style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names]
result <span style="color: #666666">=</span> compute(<span style="color: #666666">*</span>args)
</pre>
</div>
<p>
    Our <code>InputForm</code> class guarantees that all arguments in <code>compute</code>
    are present in the form, but to be absolutely safe we can
    test if <code>name</code> is present in the <code>form</code> object:

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">args <span
        style="color: #666666">=</span> [<span style="color: #008000">getattr</span>(form, name)<span
        style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
        style="color: #AA22FF; font-weight: bold">in</span> arg_names
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)]
</pre>
</div>
<p>
    We could also use keyword arguments in the call in case
    the <code>args</code> list should have the parameters in the wrong order:

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">kwargs <span
        style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
        style="color: #666666">.</span>data <span style="color: #008000; font-weight: bold">for</span> name <span
        style="color: #AA22FF; font-weight: bold">in</span> arg_names
          <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
</pre>
</div>
<p>
    The <code>compute(**kwargs)</code> becomes <code>compute(A=1, b=3, w=0.5)</code>
    in case <code>kwargs = {'w'=0.5, 'A':1, 'b':3}</code> (recall that the order of
    the keys in a Python dictionary is undetermined).

<p>
    It remains to generate the right HTML template. The HTML code depends
    what the returned <code>result</code> object from <code>compute</code> contains. Only the
    writer of the <code>compute</code> function knows the details of the returned
    result. Therefore, we leave it to this writer to provide the part
    of the HTML template that renders the result. The file <code>templates/view_results.html</code> contains this
    user-provided code, while <code>templates/view_forms.html</code>
    is the generic template for the forms:

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span> <span
            style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{% if field.errors %}
      <span style="color: #008000; font-weight: bold">&lt;ul</span> <span style="color: #7D9029">class=</span><span
            style="color: #BA2121">errors</span><span style="color: #008000; font-weight: bold">&gt;</span>
      {% for error in field.errors %}
        <span style="color: #008000; font-weight: bold">&lt;li&gt;</span>{{ error }}<span
            style="color: #008000; font-weight: bold">&lt;/li&gt;</span>
      {% endfor %}<span style="color: #008000; font-weight: bold">&lt;/ul&gt;</span>
    {% endif %}<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Compute</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>
</pre>
</div>
<p>

    By default, in <code>templates/view_results_default.html</code>, we can
    create a code that checks if <code>results</code> is a string ending in <code>'.png'</code>
    or other typical file extensions for HTML images, and then write out
    the code for an image, and otherwise a string version of the <code>results</code>
    object is dumped to the web page:

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #666666">&lt;</span>p<span style="color: #666666">&gt;</span>
{<span style="color: #666666">%</span> <span style="color: #008000; font-weight: bold">if</span> result <span
            style="color: #666666">!=</span> <span style="color: #008000">None</span> <span
            style="color: #666666">%</span>}
  {<span style="color: #666666">%</span> <span style="color: #008000; font-weight: bold">if</span> <span
            style="color: #008000">type</span>(result) <span style="color: #666666">==</span> <span
            style="color: #008000">type</span>(<span style="color: #BA2121">&quot;&quot;</span>) <span
            style="color: #AA22FF; font-weight: bold">and</span>
        result[:<span style="color: #666666">-4</span>] <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;.png&#39;</span> <span style="color: #AA22FF; font-weight: bold">or</span>  result[:<span
            style="color: #666666">-4</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;.gif&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">or</span>
        result[:<span style="color: #666666">-4</span>] <span style="color: #666666">==</span> <span
            style="color: #BA2121">&#39;.jpg&#39;</span> <span style="color: #666666">%</span>}
<span style="color: #666666">&lt;</span>img src<span style="color: #666666">=</span><span style="color: #BA2121">&quot;{{ result }}&quot;</span><span
            style="color: #666666">&gt;</span>
  {<span style="color: #666666">%</span> <span style="color: #008000; font-weight: bold">else</span> <span
            style="color: #666666">%</span>}
{{ <span style="color: #008000">str</span>(result) }}
  {<span style="color: #666666">%</span> endif <span style="color: #666666">%</span>}
{<span style="color: #666666">%</span> endif <span style="color: #666666">%</span>}
<span style="color: #666666">&lt;/</span>p<span style="color: #666666">&gt;</span>
</pre>
</div>
<p>
    The complete, generic <code>index</code> function now becomes

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>():
    form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>form)
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span> <span
            style="color: #AA22FF; font-weight: bold">and</span> form<span style="color: #666666">.</span>validate():
        arg_names <span style="color: #666666">=</span> inspect<span
            style="color: #666666">.</span>getargspec(compute)<span style="color: #666666">.</span>args
        kwargs <span style="color: #666666">=</span> {name: <span style="color: #008000">getattr</span>(form, name)<span
            style="color: #666666">.</span>data
                  <span style="color: #008000; font-weight: bold">for</span> name <span
            style="color: #AA22FF; font-weight: bold">in</span> arg_names <span
            style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(form, name)}
        result <span style="color: #666666">=</span> compute(<span style="color: #666666">**</span>kwargs)
    <span style="color: #008000; font-weight: bold">else</span>:
        result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
    <span style="color: #408080; font-style: italic"># Concatenate view_forms.html and view_results.html</span>
    forms_html   <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;templates&#39;</span>, <span
            style="color: #BA2121">&#39;view_forms.html&#39;</span>)
    results_html <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;templates&#39;</span>, <span
            style="color: #BA2121">&#39;view_results.html&#39;</span>)
    view_html    <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;templates&#39;</span>, <span
            style="color: #BA2121">&#39;view.html&#39;</span>)
    f_forms <span style="color: #666666">=</span> <span style="color: #008000">open</span>(forms_html, <span
            style="color: #BA2121">&#39;r&#39;</span>)
    f_res   <span style="color: #666666">=</span> <span style="color: #008000">open</span>(results_html, <span
            style="color: #BA2121">&#39;r&#39;</span>)
    f_view  <span style="color: #666666">=</span> <span style="color: #008000">open</span>(view_html, <span
            style="color: #BA2121">&#39;w&#39;</span>)
    f_view<span style="color: #666666">.</span>write(f_forms<span style="color: #666666">.</span>read() <span
            style="color: #666666">+</span> f_res<span style="color: #666666">.</span>read())
    f_forms<span style="color: #666666">.</span>close();  f_res<span
            style="color: #666666">.</span>close();  f_view<span style="color: #666666">.</span>close()
    <span style="color: #008000; font-weight: bold">return</span> render_template(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>basename(view_html),
                           form<span style="color: #666666">=</span>form, result<span style="color: #666666">=</span>result)
</pre>
</div>
<p>

    <b>Application.</b>
    Let us apply the files above to plot the <em>gamma probability density</em>

<p>
    $$ g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
    e^{-\left(\frac{x}{A}\right)^h},
    $$

    and its cumulative density

<p>
    $$ G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,$$

    computed by numerically the Trapezoidal rule, for instance.
    We also want to compute and display
    the mean value \( A\Gamma(a + 1/h)/\Gamma(a) \) and
    standard deviation

<p>
    $$ \sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - Gamma(a+1/h)^2}.$$

    Here, \( \Gamma(a) \) is the gamma function, which can be computed
    by <code>math.gamma(a)</code> using Python's <code>math</code> module.
    Below are relevant implementations of \( g(x;a,h,A) \) (<code>gamma_density</code>),
    \( G(x; a, h, A) \) (<code>gamma_cumulative</code>), and a function for
    making a plot of \( g \) og \( G \) for \( x\in [0,7\sigma] \).

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_density</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    xA <span style="color: #666666">=</span> x<span style="color: #666666">/</span><span
            style="color: #008000">float</span>(A)
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">abs</span>(h)<span
            style="color: #666666">/</span>(math<span style="color: #666666">.</span>gamma(a)<span
            style="color: #666666">*</span>A)<span style="color: #666666">*</span>(xA)<span
            style="color: #666666">**</span>(a<span style="color: #666666">*</span>h<span
            style="color: #666666">-1</span>)<span style="color: #666666">*</span>exp(<span
            style="color: #666666">-</span>xA<span style="color: #666666">**</span>h)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">gamma_cumulative</span>(x, a, h, A):
    <span style="color: #408080; font-style: italic"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span style="color: #408080; font-style: italic"># Assume x is array.</span>
    g <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    r <span style="color: #666666">=</span> zeros_like(x)
    <span style="color: #008000; font-weight: bold">for</span> i <span
            style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span
            style="color: #008000">len</span>(r)<span style="color: #666666">-1</span>):
        r[i<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> r[i] <span
            style="color: #666666">+</span> <span style="color: #666666">0.5*</span>(g[i] <span
            style="color: #666666">+</span> g[i<span style="color: #666666">+1</span>])<span
            style="color: #666666">*</span>(x[i<span style="color: #666666">+1</span>] <span
            style="color: #666666">-</span> x[i])
    <span style="color: #008000; font-weight: bold">return</span> r

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute_gamma</span>(a<span
            style="color: #666666">=0.5</span>, h<span style="color: #666666">=2</span>, A<span
            style="color: #666666">=</span>math<span style="color: #666666">.</span>sqrt(<span
            style="color: #666666">2</span>), resolution<span style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    gah <span style="color: #666666">=</span> math<span style="color: #666666">.</span>gamma(a <span
            style="color: #666666">+</span> <span style="color: #666666">1./</span>h)
    mean <span style="color: #666666">=</span> A<span style="color: #666666">*</span>gah<span
            style="color: #666666">/</span>math<span style="color: #666666">.</span>gamma(a)
    stdev <span style="color: #666666">=</span> A<span style="color: #666666">/</span>math<span
            style="color: #666666">.</span>gamma(a)<span style="color: #666666">*</span>math<span
            style="color: #666666">.</span>sqrt(
        math<span style="color: #666666">.</span>gamma(a <span style="color: #666666">+</span> <span
            style="color: #666666">2./</span>h)<span style="color: #666666">*</span>math<span
            style="color: #666666">.</span>gamma(a) <span style="color: #666666">-</span> gah<span
            style="color: #666666">**2</span>)
    x <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, <span
            style="color: #666666">7*</span>stdev, resolution<span style="color: #666666">+1</span>)
    y <span style="color: #666666">=</span> gamma_density(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()  <span style="color: #408080; font-style: italic"># needed to avoid adding curves in plot</span>
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;a=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, h=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, A=</span><span
            style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span
            style="color: #666666">%</span> (a, h, A))
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>isdir(<span style="color: #BA2121">&#39;static&#39;</span>):
        os<span style="color: #666666">.</span>mkdir(<span style="color: #BA2121">&#39;static&#39;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #408080; font-style: italic"># Remove old plot files</span>
        <span style="color: #008000; font-weight: bold">for</span> filename <span
            style="color: #AA22FF; font-weight: bold">in</span> glob<span style="color: #666666">.</span>glob(os<span
            style="color: #666666">.</span>path<span style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #BA2121">&#39;*.png&#39;</span>)):
            os<span style="color: #666666">.</span>remove(filename)
    <span style="color: #408080; font-style: italic"># Use time since Jan 1, 1970 in filename in order make</span>
    <span style="color: #408080; font-style: italic"># a unique filename that the browser has not chached</span>
    t <span style="color: #666666">=</span> <span style="color: #008000">str</span>(time<span
            style="color: #666666">.</span>time())
    plotfile1 <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #BA2121">&#39;density_</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> t)
    plotfile2 <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>join(<span style="color: #BA2121">&#39;static&#39;</span>, <span
            style="color: #BA2121">&#39;cumulative_</span><span style="color: #BB6688; font-weight: bold">%s</span><span
            style="color: #BA2121">.png&#39;</span> <span style="color: #666666">%</span> t)
    plt<span style="color: #666666">.</span>savefig(plotfile1)
    y <span style="color: #666666">=</span> gamma_cumulative(x, a, h, A)
    plt<span style="color: #666666">.</span>figure()
    plt<span style="color: #666666">.</span>plot(x, y)
    plt<span style="color: #666666">.</span>grid(<span style="color: #008000">True</span>)
    plt<span style="color: #666666">.</span>savefig(plotfile2)
    <span style="color: #008000; font-weight: bold">return</span> plotfile1, plotfile2, mean, stdev
</pre>
</div>
<p>
    The <code>compute_gamma</code> function returns a tuple of four values.
    We want output as displayed in Figure <a href="#wf:vib3:flask:fig:gamma">13</a>.

<p>

    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 13: Design of a web page illustrating the gamma probability functions. <a
        name="wf:vib3:flask:fig:gamma"></a></p></center>
<p><img src="fig-web4sa/vib3_flask_gamma.png" align="bottom" width=700></p>
</center>

<p>

    The design is realized in the file <code>view_results.html</code> shown below.

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">{% if result != None %}
<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result[0] }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{{ result[1] }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">&quot;400&quot;</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/td&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;tr&gt;&lt;td&gt;</span>
Mean value: {{ result[2] }} <span style="color: #008000; font-weight: bold">&lt;br&gt;</span>
Standard deviation value: {{ result[3] }}
<span style="color: #008000; font-weight: bold">&lt;/td&gt;&lt;/tr&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
{% endif %}
</pre>
</div>
<p>


<h2>Handling multiple input variables in Django <a name="wf:vib:django"></a></h2>

<p>
    We shall briefly demonstrate how to make the multi-variable input
    application from the section <a href="._part0009_web4sa_plain.html#wf:vib:flask">Handling multiple input variables
    in Flask</a> in Django.
    There are four float input variables: \( A \), \( b \), \( w \), and \( T \).
    A function <code>compute</code> in the file <code>compute.py</code> makes
    a plot of a function depending on these four parameters and returns
    the name of the plot file. Our task is to define four input fields,
    execute the <code>compute</code> function and show the input fields together with
    the resulting plot, cf. Figures <a href="._part0009_web4sa_plain.html#wf:vib1:flask:fig:input">7</a>
    and <a href="._part0009_web4sa_plain.html#wf:vib1:flask:fig:result">8</a>.

<p>

<h3>Programming the Django application <a name="___sec24"></a></h3>

<p>


    Any Django app needs a project, but here we reuse the project
    we set up for the scientific hello world examples. We go to
    <code>apps/vib</code> and create the Django app

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; python ../../django_project/manage.py startapp vib1_django
</pre>
</div>
<p>
    Then we

<p>

<ol>
    <li> add <code>sys.path.insert(0, relative2absolute_path('../../apps/vib'))</code>
        in <code>settings.py</code>,
    </li>
    <li> add <code>relative2absolute_path('../../apps/vib/vib1_django/templates'),</code>
        to the <code>TEMPLATE_DIRS</code> tuple in <code>settings.py</code>, and
    </li>
    <li> add <code>url(r'^vib1/', 'vib1_django.views.index')</code> to the <code>patterns</code>
        call in <code>urls.py</code>.
    </li>
</ol>

We can now invoke <code>models.py</code> to add form fields for the four
input variables:

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span
        style="color: #0000FF; font-weight: bold">django.db</span> <span style="color: #008000; font-weight: bold">import</span> models
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">django.forms</span> <span
            style="color: #008000; font-weight: bold">import</span> ModelForm
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">math</span> <span
            style="color: #008000; font-weight: bold">import</span> pi

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Input</span>(models<span style="color: #666666">.</span>Model):
    A <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; amplitude (m)&#39;</span>, default<span
            style="color: #666666">=1.0</span>)
    b <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; damping coefficient (kg/s)&#39;</span>, default<span
            style="color: #666666">=0.0</span>)
    w <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span style="color: #BA2121">&#39; frequency (1/s)&#39;</span>, default<span
            style="color: #666666">=2*</span>pi)
    T <span style="color: #666666">=</span> models<span style="color: #666666">.</span>FloatField(
        verbose_name<span style="color: #666666">=</span><span
            style="color: #BA2121">&#39; time interval (s)&#39;</span>, default<span style="color: #666666">=18</span>)

<span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">InputForm</span>(ModelForm):
    <span style="color: #008000; font-weight: bold">class</span> <span
            style="color: #0000FF; font-weight: bold">Meta</span>:
        model <span style="color: #666666">=</span> Input
</pre>
</div>
<p>
    Note here that we can provide a more explanatory name than just
    the variable name, e.g., <code>' amplitude (m)'</code> for <code>A</code>. However,
    Django will always capitalize these descriptions, so if one really
    needs lower case names (e.g., to be compatible with mathematics),
    one must start the text with a space. We also provide a default
    value such that all fields have a value when the user sees
    the page.

<p>

    The <code>views.py</code> file looks as follows:

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">django.shortcuts</span> <span
        style="color: #008000; font-weight: bold">import</span> render_to_response
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">django.template</span> <span
            style="color: #008000; font-weight: bold">import</span> RequestContext
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">django.http</span> <span
            style="color: #008000; font-weight: bold">import</span> HttpResponse
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">models</span> <span style="color: #008000; font-weight: bold">import</span> InputForm
<span style="color: #008000; font-weight: bold">from</span> <span
            style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">index</span>(request):
    os<span style="color: #666666">.</span>chdir(os<span style="color: #666666">.</span>path<span
            style="color: #666666">.</span>dirname(__file__))
    result <span style="color: #666666">=</span> <span style="color: #008000">None</span>
    <span style="color: #008000; font-weight: bold">if</span> request<span style="color: #666666">.</span>method <span
            style="color: #666666">==</span> <span style="color: #BA2121">&#39;POST&#39;</span>:
        form <span style="color: #666666">=</span> InputForm(request<span style="color: #666666">.</span>POST)
        <span style="color: #008000; font-weight: bold">if</span> form<span style="color: #666666">.</span>is_valid():
            form2 <span style="color: #666666">=</span> form<span style="color: #666666">.</span>save(commit<span
            style="color: #666666">=</span><span style="color: #008000">False</span>)
            result <span style="color: #666666">=</span> compute(form2<span style="color: #666666">.</span>A, form2<span
            style="color: #666666">.</span>b, form2<span style="color: #666666">.</span>w, form2<span
            style="color: #666666">.</span>T)
            result <span style="color: #666666">=</span> result<span style="color: #666666">.</span>replace(<span
            style="color: #BA2121">&#39;static/&#39;</span>, <span style="color: #BA2121">&#39;&#39;</span>)
    <span style="color: #008000; font-weight: bold">else</span>:
        form <span style="color: #666666">=</span> InputForm()

    <span style="color: #008000; font-weight: bold">return</span> render_to_response(<span style="color: #BA2121">&#39;vib1.html&#39;</span>,
            {<span style="color: #BA2121">&#39;form&#39;</span>: form,
             <span style="color: #BA2121">&#39;result&#39;</span>: result,
             }, context_instance<span style="color: #666666">=</span>RequestContext(request))
</pre>
</div>
<p>
    Some remarks are necessary:

<p>

<ol>
    <li> Doing an <code>os.chdir</code> to the current working directory is necessary
        as Django may be back in another working directory if you have
        tested other apps.
    </li>
    <li> The <code>form2</code> object from <code>form.save</code> is the object we extract
        data from and send to <code>compute</code>, but the original <code>form</code>
        object is needed when making the HTML page through the template.
    </li>
    <li> Images, media files, style sheets, javascript files, etc. must
        reside in a subdirectory <code>static</code>. The specifications of the
        URL applies tools to find this <code>static</code> directory and then
        the <code>static</code> prefix in the <code>result</code> filename must be removed.
    </li>
</ol>

The template for rendering the page is listed next.

<p>


    <!-- code typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span
        style="color: #008000; font-weight: bold">&lt;form</span> <span style="color: #7D9029">method=</span><span
        style="color: #BA2121">post</span> <span style="color: #7D9029">action=</span><span style="color: #BA2121">&quot;&quot;</span><span
        style="color: #008000; font-weight: bold">&gt;</span>{% csrf_token %}
<span style="color: #008000; font-weight: bold">&lt;table&gt;</span>
  {% for field in form %}
    <span style="color: #008000; font-weight: bold">&lt;tr&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.name }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.label }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;</span>{{ field.errors }}<span
            style="color: #008000; font-weight: bold">&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;td&gt;&lt;/td&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/tr&gt;</span>
  {% endfor %}
<span style="color: #008000; font-weight: bold">&lt;/table&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;p&gt;&lt;input</span> <span style="color: #7D9029">type=</span><span
            style="color: #BA2121">submit</span> <span style="color: #7D9029">value=</span><span style="color: #BA2121">Compute</span><span
            style="color: #008000; font-weight: bold">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span style="color: #008000; font-weight: bold">&lt;p&gt;</span>
{% if result != None %}
{% load static %}
<span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span
            style="color: #BA2121">&quot;{% get_static_prefix %}{{ result }}&quot;</span> <span style="color: #7D9029">width=</span><span
            style="color: #BA2121">500</span><span style="color: #008000; font-weight: bold">&gt;</span>
{% endif %}
<span style="color: #008000; font-weight: bold">&lt;/p&gt;</span>
</pre>
</div>
<p>
    The tricky part is the syntax for displaying <em>static content</em>, such as
    the plot file made in the <code>compute</code> function.

<p>
<p>

    <a href="._part0015_web4sa_plain.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/prev1.png"
                                                border=0 alt="previous"></a>

    <a href="._part0017_web4sa_plain.html"><img src="https://doconce.googlecode.com/hg/bundled/html_images/next1.png"
                                                border=0 alt="next"></a>
    <!-- ------------------- end of main content --------------- -->


</body>
</html>
    

