<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/"/>
    <meta name="description" content="Using Web Frameworks for Scientific Applications">
    <meta name="keywords"
          content="web frameworks,MVC pattern,Flask installation,Flask input forms,Flask HTML templates,Flask MVC pattern,Flask troubleshooting,Django installation,Django making a project,Django making an application,Django input forms,Django HTML templates,Flask input forms,Flask error checking,Flask CSS style sheets,Flask LaTeX mathematics,Flask input validation,inline PNG image in HTML,base64 encoding of PNG images,inline SVG figure in HTML,mpld3 plotting,Flask Bokeh plotting,Bokeh plotting,highcharts,Flask login,Flask database,Flask uploading of files,Flask file upload,Django input forms,Django input validation">

    <title>Using Web Frameworks for Scientific Applications</title>


    <link href="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_solarized_box/css/solarized_light_code.css"
          rel="stylesheet" type="text/css" title="light"/>
    <script src="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_solarized_box/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link href="http://thomasf.github.io/solarized-css/solarized-light.min.css" rel="stylesheet">
    <style type="text/css">
h1 {color: #b58900;}  /* yellow */
/* h1 {color: #cb4b16;}  orange */
/* h1 {color: #d33682;}  magenta, the original choice of thomasf */
code { padding: 0px; background-color: inherit; }
pre {
  border: 0pt solid #93a1a1;
  box-shadow: none;
}
.alert-text-small   { font-size: 80%;  }
.alert-text-large   { font-size: 130%; }
.alert-text-normal  { font-size: 90%;  }
.alert {
  padding:8px 35px 8px 14px; margin-bottom:18px;
  text-shadow:0 1px 0 rgba(255,255,255,0.5);
  border:1px solid #93a1a1;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  color: #555;
  background-color: #eee8d5;
  background-position: 10px 5px;
  background-repeat: no-repeat;
  background-size: 38px;
  padding-left: 55px;
  width: 75%;
 }
.alert-block {padding-top:14px; padding-bottom:14px}
.alert-block > p, .alert-block > ul {margin-bottom:1em}
.alert li {margin-top: 1em}
.alert-block p+p {margin-top:5px}
.alert-notice { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_notice.png); }
.alert-summary  { background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_summary.png); }
.alert-warning { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_warning.png); }
.alert-question {background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_question.png); }

div { text-align: justify; text-justify: inter-word; }

    </style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [('Web frameworks', 1, None, '___sec0'),
              ('Other frameworks', 3, None, '___sec1'),
              ('The MVC pattern', 2, None, '___sec2'),
              ('A very simple application', 2, None, '___sec3'),
              ('Application of the MVC pattern', 2, 'wf:hw:mvc', 'wf:hw:mvc'),
              ('Making a Flask application', 1, None, '___sec5'),
              ('Programming the Flask application', 2, None, '___sec6'),
              ('The user interaction', 3, None, '___sec7'),
              ('The Python code', 3, None, '___sec8'),
              ('Dissection', 3, None, '___sec9'),
              ('The template files', 3, None, '___sec10'),
              ('Testing the application', 3, None, '___sec11'),
              ('Equipping the input page with output results',
               2,
               None,
               '___sec12'),
              ('Splitting the app into model, view, and controller files',
               2,
               'wf:hw3:flask',
               'wf:hw3:flask'),
              ('Troubleshooting', 2, None, '___sec14'),
              ('Address already in use', 3, None, '___sec15'),
              ('Making a Django application', 1, None, '___sec16'),
              ('Setting up a Django project', 2, None, '___sec17'),
              ('Setting up a Django application', 2, None, '___sec18'),
              ('Programming the Django application', 2, None, '___sec19'),
              ('The user interaction', 3, None, '___sec20'),
              ('The model', 3, None, '___sec21'),
              ('The view', 3, None, '___sec22'),
              ('Making the input page', 3, None, '___sec23'),
              ('Making the results page', 3, None, '___sec24'),
              ('Equipping the input page with output results',
               2,
               None,
               '___sec25'),
              ('Handling multiple input variables in Flask',
               1,
               'wf:vib:flask',
               'wf:vib:flask'),
              ('Programming the Flask application',
               2,
               'wf:vib1:flask:app',
               'wf:vib1:flask:app'),
              ('The compute part', 3, None, '___sec28'),
              ('The model', 3, None, '___sec29'),
              ('The view', 3, None, '___sec30'),
              ('The HTML template', 3, None, '___sec31'),
              ('Implementing error checking in the template',
               2,
               None,
               '___sec32'),
              ('Using style sheets', 2, None, '___sec33'),
              ('Using LaTeX mathematics', 2, None, '___sec34'),
              ('Rearranging the elements in the HTML template',
               2,
               None,
               '___sec35'),
              ('Bootstrap HTML style', 2, None, '___sec36'),
              ('Custom validation',
               2,
               'wf:vib1:flask:validation',
               'wf:vib1:flask:validation'),
              ('Using Flask validators', 3, None, '___sec38'),
              ('Tailored validation', 3, None, '___sec39'),
              ('Tailored validation of intervals', 3, None, '___sec40'),
              ('Demo', 3, None, '___sec41'),
              ('Avoiding plot files',
               2,
               'wf:vib2:flask:nofiles',
               'wf:vib2:flask:nofiles'),
              ('PNG plots', 3, None, '___sec43'),
              ('SVG plots', 3, None, '___sec44'),
              ('Using mpld3', 3, None, '___sec45'),
              ('Plotting with the Bokeh library',
               2,
               'wf:bokeh:flask',
               'wf:bokeh:flask'),
              ('Pandas highcharts plotting library', 3, None, '___sec47'),
              ('Autogenerating the code',
               2,
               'wf:autogen:flask',
               'wf:autogen:flask'),
              ('Inspecting function signatures', 3, None, '___sec49'),
              ('Generating the model', 3, None, '___sec50'),
              ('Generating the view', 3, None, '___sec51'),
              ('Generating the template', 3, None, '___sec52'),
              ('Application', 3, None, '___sec53'),
              ('User login and storage of computed results',
               2,
               'wf:flask:login',
               'wf:flask:login'),
              ('Required additional software', 3, None, '___sec55'),
              ('The compute part', 3, None, '___sec56'),
              ('The interfaces of the app', 3, None, '___sec57'),
              ('The source code', 3, None, '___sec58'),
              ('Resources', 3, None, '___sec59'),
              ('Uploading of files', 2, 'wf:flask:upload', 'wf:flask:upload'),
              ('Overview of the application', 3, None, '___sec61'),
              ('The model class', 3, None, '___sec62'),
              ('The controller file', 3, None, '___sec63'),
              ('The compute function', 3, None, '___sec64'),
              ('The HTML template', 3, None, '___sec65'),
              ('Handling multiple input variables in Django',
               1,
               'wf:vib:django',
               'wf:vib:django'),
              ('Programming the Django application', 2, None, '___sec67'),
              ('Adding the app to a project', 3, None, '___sec68'),
              ('The compute part', 3, None, '___sec69'),
              ('The model', 3, None, '___sec70'),
              ('The view', 3, None, '___sec71'),
              ('Custom validation', 2, None, '___sec72'),
              ('Customizing widgets', 2, None, '___sec73'),
              ('Resources', 2, None, '___sec74'),
              ('Exercises', 1, None, '___sec75'),
              ('Exercise 1: Add two numbers',
               2,
               'wf:exer:add2',
               'wf:exer:add2'),
              ('Exercise 2: Upload data file and visualize curves',
               2,
               'wf:exer:upload',
               'wf:exer:upload'),
              ('Exercise 3: Plot a user-specified formula',
               2,
               'wf:exer:formula',
               'wf:exer:formula'),
              ('Exercise 4: Visualize Taylor polynomial approximations',
               2,
               'wf:exer:Taylor',
               'wf:exer:Taylor'),
              ('Exercise 5: Extend the `gen` app',
               2,
               'wf:exer:gen:demo',
               'wf:exer:gen:demo'),
              ('Exercise 6: Make a web app with multiple apps',
               2,
               'wf:exer:addmul',
               'wf:exer:addmul'),
              ('Exercise 7: Equip the `gen` app with more data types',
               2,
               'wf:exer:gen:lists',
               'wf:exer:gen:lists'),
              ('Exercise 8: Auto-generate code from function signature',
               2,
               None,
               '___sec83'),
              ('Project 9: Interactive function exploration',
               2,
               'wf:exer:bokeh_UI',
               'wf:exer:bokeh_UI'),
              ('Resources', 1, None, '___sec85'),
              ('Flask resources', 2, None, '___sec86'),
              ('Django resources', 2, None, '___sec87')]}
end of tocinfo -->

<body>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});

</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<a name="part0019"></a>
<p>
    <!-- begin top navigation -->
<table style="width: 100%">
    <tr>
        <td>
            <div style="text-align: left;"><a href="._web4sa_solarized018.html">&laquo; Previous</a></div>
        </td>
        <td>
            <div style="text-align: right;"><a href="._web4sa_solarized020.html">Next &raquo;</a></div>
        </td>
    </tr>
</table>
<!-- end top navigation -->
</p>

<p>
    <!-- !split -->

<h1 id="wf:vib:django">Handling multiple input variables in Django</h1>

<p>
    We shall briefly how to work with multi-variable input in Django.
    The text is the Django counterpart to the section <a href="._web4sa_solarized008.html#wf:vib:flask">Handling
    multiple input variables in Flask</a>.
    There are four float input variables: \( A \), \( b \), \( w \), and \( T \).
    A function <code>compute</code> in the file <code>compute.py</code> makes
    a plot of the function \( u(t)=Ae^{-bt}\sin (wt) \)
    depending on these four parameters and returns
    the name of the plot file. Our task is to define four input fields,
    execute the <code>compute</code> function and show the input fields together with
    the resulting plot,
    cf. Figures <a href="._web4sa_solarized008.html#wf:vib1:flask:fig:input">7</a>
    and <a href="._web4sa_solarized008.html#wf:vib1:flask:fig:result">8</a>.

<h2 id="___sec67">Programming the Django application </h2>

<h3 id="___sec68">Adding the app to a project </h3>

<p>
    Any Django app needs a project, but here we reuse the project
    we set up for the scientific hello world examples. We go to
    the directory <code>apps/django_apps</code> and create the Django app <code>vib1</code>:

<p>
    <!-- begin verbatim block  sys-->
<pre><code>Terminal&gt; python ../../django_project/manage.py startapp vib1
</code></pre>
<!-- end verbatim block -->
Then we

<ol>
    <li> add <code>relative2absolute_path('../../apps/django_apps/vib1/templates'),</code>
        to the <code>TEMPLATE_DIRS</code> tuple in <code>settings.py</code>,
    </li>
    <li> add <code>vib1</code> to the <code>INSTALLED_APPS</code> tuple, and</li>
    <li> add <code>url(r'^vib1/', 'django_apps.vib1.views.index')</code> to the <code>patterns</code>
        call in <code>urls.py</code>.
    </li>
</ol>

These steps ensure that Django can find our application as a module/package,
that Django can find our templates associated with this application,
and that the URL address applies the name <code>vib1</code> to reach the application.

<h3 id="___sec69">The compute part </h3>

<p>
    The computations in our application are put in a file <code>compute.py</code>
    and explained in detail in the section <a href="._web4sa_solarized008.html#wf:vib1:flask:app">Programming the Flask
    application</a>.
    We can equally well utilize the Bokeh library for plotting using
    the code shown in the section <a href="._web4sa_solarized015.html#wf:bokeh:flask">Plotting with the Bokeh
    library</a>.

<h3 id="___sec70">The model </h3>

<p>
    We can now write <code>models.py</code> and the <code>Input</code> class that defines
    the form fields for the four input variables:

<p>
    <!-- begin verbatim block  pypro-->
<pre><code>from django.db import models
from django.forms import ModelForm
from math import pi

class Input(models.Model):
    A = models.FloatField(
        verbose_name=' amplitude (m)', default=1.0)
    b = models.FloatField(
        verbose_name=' damping coefficient (kg/s)', default=0.0)
    w = models.FloatField(
        verbose_name=' frequency (1/s)', default=2*pi)
    T = models.FloatField(
        verbose_name=' time interval (s)', default=18)

class InputForm(ModelForm):
    class Meta:
        model = Input
</code></pre>
<!-- end verbatim block -->
Note here that we can provide a more explanatory name than just
the variable name, e.g., <code>' amplitude (m)'</code> for <code>A</code>. However,
Django will always capitalize these descriptions, so if one really
needs lower case names (e.g., to be compatible with a mathematical notation
or when just listing the unit),
one must start the text with a space, as we have demonstrated above.
We also provide a default
value such that all fields have a value when the user sees
the page.

<h3 id="___sec71">The view </h3>

<p>
    The <code>views.py</code> file looks as follows:

<p>
    <!-- begin verbatim block  pypro-->
<pre><code>from django.shortcuts import render_to_response
from django.template import RequestContext
from django.http import HttpResponse
from models import InputForm
from compute import compute
import os

def index(request):
    os.chdir(os.path.dirname(__file__))
    result = None
    if request.method == 'POST':
        form = InputForm(request.POST)
        if form.is_valid():
            form2 = form.save(commit=False)
            result = compute(form2.A, form2.b, form2.w, form2.T)
            result = result.replace('static/', '')
    else:
        form = InputForm()

    return render_to_response('vib1.html',
            {'form': form,
             'result': result,
             }, context_instance=RequestContext(request))
</code></pre>
<!-- end verbatim block -->
Some remarks are necessary:

<ol>
    <li> Doing an <code>os.chdir</code> to the current working directory is necessary
        as Django may be left back in another working directory if you have
        tested other apps.
    </li>
    <li> The <code>form2</code> object from <code>form.save</code> is the object we extract
        data from and send to <code>compute</code>, but the original <code>form</code>
        object is needed when making the HTML page through the template.
    </li>
    <li> Images, media files, style sheets, javascript files, etc. must
        reside in a subdirectory <code>static</code>. The specifications of the
        URL applies tools to find this <code>static</code> directory and then
        the <code>static</code> prefix in the <code>result</code> filename must be removed.
    </li>
</ol>

The template for rendering the page is listed next.

<p>
    <!-- begin verbatim block  htmlpro-->
<pre><code>&lt;form method=post action=&quot;&quot;&gt;{% csrf_token %}
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;
    &lt;td&gt;{{ field.name }}&lt;/td&gt;
    &lt;td&gt;{{ field }}&lt;/td&gt;
    &lt;td&gt;{{ field.label }}&lt;/td&gt;
    &lt;td&gt;{{ field.errors }}&lt;/td&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;/tr&gt;
  {% endfor %}
&lt;/table&gt;
&lt;p&gt;&lt;input type=submit value=Compute&gt;&lt;/form&gt;&lt;/p&gt;

&lt;p&gt;
{% if result != None %}
{% load static %}
&lt;img src=&quot;{% get_static_prefix %}{{ result }}&quot; width=500&gt;
{% endif %}
&lt;/p&gt;
</code></pre>
<!-- end verbatim block -->
The tricky part is the syntax for displaying <em>static content</em>, such as
the plot file made in the <code>compute</code> function.

<h2 id="___sec72">Custom validation </h2>

<p>
    Django has a series of methods available for user-provided validation
    of form data. These are exemplified in the app <code>vib2</code>, which
    is an extension of the <code>vib1</code> app with additional code. (This other
    app needs of course registrations in <code>settings.py</code> and <code>urls.py</code>, similar
    to what we did for the <code>vib1</code> app.)

<p>
    Making sure that \( A>0 \) is easiest done with a built-in Django
    validator for minimum value checking:

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>class Input(models.Model):
    A = models.FloatField(
        verbose_name=' amplitude (m)', default=1.0,
        validators=[MinValueValidator(0)])
</code></pre>
<!-- end verbatim block -->

<p>
    We can write our own validators, which are functions taking the value
    is the only argument and raising a <code>ValidationError</code> exception if the
    value is wrong. Checking that a value is inside an interval can first
    be implemented by

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>def check_interval(value, min_value=None, max_value=None):
    &quot;&quot;&quot;Validate that a value is inside an interval.&quot;&quot;&quot;
    failure = False
    if min_value is not None:
        if value &lt; min_value:
            failure = True
    if max_value is not None:
        if value &gt; max_value:
            failure = True
    if failure:
        raise ValidationError(
            'value=%s not in [%s, %s]' %
            (value,
             '-infty' if min_value is None else str(min_value),
             'infty' if max_value is None else str(max_value)))
</code></pre>
<!-- end verbatim block -->
However, this function takes more than the value as argument. We therefore
need to wrap it by a function with <code>value</code> as the only argument. The following
utility returns such a
function (see the section <a href="._web4sa_solarized014.html#wf:vib1:flask:validation">Custom validation</a> for more
explanation):

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>import functools

def interval(min_value=None, max_value=None):
    &quot;&quot;&quot;Django-compatible interface to check_interval.&quot;&quot;&quot;
    return functools.partial(
        check_interval, min_value=min_value, max_value=max_value)
</code></pre>
<!-- end verbatim block -->
Now, <code>interval(0, 1)</code> returns a function that takes <code>value</code> as its
only argument and checks if it is inside \( [0,1] \).
Such a function can be inserted in the <code>validators</code> list in
the field constructor, here to tell that \( b \) must be in \( [0,\infty) \):

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>class Input(models.Model):
    ...
    b = models.FloatField(
        verbose_name=' damping coefficient (kg/s)', default=0.0,
        validators=[interval(0,None)])
</code></pre>
<!-- end verbatim block -->

<p>
    A final example on custom validation is to avoid plotting more
    than 30 periods of the oscillating function \( u \). This translates
    to checking that \( T \) is geater
    than 30 periods, i.e., \( T>30\cdot 2\pi/w \). The task is done in
    the <code>InputForm</code> class, where any method <code>clean_name</code> can do
    validation and adjustment of the field name <code>name</code>. The code for
    a <code>clean_T</code> method goes as follows:

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>class InputForm(ModelForm):
    class Meta:
        model = Input

    def clean_T(self):
        T = self.cleaned_data['T']
        w = self.cleaned_data['w']
        period = 2*pi/w
        if T &gt; 30*period:
            num_periods = int(round(T/period))
            raise ValidationError(
                'Cannot plot as much as %d periods! T &lt; %.2f' %
                (num_periods, 30*period))
        return T
</code></pre>
<!-- end verbatim block -->
We refer to the vast Django documentation for many other ways of
validating forms. The reader is encouraged to run the <code>vib2</code>
application and test out the validations we have implemented.

<h2 id="___sec73">Customizing widgets </h2>

<p>
    One will occasionally have full control of the layout of the individual
    elements in a web form. These are typeset inside <code>input</code> tags in
    HTML. Django associates the term <em>widget</em> with an HTML form field. To set
    the size (width) of the field and other properties, one must in
    Django specify a <code>widgets</code> dictionary in the form class. The key
    is the name of the parameter in the model class, while the value
    is a widget class name. Standard input fields for numbers and
    text apply the <code>TextInput</code> widget. An example
    on setting the size of the <code>T</code> field to a width of 10 characters goes
    like

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>from django.forms import TextInput

class InputForm(ModelForm):
    class Meta:
        model = Input
        widgets = {
            'T': TextInput(attrs={'size': 10}),
        }
</code></pre>
<!-- end verbatim block -->

<p>
    At the time of this writing, Django does not yet support the many
    additional HTML5 input fields. Nevertheless, the <code>parampool</code> package
    gives access to HTML5 widgets in a Django context.
    We recommend to use <code>parampool</code> to automatically generate the necessary
    Django files, and
    then one can view the form class in the <code>models.py</code> file for how
    HTML5 widgets can be used in the definition of the <code>widgets</code>
    dictionary.

<p>
<p>
    <!-- begin bottom navigation -->
<table style="width: 100%">
    <tr>
        <td>
            <div style="text-align: left;"><a href="._web4sa_solarized018.html">&laquo; Previous</a></div>
        </td>
        <td>
            <div style="text-align: right;"><a href="._web4sa_solarized020.html">Next &raquo;</a></div>
        </td>
    </tr>
</table>
<!-- end bottom navigation -->
</p>

<!-- ------------------- end of main content --------------- -->


<center style="font-size:80%">
    <!-- copyright only on the titlepage -->
</center>


</body>
</html>
    

