<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/"/>
    <meta name="description" content="Using Web Frameworks for Scientific Applications">
    <meta name="keywords"
          content="web frameworks,MVC pattern,Flask installation,Flask input forms,Flask HTML templates,Flask MVC pattern,Flask troubleshooting,Django installation,Django making a project,Django making an application,Django input forms,Django HTML templates,Flask input forms,Flask error checking,Flask CSS style sheets,Flask LaTeX mathematics,Flask input validation,inline PNG image in HTML,base64 encoding of PNG images,inline SVG figure in HTML,mpld3 plotting,Flask Bokeh plotting,Bokeh plotting,highcharts,Flask login,Flask database,Flask uploading of files,Flask file upload,Django input forms,Django input validation">

    <title>Using Web Frameworks for Scientific Applications</title>


    <link href="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_solarized_box/css/solarized_light_code.css"
          rel="stylesheet" type="text/css" title="light"/>
    <script src="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_solarized_box/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <link href="http://thomasf.github.io/solarized-css/solarized-light.min.css" rel="stylesheet">
    <style type="text/css">
h1 {color: #b58900;}  /* yellow */
/* h1 {color: #cb4b16;}  orange */
/* h1 {color: #d33682;}  magenta, the original choice of thomasf */
code { padding: 0px; background-color: inherit; }
pre {
  border: 0pt solid #93a1a1;
  box-shadow: none;
}
.alert-text-small   { font-size: 80%;  }
.alert-text-large   { font-size: 130%; }
.alert-text-normal  { font-size: 90%;  }
.alert {
  padding:8px 35px 8px 14px; margin-bottom:18px;
  text-shadow:0 1px 0 rgba(255,255,255,0.5);
  border:1px solid #93a1a1;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  color: #555;
  background-color: #eee8d5;
  background-position: 10px 5px;
  background-repeat: no-repeat;
  background-size: 38px;
  padding-left: 55px;
  width: 75%;
 }
.alert-block {padding-top:14px; padding-bottom:14px}
.alert-block > p, .alert-block > ul {margin-bottom:1em}
.alert li {margin-top: 1em}
.alert-block p+p {margin-top:5px}
.alert-notice { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_notice.png); }
.alert-summary  { background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_summary.png); }
.alert-warning { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_warning.png); }
.alert-question {background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_yellow_question.png); }

div { text-align: justify; text-justify: inter-word; }

    </style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [('Web frameworks', 1, None, '___sec0'),
              ('Other frameworks', 3, None, '___sec1'),
              ('The MVC pattern', 2, None, '___sec2'),
              ('A very simple application', 2, None, '___sec3'),
              ('Application of the MVC pattern', 2, 'wf:hw:mvc', 'wf:hw:mvc'),
              ('Making a Flask application', 1, None, '___sec5'),
              ('Programming the Flask application', 2, None, '___sec6'),
              ('The user interaction', 3, None, '___sec7'),
              ('The Python code', 3, None, '___sec8'),
              ('Dissection', 3, None, '___sec9'),
              ('The template files', 3, None, '___sec10'),
              ('Testing the application', 3, None, '___sec11'),
              ('Equipping the input page with output results',
               2,
               None,
               '___sec12'),
              ('Splitting the app into model, view, and controller files',
               2,
               'wf:hw3:flask',
               'wf:hw3:flask'),
              ('Troubleshooting', 2, None, '___sec14'),
              ('Address already in use', 3, None, '___sec15'),
              ('Making a Django application', 1, None, '___sec16'),
              ('Setting up a Django project', 2, None, '___sec17'),
              ('Setting up a Django application', 2, None, '___sec18'),
              ('Programming the Django application', 2, None, '___sec19'),
              ('The user interaction', 3, None, '___sec20'),
              ('The model', 3, None, '___sec21'),
              ('The view', 3, None, '___sec22'),
              ('Making the input page', 3, None, '___sec23'),
              ('Making the results page', 3, None, '___sec24'),
              ('Equipping the input page with output results',
               2,
               None,
               '___sec25'),
              ('Handling multiple input variables in Flask',
               1,
               'wf:vib:flask',
               'wf:vib:flask'),
              ('Programming the Flask application',
               2,
               'wf:vib1:flask:app',
               'wf:vib1:flask:app'),
              ('The compute part', 3, None, '___sec28'),
              ('The model', 3, None, '___sec29'),
              ('The view', 3, None, '___sec30'),
              ('The HTML template', 3, None, '___sec31'),
              ('Implementing error checking in the template',
               2,
               None,
               '___sec32'),
              ('Using style sheets', 2, None, '___sec33'),
              ('Using LaTeX mathematics', 2, None, '___sec34'),
              ('Rearranging the elements in the HTML template',
               2,
               None,
               '___sec35'),
              ('Bootstrap HTML style', 2, None, '___sec36'),
              ('Custom validation',
               2,
               'wf:vib1:flask:validation',
               'wf:vib1:flask:validation'),
              ('Using Flask validators', 3, None, '___sec38'),
              ('Tailored validation', 3, None, '___sec39'),
              ('Tailored validation of intervals', 3, None, '___sec40'),
              ('Demo', 3, None, '___sec41'),
              ('Avoiding plot files',
               2,
               'wf:vib2:flask:nofiles',
               'wf:vib2:flask:nofiles'),
              ('PNG plots', 3, None, '___sec43'),
              ('SVG plots', 3, None, '___sec44'),
              ('Using mpld3', 3, None, '___sec45'),
              ('Plotting with the Bokeh library',
               2,
               'wf:bokeh:flask',
               'wf:bokeh:flask'),
              ('Pandas highcharts plotting library', 3, None, '___sec47'),
              ('Autogenerating the code',
               2,
               'wf:autogen:flask',
               'wf:autogen:flask'),
              ('Inspecting function signatures', 3, None, '___sec49'),
              ('Generating the model', 3, None, '___sec50'),
              ('Generating the view', 3, None, '___sec51'),
              ('Generating the template', 3, None, '___sec52'),
              ('Application', 3, None, '___sec53'),
              ('User login and storage of computed results',
               2,
               'wf:flask:login',
               'wf:flask:login'),
              ('Required additional software', 3, None, '___sec55'),
              ('The compute part', 3, None, '___sec56'),
              ('The interfaces of the app', 3, None, '___sec57'),
              ('The source code', 3, None, '___sec58'),
              ('Resources', 3, None, '___sec59'),
              ('Uploading of files', 2, 'wf:flask:upload', 'wf:flask:upload'),
              ('Overview of the application', 3, None, '___sec61'),
              ('The model class', 3, None, '___sec62'),
              ('The controller file', 3, None, '___sec63'),
              ('The compute function', 3, None, '___sec64'),
              ('The HTML template', 3, None, '___sec65'),
              ('Handling multiple input variables in Django',
               1,
               'wf:vib:django',
               'wf:vib:django'),
              ('Programming the Django application', 2, None, '___sec67'),
              ('Adding the app to a project', 3, None, '___sec68'),
              ('The compute part', 3, None, '___sec69'),
              ('The model', 3, None, '___sec70'),
              ('The view', 3, None, '___sec71'),
              ('Custom validation', 2, None, '___sec72'),
              ('Customizing widgets', 2, None, '___sec73'),
              ('Resources', 2, None, '___sec74'),
              ('Exercises', 1, None, '___sec75'),
              ('Exercise 1: Add two numbers',
               2,
               'wf:exer:add2',
               'wf:exer:add2'),
              ('Exercise 2: Upload data file and visualize curves',
               2,
               'wf:exer:upload',
               'wf:exer:upload'),
              ('Exercise 3: Plot a user-specified formula',
               2,
               'wf:exer:formula',
               'wf:exer:formula'),
              ('Exercise 4: Visualize Taylor polynomial approximations',
               2,
               'wf:exer:Taylor',
               'wf:exer:Taylor'),
              ('Exercise 5: Extend the `gen` app',
               2,
               'wf:exer:gen:demo',
               'wf:exer:gen:demo'),
              ('Exercise 6: Make a web app with multiple apps',
               2,
               'wf:exer:addmul',
               'wf:exer:addmul'),
              ('Exercise 7: Equip the `gen` app with more data types',
               2,
               'wf:exer:gen:lists',
               'wf:exer:gen:lists'),
              ('Exercise 8: Auto-generate code from function signature',
               2,
               None,
               '___sec83'),
              ('Project 9: Interactive function exploration',
               2,
               'wf:exer:bokeh_UI',
               'wf:exer:bokeh_UI'),
              ('Resources', 1, None, '___sec85'),
              ('Flask resources', 2, None, '___sec86'),
              ('Django resources', 2, None, '___sec87')]}
end of tocinfo -->

<body>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});

</script>
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<a name="part0014"></a>
<p>
    <!-- begin top navigation -->
<table style="width: 100%">
    <tr>
        <td>
            <div style="text-align: left;"><a href="._web4sa_solarized013.html">&laquo; Previous</a></div>
        </td>
        <td>
            <div style="text-align: right;"><a href="._web4sa_solarized015.html">Next &raquo;</a></div>
        </td>
    </tr>
</table>
<!-- end top navigation -->
</p>

<p>
    <!-- !split -->

<h2 id="wf:vib1:flask:validation">Custom validation</h2>

<p>
    The <code>FloatField</code> objects can check that the input is compatible with
    a number, but what if we want to control that \( A>0 \), \( b>0 \), and
    \( T \) is not greater than 30 periods (otherwise the plot gets cluttered)?
    We can write functions for checking appropriate conditions and
    supply the function to the list of validator functions in the call to
    the <code>FloatField</code> constructor or other field constructors. The extra
    code is a part of the <code>model.py</code> and the presented extensions appear
    in the directory <a
        href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib2"
        target="_self"><tt>vib2</tt></a>.

<h3 id="___sec38">Using Flask validators </h3>

<p>
    The simplest approach to validation is to use existing functionality
    in the web framework. Checking that \( A>0 \) can be done by
    the <code>NumberRange</code> validator which checks that the value is inside
    a prescribed interval:

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>from wtforms import Form, FloatField, validators

class InputForm(Form):
    A = FloatField(
        label='amplitude (m)', default=1.0,
        validators=[validators.NumberRange(0, 1E+20)])
</code></pre>
<!-- end verbatim block -->

<h3 id="___sec39">Tailored validation </h3>

<p>
    We can also easily provide our own more tailored validators.
    As an example, let us explain how we can check that \( T \) is less than 30 periods.
    One period is \( 2\pi /w \) so we need to check if \( T> 30\cdot 2\pi/w \)
    and raise an exception in that case.
    A validation function takes two arguments: the whole <code>form</code> and the
    specific <code>field</code> to test:

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>def check_T(form, field):
    &quot;&quot;&quot;Form validation: failure if T &gt; 30 periods.&quot;&quot;&quot;
    w = form.w.data
    T = field.data
    period = 2*pi/w
    if T &gt; 30*period:
        num_periods = int(round(T/period))
        raise validators.ValidationError(
            'Cannot plot as much as %d periods! T&lt;%.2f' %
            (num_periods, 30*period))
</code></pre>
<!-- end verbatim block -->
The appropriate exception is of type <code>validators.ValidationError</code>.
Observe that through <code>form</code> we have in fact access to all the input
data so we can easily use the value of \( w \) when checking the validity
of the value of \( T \). The <code>check_T</code> function is easy to
add to the list of validator functions in the call to the <code>FloatField</code>
constructor for <code>T</code>:

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>class InputForm(Form):
    ...
    T = FloatField(
        label='time interval', default=6*pi,
        validators=[validators.InputRequired(), check_T])
</code></pre>
<!-- end verbatim block -->
The validator
objects are tested one by one as they appear in the list, and if
one fails, the others are not invoked.
We therefore add <code>check_T</code> after the check of input such that we know we
have a value for all data when we run the computations and test
in <code>check_T</code>.

<h3 id="___sec40">Tailored validation of intervals </h3>

<p>
    Although there is already a <code>NumberRange</code> validator for checking
    whether a value is inside an interval, we can write our own
    version with some improved functionality for open intervals where
    the maximum or minimum value can be infinite.
    The infinite value can on input be represented by <code>None</code>.
    A general such function may take the form

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>def check_interval(form, field, min_value=None, max_value=None):
    &quot;&quot;&quot;For validation: failure if value is outside an interval.&quot;&quot;&quot;
    failure = False
    if min_value is not None:
        if field.data &lt; min_value:
            failure = True
    if max_value is not None:
        if field.data &gt; max_value:
            failure = True
    if failure:
        raise validators.ValidationError(
            '%s=%s not in [%s, %s]' %
            (field.name, field.data,
             '-infty' if min_value is None else str(min_value),
             'infty'  if max_value is None else str(max_value)))
</code></pre>
<!-- end verbatim block -->

<p>
    The problem is that <code>check_interval</code> takes four arguments, not only
    the <code>form</code> and <code>field</code> arguments that a validator function in the
    Flask framework can accept.
    The way out of this difficulty is to use a Python tool <code>functools.partial</code>
    which allows us to call a function with some of the arguments set beforehand.
    Here, we want to create a new function that calls <code>check_interval</code>
    with some prescribed values of <code>min_value</code> and <code>max_value</code>.
    This function looks like it does not have these arguments, only
    <code>form</code> and <code>field</code>. The following function produces this function, which we
    can use as a valid Flask validator function:

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>import functools

def interval(min_value=None, max_value=None):
    return functools.partial(
        check_interval, min_value=min_value, max_value=max_value)
</code></pre>
<!-- end verbatim block -->
We can now in any field constructor just add
<code>interval(a, b)</code> as a validator function, here checking that \( b\in [0,\infty) \):

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>class InputForm(Form):
    ...
    b = FloatField(
        label='damping factor (kg/s)', default=0,
        validators=[validators.InputRequired(), interval(0,None)])
</code></pre>
<!-- end verbatim block -->

<h3 id="___sec41">Demo </h3>

<p>
    Let us test our tailored error checking. Run <code>python controller.py</code>
    in the <code>vib2</code> directory and fill in \( -1.0 \) in the \( b \) field.
    Pressing <em>Compute</em> invokes our <code>interval(0,None)</code> function, which
    is nothing but a call to <code>check_interval</code> with the
    arguments <code>field</code>, <code>form</code>, <code>0</code>, and <code>None</code>.
    Inside this function,
    the test <code>if field.data &lt; min_value</code> becomes true, <code>failure</code>
    is set, and the exception is raised. The message in the exception
    is available in the <code>field.errors</code> attribute so our template
    will write it out in red, see Figure <a href="#wf:vib2:flask:fig:error1">12</a>.
    The template used in <code>vib2</code> is basically the same as <code>view_tex.html</code>
    in <code>vib1</code>, i.e., it feaures LaTeX mathematics and checking of
    <code>field.errors</code>.

<p>
    <center> <!-- figure -->
        <hr class="figure">
        <center>
<p class="caption">Figure 12: Triggering of a user-defined error check.
<div id="wf:vib2:flask:fig:error1"></div>
</p></center>
<p><img src="fig-web4sa/vib2_flask_error1.png" align="bottom" width=500></p>
</center>

<p>
    Finally, we mention a detail in the <code>controller.py</code> file in the <code>vib2</code>
    app: instead of sending <code>form.var.data</code> to the <code>compute</code> function we
    may automatically generate a set of local variables such that the
    application of data from the web page, here in the <code>compute</code> call, looks nicer:

<p>
    <!-- begin verbatim block  pycod-->
<pre><code>def index():
    form = InputForm(request.form)
    if request.method == 'POST' and form.validate():
        for field in form:
            # Make local variable (name field.name)
            exec('%s = %s' % (field.name, field.data))
        result = compute(A, b, w, T)
    else:
        result = None

    return render_template(template, form=form, result=result)

if __name__ == '__main__':
    app.run(debug=True)
</code></pre>
<!-- end verbatim block -->
The idea is just to run <code>exec</code> on a declaration of a local variable
with name <code>field.name</code> for each field in the form. This trick is often
neat if web variables are buried in objects (<code>form.T.data</code>) and you want these
variables in your
code to look like they do in mathematical writing (<code>T</code> for \( T \)).

<p>
<p>
    <!-- begin bottom navigation -->
<table style="width: 100%">
    <tr>
        <td>
            <div style="text-align: left;"><a href="._web4sa_solarized013.html">&laquo; Previous</a></div>
        </td>
        <td>
            <div style="text-align: right;"><a href="._web4sa_solarized015.html">Next &raquo;</a></div>
        </td>
    </tr>
</table>
<!-- end bottom navigation -->
</p>

<!-- ------------------- end of main content --------------- -->


<center style="font-size:80%">
    <!-- copyright only on the titlepage -->
</center>


</body>
</html>
    

